<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projects | PM-AJAY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar { background-color: #ffffff; }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.2s ease-in-out;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1); }
        .dark .sidebar, .dark .card { background-color: #1c1b1a; }
        .dark .card { border: 1px solid #374151; box-shadow: none; }
        .dark .card:hover { background-color: #2c2b2a; }
        .modal-root { transition: opacity 0.3s ease; }
        .modal-container { transition: transform 0.3s ease, opacity 0.3s ease; }
        .project-card, .project-row { cursor: pointer; }
    </style>
</head>
<body class="flex min-h-screen bg-[#fdfaf6] dark:bg-black">
    <aside class="sidebar w-64 flex-shrink-0 border-r border-slate-200 dark:border-gray-700 flex flex-col">
        <div class="p-6">
             <h1 class="text-2xl font-bold text-slate-800 dark:text-gray-100 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-2 text-indigo-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.874 6 7.5 6h5c.626 0 .988-.27 1.256-.579A6.012 6.012 0 0115.668 8.027c.21.34.332.732.332 1.155a3.999 3.999 0 01-4 4c-1.933 0-3.5-1.567-3.5-3.5a3.999 3.999 0 011.006-2.622c.23-.352.484-.65.744-.897C10.5 6.27 10.246 6 10 6h-.5a.5.5 0 00-.5.5v1.5a.5.5 0 00.5.5h.5a.5.5 0 00.5-.5v-1a.5.5 0 00-.5-.5h-2a.5.5 0 00-.5.5v1a.5.5 0 00.5.5h.5a.5.5 0 00.5-.5V8.5a.5.5 0 00-.5-.5h-2a.5.5 0 00-.5.5v1.5a.5.5 0 00.5.5H8a.5.5 0 00.5-.5V9.5a3.5 3.5 0 00-3.5-3.5c-.538 0-1.03.123-1.468.342z" clip-rule="evenodd" /></svg>
                PM-AJAY
            </h1>
        </div>
        <nav class="flex-1 px-4 py-2">
            <a href="central.html" class="flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>Dashboard</a>
            <a href="reports.html" class="flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium"><i data-lucide="bar-chart-3" class="w-5 h-5 mr-3"></i>Reports</a>
            <a href="projects-alert.html" class="flex items-center px-4 py-2.5 text-slate-700 bg-indigo-50 dark:bg-gray-700 dark:text-gray-100 rounded-lg font-semibold"><i data-lucide="bell" class="w-5 h-5 mr-3 text-indigo-600 dark:text-indigo-400"></i>Alerts</a>
            <a href="beneficiaries.html" class="flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium"><i data-lucide="users" class="w-5 h-5 mr-3"></i>Beneficiaries</a>
            <a href="#" class="flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium"><i data-lucide="settings" class="w-5 h-5 mr-3"></i>Settings</a>
        </nav>
    </aside>

    <main class="flex-1 p-6 lg:p-8 overflow-y-auto">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-slate-800 dark:text-gray-100">Projects Overview</h2>
                <p class="text-slate-500 dark:text-gray-400 mt-1">Browse, filter, and manage all ongoing and completed projects.</p>
            </div>
            <div class="flex items-center mt-4 sm:mt-0">
                 <button id="new-project-btn" class="bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-700 flex items-center"><i data-lucide="plus" class="w-5 h-5 mr-2"></i>New Project</button>
                 <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700 ml-4">
                    <i data-lucide="sun" id="theme-toggle-light-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400"></i>
                    <i data-lucide="moon" id="theme-toggle-dark-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400 hidden"></i>
                </button>
            </div>
        </div>

        <div class="card p-4 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="relative w-full md:w-1/3">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                    <input id="search-input" type="text" placeholder="Search by name or agency..." class="w-full pl-10 pr-4 py-2 border border-slate-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <select id="status-filter" class="border border-slate-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="all">All Statuses</option></select>
                    <select id="state-filter" class="border border-slate-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"><option value="all">All States</option></select>
                    <div class="bg-slate-100 dark:bg-gray-800 p-1 rounded-lg flex items-center">
                        <button id="grid-view-btn" class="p-2 rounded-md bg-white dark:bg-gray-700 text-indigo-600 dark:text-indigo-400"><i data-lucide="layout-grid" class="w-5 h-5"></i></button>
                        <button id="list-view-btn" class="p-2 rounded-md text-slate-500 dark:text-gray-400"><i data-lucide="list" class="w-5 h-5"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="grid-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        <div id="list-view" class="card hidden overflow-x-auto"></div>
        
    </main>
    
    <div id="project-detail-modal" class="modal-root fixed inset-0 z-50 flex items-center justify-center hidden opacity-0"><div class="modal-overlay absolute inset-0 bg-black/50"></div><div class="modal-container relative bg-white dark:bg-[#1c1b1a] rounded-lg shadow-xl w-full max-w-4xl m-4 transform scale-95 opacity-0" style="max-height: 90vh;"><div class="flex items-start justify-between p-4 border-b dark:border-gray-700 sticky top-0 bg-white dark:bg-[#1c1b1a] z-10"><div class="flex-1"><h3 id="modal-project-name" class="text-xl font-semibold text-slate-800 dark:text-gray-100"></h3><p id="modal-project-state" class="text-sm text-slate-500 dark:text-gray-400"></p></div><button class="close-modal-btn text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white ml-4"><i data-lucide="x" class="w-6 h-6"></i></button></div><div id="modal-content-area" class="p-6 overflow-y-auto" style="max-height: calc(90vh - 65px);"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 space-y-6"><div><h4 class="font-semibold text-slate-800 dark:text-gray-100 mb-2">Project Description</h4><p id="modal-project-description" class="text-slate-600 dark:text-gray-400 text-sm"></p></div><div><h4 class="font-semibold text-slate-800 dark:text-gray-100 mb-2">Image Gallery</h4><div id="modal-project-gallery" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div></div></div><div class="space-y-6"><div class="card p-4"><h4 class="font-semibold text-slate-800 dark:text-gray-100 mb-3">Project Details</h4><div class="space-y-3 text-sm"><div class="flex justify-between">
<span class="text-slate-500 dark:text-gray-400">Status:</span><span id="modal-project-status"></span></div><div class="flex justify-between"><span class="text-slate-500 dark:text-gray-400">Budget:</span><span id="modal-project-budget" class="font-semibold text-slate-700 dark:text-gray-200"></span></div><div class="flex justify-between"><span class="text-slate-500 dark:text-gray-400">Agency:</span><span id="modal-project-agency" class="font-semibold text-slate-700 dark:text-gray-200"></span></div><div class="flex justify-between"><span class="text-slate-500 dark:text-gray-400">Start Date:</span><span id="modal-project-start" class="font-semibold text-slate-700 dark:text-gray-200"></span></div><div class="flex justify-between"><span class="text-slate-500 dark:text-gray-400">End Date:</span><span id="modal-project-end" class="font-semibold text-slate-700 dark:text-gray-200"></span></div></div></div><div class="card p-4"><h4 class="font-semibold text-slate-800 dark:text-gray-100 mb-2">Progress</h4><div class="w-full bg-slate-200 dark:bg-gray-700 rounded-full h-2.5"><div id="modal-project-progress-bar" class="bg-indigo-600 h-2.5 rounded-full"></div></div><p id="modal-project-progress-text" class="text-center text-sm font-semibold mt-2 text-indigo-600 dark:text-indigo-400"></p></div></div></div><div class="mt-6 pt-6 border-t dark:border-gray-700"><div class="flex justify-between items-center mb-4"><h4 class="font-semibold text-slate-800 dark:text-gray-100">Project Alerts</h4><button id="create-alert-btn" class="bg-red-600 text-white text-xs font-semibold py-1 px-3 rounded-lg hover:bg-red-700 flex items-center"><i data-lucide="plus-circle" class="w-4 h-4 mr-1"></i>Create Alert</button></div><div id="modal-project-alerts" class="space-y-3"></div></div></div></div></div>

    <div id="new-project-modal" class="modal-root fixed inset-0 z-50 flex items-center justify-center hidden opacity-0"><div class="modal-overlay absolute inset-0 bg-black/50"></div><div class="modal-container relative bg-white dark:bg-[#1c1b1a] rounded-lg shadow-xl w-full max-w-2xl m-4 transform scale-95 opacity-0"><div class="flex items-center justify-between p-4 border-b dark:border-gray-700"><h3 class="text-xl font-semibold text-slate-800 dark:text-gray-100">Create New Project</h3><button class="close-modal-btn text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button></div><form id="new-project-form"><div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto"><div><label for="project-name" class="block text-sm font-medium text-slate-700 dark:text-gray-300">Project Name</label><input id="project-name" type="text" required class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., Skill Development Center, Rampur"></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="project-type" class="block text-sm font-medium text-slate-700 dark:text-gray-300">Project Type</label><select id="project-type" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"></select></div><div><label for="project-state" class="block text-sm font-medium text-slate-700 dark:text-gray-300">State</label><select id="project-state" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"></select></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="project-agency" class="block text-sm font-medium text-slate-700 dark:text-gray-300">Executing Agency</label><select id="project-agency" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"></select></div><div><label for="project-budget" class="block text-sm font-medium text-slate-700 dark:text-gray-300">Budget (in Lakhs)</label><input id="project-budget" type="number" step="0.01" required class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., 150.50"></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="project-start-date" class="block text-sm font-medium text-slate-700 dark:text-gray-300">Start Date</label><input id="project-start-date" type="date" required class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"></div><div><label for="project-end-date" class="block text-sm font-medium text-slate-700 dark:text-gray-300">End Date</label><input id="project-end-date" type="date" required class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"></div></div><div><label for="project-description" class="block text-sm font-medium text-slate-700 dark:text-gray-300">Description</label><textarea id="project-description" rows="3" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea></div></div><div class="flex items-center justify-end p-4 space-x-2 border-t dark:border-gray-700"><button type="button" class="close-modal-btn bg-slate-200 dark:bg-gray-600 text-slate-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-gray-500">Cancel</button><button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Create Project</button></div></form></div></div>

    <div id="create-alert-modal" class="modal-root fixed inset-0 z-[60] flex items-center justify-center hidden opacity-0"><div class="modal-overlay absolute inset-0 bg-black/50"></div><div class="modal-container relative bg-white dark:bg-[#1c1b1a] rounded-lg shadow-xl w-full max-w-lg m-4 transform scale-95 opacity-0"><div class="flex items-center justify-between p-4 border-b dark:border-gray-700"><h3 class="text-xl font-semibold text-slate-800 dark:text-gray-100">Create New Alert</h3><button class="close-modal-btn text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button></div><form id="create-alert-form"><div class="p-6 space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="alert-type" class="block text-sm font-medium text-slate-700 dark:text-gray-300">Alert Type</label><select id="alert-type" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"><option>Budget</option><option>Deadline</option><option>Compliance</option><option>Resource</option><option>Other</option></select></div><div><label for="alert-severity" class="block text-sm font-medium text-slate-700 dark:text-gray-300">Severity</label><select id="alert-severity" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"><option>Low</option><option>Medium</option><option>High</option></select></div></div><div><label for="alert-message" class="block text-sm font-medium text-slate-700 dark:text-gray-300">Message</label><textarea id="alert-message" rows="3" required class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-600 rounded-lg dark:bg-gray-800 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Describe the alert..."></textarea></div></div><div class="flex items-center justify-end p-4 space-x-2 border-t dark:border-gray-700"><button type="button" class="close-modal-btn bg-slate-200 dark:bg-gray-600 text-slate-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-gray-500">Cancel</button><button type="submit" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">Add Alert</button></div></form></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const appState = {
            isDark: false,
            projects: [],
            filters: { status: 'all', state: 'all', search: '' },
            view: 'grid',
            currentProjectIdForAlert: null
        };

        // --- MOCK DATA ---
        function generateMockData() {
            const projectTypes = ["Hostel Construction", "Skill Development Center", "Adarsh Gram Infra", "Community Hall", "Residential School"];
            const agencies = ["State PWD", "Zila Parishad", "Block Panchayat", "Pratham NGO", "State Education Dept."];
            const statuses = ["Completed", "In Progress", "Delayed", "Initiated"];
            const states = ["Uttar Pradesh", "Maharashtra", "Bihar", "West Bengal", "Madhya Pradesh", "Tamil Nadu", "Rajasthan", "Karnataka", "Gujarat", "Andhra Pradesh"];
            const data = [];
            for (let i = 0; i < 30; i++) {
                const status = statuses[i % statuses.length];
                const startDate = new Date(Date.now() - Math.floor(Math.random() * 730) * 24 * 36e5);
                const endDate = new Date(startDate.getTime() + Math.floor(Math.random() * 365 + 180) * 24 * 36e5);
                let progress = 0;
                if (status === 'Completed') progress = 100;
                else if (status === 'In Progress' || status === 'Delayed') progress = Math.floor(Math.random() * 80) + 10;
                else if (status === 'Initiated') progress = Math.floor(Math.random() * 10);
                
                const project = {
                    id: i + 1,
                    name: `${projectTypes[i%projectTypes.length]}, ${['Rampur', 'Mohanpur', 'Sitapur', 'Gopalganj', 'Birbhum'][i%5]}`,
                    state: states[i % states.length],
                    type: projectTypes[i % projectTypes.length],
                    status: status,
                    budget: (Math.random() * 400 + 50).toFixed(2), // in Lakhs
                    startDate: startDate,
                    endDate: endDate,
                    agency: agencies[i % agencies.length],
                    progress: progress,
                    description: "This project focuses on developing critical infrastructure for the local community, aiming to improve living standards and provide essential services. Key objectives include timely completion, budget adherence, and ensuring high-quality construction standards for long-term sustainability.",
                    gallery: [ `https://placehold.co/600x400/E2E8F0/475569?text=Site+Photo+1`, `https://placehold.co/600x400/E2E8F0/475569?text=Site+Photo+2`, `https://placehold.co/600x400/E2E8F0/475569?text=Blueprint`],
                    alerts: []
                };

                // Add some mock alerts
                if (project.status === 'Delayed') {
                    project.alerts.push({ id: Date.now() + Math.random(), type: 'Deadline', severity: 'High', message: 'Project is significantly behind schedule.', status: 'Open', timestamp: new Date() });
                }
                const daysUntilEnd = (endDate - Date.now()) / (24 * 36e5);
                if (daysUntilEnd > 0 && daysUntilEnd < 30) {
                     project.alerts.push({ id: Date.now() + Math.random(), type: 'Deadline', severity: 'Medium', message: `Approaching deadline. Only ${Math.floor(daysUntilEnd)} days left.`, status: 'Open', timestamp: new Date() });
                }
                if (i % 5 === 0 && project.status !== 'Completed') {
                     project.alerts.push({ id: Date.now() + Math.random(), type: 'Budget', severity: 'Low', message: 'Monthly expense report is pending submission.', status: 'Open', timestamp: new Date() });
                }
                if (i % 9 === 0 && project.alerts.length > 0) {
                     project.alerts[0].status = 'Resolved'; // Mark some as resolved
                }
                data.push(project);
            }
            appState.projects = data.sort((a,b) => b.id - a.id);
        }

        // --- RENDER & FILTER ---
        function renderProjects() {
            const { status, state, search } = appState.filters;
            const filteredProjects = appState.projects.filter(p => 
                (status === 'all' || p.status === status) &&
                (state === 'all' || p.state === state) &&
                (search === '' || p.name.toLowerCase().includes(search.toLowerCase()) || p.agency.toLowerCase().includes(search.toLowerCase()))
            );
            if (appState.view === 'grid') { renderGridView(filteredProjects); } else { renderListView(filteredProjects); }
            lucide.createIcons();
        }
        
        function getStatusConfig(status) {
            return {
                'Completed': { bg: 'bg-green-100 dark:bg-green-500/10', text: 'text-green-800 dark:text-green-300', border: 'border-green-500' },
                'In Progress': { bg: 'bg-blue-100 dark:bg-blue-500/10', text: 'text-blue-800 dark:text-blue-300', border: 'border-blue-500' },
                'Delayed': { bg: 'bg-red-100 dark:bg-red-500/10', text: 'text-red-800 dark:text-red-300', border: 'border-red-500' },
                'Initiated': { bg: 'bg-yellow-100 dark:bg-yellow-500/10', text: 'text-yellow-800 dark:text-yellow-300', border: 'border-yellow-500' }
            }[status];
        }

        function renderGridView(projects) {
            const gridContainer = document.getElementById('grid-view');
            gridContainer.innerHTML = '';
            if (projects.length === 0) { gridContainer.innerHTML = `<p class="col-span-full text-center py-8 text-slate-500 dark:text-gray-400">No projects found.</p>`; return; }
            projects.forEach(p => {
                const config = getStatusConfig(p.status);
                const hasOpenAlerts = p.alerts.some(a => a.status === 'Open');
                const card = document.createElement('div');
                card.className = `project-card card p-5 flex flex-col border-t-4 ${config.border}`;
                card.dataset.projectId = p.id;
                card.innerHTML = `<div class="flex justify-between items-start mb-3"><h3 class="font-bold text-lg text-slate-800 dark:text-gray-100 pr-4">${p.name}</h3><div class="flex items-center gap-2">${hasOpenAlerts ? '<i data-lucide="bell-ring" class="w-5 h-5 text-red-500"></i>' : ''}<span class="px-2 py-1 text-xs font-semibold rounded-full whitespace-nowrap ${config.bg} ${config.text}">${p.status}</span></div></div><p class="text-sm text-slate-500 dark:text-gray-400 mb-4">${p.state}</p><div class="mt-auto"><div class="flex justify-between items-center text-sm mb-1"><span class="text-slate-500 dark:text-gray-400">Progress</span><span class="font-semibold text-slate-700 dark:text-gray-200">${p.progress}%</span></div><div class="w-full bg-slate-200 dark:bg-gray-700 rounded-full h-2"><div class="bg-indigo-600 h-2 rounded-full" style="width: ${p.progress}%"></div></div><div class="flex justify-between items-center mt-4 text-sm"><span class="font-semibold text-slate-800 dark:text-gray-100">₹${p.budget} L</span><span class="text-slate-500 dark:text-gray-400">${p.agency}</span></div></div>`;
                gridContainer.appendChild(card);
            });
        }
        
        function renderListView(projects) {
            const listContainer = document.getElementById('list-view');
            let tableHTML = `<table class="w-full text-left text-sm"><thead class="text-xs text-slate-500 dark:text-gray-400 uppercase bg-slate-50 dark:bg-gray-800"><tr><th class="px-6 py-3">Project Name</th><th class="px-6 py-3">State</th><th class="px-6 py-3">Progress</th><th class="px-6 py-3">Status</th></tr></thead><tbody>`;
            if (projects.length === 0) {
                tableHTML += `<tr><td colspan="4" class="text-center py-8 text-slate-500 dark:text-gray-400">No projects found.</td></tr>`;
            } else {
                 projects.forEach(p => {
                    const config = getStatusConfig(p.status);
                    const hasOpenAlerts = p.alerts.some(a => a.status === 'Open');
                    tableHTML += `<tr class="project-row bg-white dark:bg-[#1c1b1a] border-b dark:border-gray-700" data-project-id="${p.id}"><td class="px-6 py-4 font-medium text-slate-900 dark:text-gray-100 flex items-center gap-2">${p.name} ${hasOpenAlerts ? '<i data-lucide="bell-ring" class="w-4 h-4 text-red-500"></i>' : ''}</td><td class="px-6 py-4 text-slate-600 dark:text-gray-300">${p.state}</td><td class="px-6 py-4 text-slate-600 dark:text-gray-300">${p.progress}%</td><td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${config.bg} ${config.text}">${p.status}</span></td></tr>`;
                 });
            }
            tableHTML += `</tbody></table>`;
            listContainer.innerHTML = tableHTML;
        }

        function populateFiltersAndForms() {
            const statusFilter = document.getElementById('status-filter');
            const stateFilter = document.getElementById('state-filter');
            const projectTypeSelect = document.getElementById('project-type');
            const projectStateSelect = document.getElementById('project-state');
            const projectAgencySelect = document.getElementById('project-agency');

            const statuses = [...new Set(appState.projects.map(p => p.status))];
            const states = [...new Set(appState.projects.map(p => p.state))].sort();
            const types = [...new Set(appState.projects.map(p => p.type))].sort();
            const agencies = [...new Set(appState.projects.map(p => p.agency))].sort();

            const populateSelect = (selectEl, options) => {
                while (selectEl.options.length > 1) { selectEl.remove(1); }
                options.forEach(opt => selectEl.add(new Option(opt, opt)));
            };

            populateSelect(statusFilter, statuses);
            populateSelect(stateFilter, states);
            populateSelect(projectTypeSelect, types);
            populateSelect(projectStateSelect, states);
            populateSelect(projectAgencySelect, agencies);
        }
        
        function handleProjectClick(projectId) {
            const project = appState.projects.find(p => p.id === parseInt(projectId));
            if (!project) return;
            appState.currentProjectIdForAlert = project.id; // Store current project ID
            const modal = document.getElementById('project-detail-modal');
            const config = getStatusConfig(project.status);
            
            modal.querySelector('#modal-project-name').textContent = project.name;
            modal.querySelector('#modal-project-state').textContent = project.state;
            modal.querySelector('#modal-project-description').textContent = project.description;
            modal.querySelector('#modal-project-budget').textContent = `₹${project.budget} Lakhs`;
            modal.querySelector('#modal-project-agency').textContent = project.agency;
            modal.querySelector('#modal-project-start').textContent = project.startDate.toLocaleDateString();
            modal.querySelector('#modal-project-end').textContent = project.endDate.toLocaleDateString();
            const statusEl = modal.querySelector('#modal-project-status');
            statusEl.textContent = project.status;
            statusEl.className = `px-2 py-1 text-xs font-semibold rounded-full ${config.bg} ${config.text}`;
            
            modal.querySelector('#modal-project-progress-bar').style.width = `${project.progress}%`;
            modal.querySelector('#modal-project-progress-text').textContent = `${project.progress}% Complete`;
            
            const gallery = modal.querySelector('#modal-project-gallery');
            gallery.innerHTML = '';
            project.gallery.forEach(url => { gallery.innerHTML += `<img src="${url}" class="rounded-lg object-cover w-full h-32">` });
            
            renderAlertsForProject(project.id);
            openModal(modal);
        }

        // --- ALERT SYSTEM FUNCTIONS ---
        function renderAlertsForProject(projectId) {
            const project = appState.projects.find(p => p.id === projectId);
            const alertsContainer = document.getElementById('modal-project-alerts');
            if (!project || !alertsContainer) return;
            
            alertsContainer.innerHTML = '';
            if (project.alerts.length === 0) {
                alertsContainer.innerHTML = '<p class="text-sm text-slate-500 dark:text-gray-400">No alerts for this project.</p>';
                return;
            }

            const severityConfig = {
                'High': { bg: 'bg-red-100 dark:bg-red-500/10', text: 'text-red-800 dark:text-red-300' },
                'Medium': { bg: 'bg-yellow-100 dark:bg-yellow-500/10', text: 'text-yellow-800 dark:text-yellow-300' },
                'Low': { bg: 'bg-blue-100 dark:bg-blue-500/10', text: 'text-blue-800 dark:text-blue-300' }
            };

            project.alerts.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(alert => {
                const config = severityConfig[alert.severity];
                const alertEl = document.createElement('div');
                alertEl.className = `p-3 rounded-lg flex items-start justify-between gap-4 ${config.bg}`;
                alertEl.innerHTML = `
                    <div>
                        <p class="font-semibold ${config.text}">${alert.severity}: ${alert.type}</p>
                        <p class="text-sm text-slate-600 dark:text-gray-400">${alert.message}</p>
                        <p class="text-xs text-slate-400 dark:text-gray-500 mt-1">${new Date(alert.timestamp).toLocaleString()}</p>
                    </div>
                    ${alert.status === 'Open' ? 
                        `<button data-alert-id="${alert.id}" class="resolve-alert-btn bg-white dark:bg-gray-700 text-xs font-semibold py-1 px-3 rounded-lg border dark:border-gray-600 hover:bg-slate-50 dark:hover:bg-gray-600 whitespace-nowrap">Resolve</button>` : 
                        `<span class="text-xs font-semibold text-green-600 dark:text-green-400">Resolved</span>`
                    }
                `;
                alertsContainer.appendChild(alertEl);
            });
        }

        function handleResolveAlert(e) {
            if (!e.target.matches('.resolve-alert-btn')) return;
            const alertId = parseFloat(e.target.dataset.alertId);
            const project = appState.projects.find(p => p.id === appState.currentProjectIdForAlert);
            if (!project) return;
            
            const alert = project.alerts.find(a => a.id === alertId);
            if (alert) {
                alert.status = 'Resolved';
                renderAlertsForProject(project.id); // Re-render alerts in modal
                renderProjects(); // Re-render main project view to update bell icon
            }
        }

        function handleCreateAlertSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const project = appState.projects.find(p => p.id === appState.currentProjectIdForAlert);
            if (!project) return;
            
            const newAlert = {
                id: Date.now(),
                type: form.querySelector('#alert-type').value,
                severity: form.querySelector('#alert-severity').value,
                message: form.querySelector('#alert-message').value.trim(),
                status: 'Open',
                timestamp: new Date()
            };
            project.alerts.push(newAlert);
            renderAlertsForProject(project.id);
            renderProjects();
            closeModal(document.getElementById('create-alert-modal'));
            form.reset();
        }


        function handleCreateProject(event) {
            event.preventDefault();
            const form = event.target;
            const newProject = {
                id: Math.max(...appState.projects.map(p => p.id)) + 1,
                name: form.querySelector('#project-name').value.trim(),
                state: form.querySelector('#project-state').value,
                type: form.querySelector('#project-type').value,
                status: 'Initiated',
                budget: parseFloat(form.querySelector('#project-budget').value).toFixed(2),
                startDate: new Date(form.querySelector('#project-start-date').value),
                endDate: new Date(form.querySelector('#project-end-date').value),
                agency: form.querySelector('#project-agency').value,
                progress: Math.floor(Math.random() * 5),
                description: form.querySelector('#project-description').value,
                gallery: [`https://placehold.co/600x400/E2E8F0/475569?text=Site+Photo+1`],
                alerts: []
            };
            appState.projects.unshift(newProject);
            form.reset();
            closeModal(document.getElementById('new-project-modal'));
            renderProjects();
        }

        // --- MODAL & THEME MANAGEMENT ---
        const openModal = (modalEl) => { modalEl.classList.remove('hidden'); setTimeout(() => { modalEl.classList.remove('opacity-0'); modalEl.querySelector('.modal-container').classList.remove('scale-95', 'opacity-0'); }, 10); };
        const closeModal = (modalEl) => { modalEl.classList.add('opacity-0'); modalEl.querySelector('.modal-container').classList.add('scale-95', 'opacity-0'); setTimeout(() => { modalEl.classList.add('hidden'); }, 300); };
        const setTheme = (isDark) => {
            appState.isDark = isDark;
            document.documentElement.classList.toggle('dark', isDark);
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-toggle-light-icon').classList.toggle('hidden', isDark);
            document.getElementById('theme-toggle-dark-icon').classList.toggle('hidden', !isDark);
        };

        // --- EVENT BINDING ---
        document.getElementById('theme-toggle').addEventListener('click', () => setTheme(!document.documentElement.classList.contains('dark')));
        document.getElementById('search-input').addEventListener('input', (e) => { appState.filters.search = e.target.value.toLowerCase(); renderProjects(); });
        document.getElementById('status-filter').addEventListener('change', (e) => { appState.filters.status = e.target.value; renderProjects(); });
        document.getElementById('state-filter').addEventListener('change', (e) => { appState.filters.state = e.target.value; renderProjects(); });

        const gridBtn = document.getElementById('grid-view-btn');
        const listBtn = document.getElementById('list-view-btn');
        gridBtn.addEventListener('click', () => { appState.view = 'grid'; document.getElementById('grid-view').classList.remove('hidden'); document.getElementById('list-view').classList.add('hidden'); gridBtn.classList.add('bg-white', 'dark:bg-gray-700', 'text-indigo-600', 'dark:text-indigo-400'); listBtn.classList.remove('bg-white', 'dark:bg-gray-700', 'text-indigo-600', 'dark:text-indigo-400'); renderProjects(); });
        listBtn.addEventListener('click', () => { appState.view = 'list'; document.getElementById('list-view').classList.remove('hidden'); document.getElementById('grid-view').classList.add('hidden'); listBtn.classList.add('bg-white', 'dark:bg-gray-700', 'text-indigo-600', 'dark:text-indigo-400'); gridBtn.classList.remove('bg-white', 'dark:bg-gray-700', 'text-indigo-600', 'dark:text-indigo-400'); renderProjects(); });

        document.querySelectorAll('.modal-root').forEach(modal => { modal.addEventListener('click', e => { if (e.target.matches('.modal-overlay, .close-modal-btn, .close-modal-btn *')) closeModal(modal); }); });
        
        document.getElementById('grid-view').addEventListener('click', e => { const card = e.target.closest('.project-card'); if (card) handleProjectClick(card.dataset.projectId); });
        document.getElementById('list-view').addEventListener('click', e => { const row = e.target.closest('.project-row'); if (row) handleProjectClick(row.dataset.projectId); });
        
        document.getElementById('new-project-btn').addEventListener('click', () => openModal(document.getElementById('new-project-modal')));
        document.getElementById('new-project-form').addEventListener('submit', handleCreateProject);
        
        // Alert system event listeners
        document.getElementById('project-detail-modal').addEventListener('click', handleResolveAlert);
        document.getElementById('create-alert-btn').addEventListener('click', () => openModal(document.getElementById('create-alert-modal')));
        document.getElementById('create-alert-form').addEventListener('submit', handleCreateAlertSubmit);
        
        // --- INITIALIZATION ---
        const initialIsDark = localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
        setTheme(initialIsDark);
        generateMockData();
        populateFiltersAndForms();
        renderProjects();
        lucide.createIcons();
    });
    </script>
</body>
</html>