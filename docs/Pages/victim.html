<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Aid Lifeline</title>
    <!-- Noto Sans Font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Light Mode (Default) */
            --bg-primary: #F7F7F7;
            --bg-card: #FFFFFF;
            --text-primary: #1C1C1C;
            --text-secondary: #555;
            --border-color: #E0E0E0;
            --header-bg: rgba(247, 247, 247, 0.8);
            --chat-bg: #FFFFFF;
            --chat-input-bg: #F0F0F0;
            --bot-message-bg: #E7F0FA;

            /* Accents */
            --accent-action: #0056b3;
            --accent-action-glow: rgba(0, 86, 179, 0.2);
            --accent-success: #28a745;
            --accent-alert: #dc3545;
            --accent-help: #ffc107;
            --bg-action-light: #E7F0FA;
        }

        body.dark-mode {
            --bg-primary: #000000;
            --bg-card: #1A1A1A;
            --text-primary: #FFFFFF;
            --text-secondary: #AAAAAA;
            --border-color: #333333;
            --header-bg: rgba(0, 0, 0, 0.7);
            --chat-bg: #121212;
            --chat-input-bg: #2C2C2C;
            --bot-message-bg: #0A1929;
        }

        body {
            font-family: 'Noto Sans', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            font-size: 18px;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 16px;
        }

        .main-content {
            padding-top: 100px; /* Space for fixed header */
            padding-bottom: 180px; /* Space for FABs and protection banner */
        }

        /* --- 1. Header --- */
        .header {
            position: fixed;
            top: 0; left: 0; right: 0;
            padding: 16px;
            background-color: var(--header-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-identity .name { font-size: 18px; font-weight: 700; }
        .header-identity .case-no { font-size: 14px; color: var(--text-secondary); }
        .header-controls { display: flex; gap: 16px; align-items: center;}
        .control-btn { background: none; border: none; cursor: pointer; color: var(--text-primary); padding: 0; }
        
        /* --- Language Circle Meter --- */
        #language-selector-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .language-circle {
            position: absolute;
            top: calc(100% + 15px); /* Position below the header */
            right: 0; /* Align to the right of the container */
            width: 200px;
            height: 200px;
            pointer-events: none;
            opacity: 0;
            transform-origin: top right; /* Animate from the top right corner */
            transform: scale(0.5);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
            z-index: 1001;
        }
        .language-circle.visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: all;
        }
        .language-option {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 44px;
            height: 44px;
            margin: -22px 0 0 -22px;
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid var(--accent-action);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .language-option:hover {
            background-color: var(--accent-action);
            color: white;
            transform: var(--initial-transform) scale(1.15) !important;
        }


        /* --- Generic Card Style --- */
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        h2.card-title { font-size: 22px; margin-bottom: 20px; }

        .hidden { display: none !important; }

        /* --- 2. Action Card --- */
        .action-card { background-color: var(--bg-action-light); text-align: center; border-color: var(--accent-action); box-shadow: 0 0 20px var(--accent-action-glow); }
        body.dark-mode .action-card { background-color: #0A1929; }
        .action-card-icon { color: var(--accent-action); margin-bottom: 16px; }
        .action-card-instruction { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
        .action-card-subtext { font-size: 16px; color: var(--text-secondary); margin-bottom: 16px; }
        .voice-note-btn { background: none; border: none; cursor: pointer; color: var(--text-primary); vertical-align: middle; margin-left: 8px; }
        .btn-full { width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; background-color: var(--accent-action); color: white; }
        .btn-full:disabled { background-color: #888; cursor: not-allowed; }
        .btn-alert { background-color: var(--accent-alert); }

        /* --- Redesigned Journey Map --- */
        .journey-map { position: relative; padding-left: 20px; }
        .journey-line { position: absolute; left: 43px; top: 0; bottom: 0; width: 6px; background-color: var(--border-color); border-radius: 3px; }
        .journey-stage { display: flex; align-items: flex-start; position: relative; padding-left: 80px; margin-bottom: 30px; cursor: pointer; }
        .journey-node { position: absolute; left: 20px; top: 5px; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid var(--border-color); background-color: var(--bg-primary); color: var(--text-secondary); }
        .journey-stage.completed .journey-node { background-color: var(--accent-success); border-color: var(--accent-success); color: white; }
        .journey-stage.active .journey-node { background-color: var(--accent-action); border-color: var(--accent-action); color: white; animation: pulse 2s infinite; }
        .journey-details-title { font-weight: 700; font-size: 18px; }
        .journey-details-sub { font-size: 14px; color: var(--text-secondary); }
        .ecourts-badge { font-size: 12px; background-color: var(--accent-action); color: white; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-left: 8px; }
        .countdown-clock { font-size: 18px; font-weight: 700; color: var(--accent-action); margin-top: 8px; background-color: var(--bg-action-light); padding: 8px; border-radius: 6px; display: inline-block; }
        body.dark-mode .countdown-clock { background-color: #0A1929; }
        .countdown-clock.overdue { color: var(--accent-alert); background-color: #FFE3E3; }
        body.dark-mode .countdown-clock.overdue { background-color: #4D1212; }
        .sub-stage { margin-left: -50px; margin-top: 20px; margin-bottom: 20px; }
        .sub-stage .journey-node { width: 36px; height: 36px; left: 26px; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0, 86, 179, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(0, 86, 179, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 86, 179, 0); } }

        /* --- 4. Financial Rights --- */
        .financial-total { font-size: 24px; font-weight: 700; margin-bottom: 16px; }
        .progress-bar { height: 12px; background-color: var(--border-color); border-radius: 6px; overflow: hidden; margin-bottom: 20px; }
        .progress-bar-fill { height: 100%; width: 25%; background-color: var(--accent-success); border-radius: 6px; }
        .ledger-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .ledger-item:last-child { border-bottom: none; }
        .ledger-status { font-weight: 700; }
        .status-paid { color: var(--accent-success); }
        .status-pending { color: var(--text-secondary); }

        /* --- Feature 5: Chronological Evidence Vault --- */
        #evidence-vault { padding: 0; }
        .evidence-timeline { display: flex; overflow-x: auto; gap: 16px; padding: 16px; }
        .evidence-card { flex: 0 0 200px; background-color: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 8px; padding: 16px; }
        .evidence-card .timestamp { font-size: 13px; font-weight: 700; color: var(--text-secondary); margin-bottom: 8px; }
        .evidence-card .media-icon { text-align: center; margin-bottom: 8px; }
        .evidence-card .caption { font-size: 15px; font-style: italic; white-space: normal; }
        .add-evidence-card { border-style: dashed; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .add-evidence-card:hover { border-color: var(--accent-action); color: var(--accent-action); }

        /* --- Feature 1: AI FIR Sanity Check --- */
        #fir-sanity-check { border-left: 4px solid var(--accent-action); }
        .sanity-check-item { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .sanity-check-item .icon-success { color: var(--accent-success); }
        .sanity-check-item .icon-warning { color: var(--accent-help); }
        .sanity-check-item .icon-error { color: var(--accent-alert); }

        /* --- Feature 2: Immutable Event Stream --- */
        .event-stream-list { list-style: none; padding: 0; margin: 0; }
        .event-item { display: flex; gap: 16px; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .event-item:last-child { border-bottom: none; }
        .event-item .timestamp { font-size: 14px; color: var(--text-secondary); width: 120px; flex-shrink: 0; }
        .event-item .description { font-size: 16px; }

        /* --- Feature 4: Know Your Officials Directory --- */
        #officials-content .officials-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .official-card { text-align: center; }
        .official-card img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 8px; border: 2px solid var(--border-color); }
        .official-card .name { font-weight: 700; }
        .official-card .rank { font-size: 14px; color: var(--text-secondary); }

        /* --- Feature 6: Automated Travel & Expense Log --- */
        #travel-log-card { background-color: var(--bg-action-light); }
        body.dark-mode #travel-log-card { background-color: #0A1929; }
        
        /* --- Feature 8: Community Alerts --- */
        .toggle-item { display: flex; justify-content: space-between; align-items: center; }
        .alert-example { font-size: 14px; font-style: italic; color: var(--text-secondary); background-color: var(--bg-primary); padding: 8px; border-radius: 4px; margin-top: 12px; }

        /* --- Feature 10: Post-Case Rehabilitation --- */
        #path-to-recovery .schemes-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
        .scheme-card { background-color: var(--bg-primary); padding: 16px; border-radius: 8px; border: 1px solid var(--border-color); }
        .scheme-card-title { font-weight: 700; margin-bottom: 8px; }
        .scheme-card-desc { font-size: 15px; margin-bottom: 12px; }

        /* --- Feature 3: Dynamic Witness Protection Request --- */
        .protection-banner { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--bg-card); border-top: 2px solid var(--accent-alert); padding: 16px; display: flex; justify-content: space-between; align-items: center; z-index: 999; box-shadow: 0 -4px 12px rgba(0,0,0,0.1); }
        .protection-banner p { margin: 0; font-weight: 700; font-size: 16px; }
        
        /* --- Voice Only Mode --- */
        #voice-mode-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.9);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #voice-mode-overlay:not(.hidden) {
            opacity: 1;
            visibility: visible;
        }

        .voice-mic-icon {
            width: 128px;
            height: 128px;
            margin-bottom: 24px;
            animation: pulse-mic 2s infinite ease-in-out;
        }
        #voice-status-text {
            font-size: 22px;
            font-weight: 700;
        }
        #exit-voice-mode-btn {
            margin-top: 40px;
            padding: 12px 24px;
            font-size: 18px;
            background-color: var(--accent-alert);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }


        /* --- Modals and FABs --- */
        .fab { position: fixed; bottom: 90px; right: 30px; width: 60px; height: 60px; background-color: var(--accent-help); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 1001; animation: pulse-fab 2.5s infinite; }
        .ai-fab { position: fixed; bottom: 90px; left: 30px; width: 60px; height: 60px; background-color: var(--accent-action); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; z-index: 1001; color: white; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: var(--bg-card); padding: 24px; border-radius: 12px; width: 90%; max-width: 500px; text-align: left; }
        .modal-content h3 { font-size: 20px; margin-top: 0; }
        .modal-content .detail-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .modal-content .detail-item:last-child { border-bottom: none; }
        .modal-content .detail-label { color: var(--text-secondary); }
        .modal-content .detail-value { font-weight: 700; }
        .modal-btn { display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; padding: 16px; font-size: 18px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-primary); color: var(--text-primary); cursor: pointer; margin-bottom: 16px; }
        .modal-btn:last-child { margin-bottom: 0; }
        #share-link-modal .generated-link { background-color: var(--bg-primary); padding: 12px; border-radius: 8px; font-family: monospace; word-break: break-all; margin-bottom: 16px; }
        
        /* --- Chat styles --- */
        .chat-container { position: fixed; bottom: 160px; left: 30px; width: 90%; max-width: 400px; height: 60vh; max-height: 500px; background-color: var(--chat-bg); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); display: flex; flex-direction: column; overflow: hidden; transform: scale(0.95) translateY(20px); opacity: 0; visibility: hidden; transition: transform 0.3s ease, opacity 0.3s ease, visibility 0.3s; z-index: 1002; }
        .chat-container.active { transform: scale(1) translateY(0); opacity: 1; visibility: visible; }
        .chat-header { padding: 16px; border-bottom: 1px solid var(--border-color); font-weight: 700; display: flex; justify-content: space-between; align-items: center; }
        .chat-header-close { background: none; border: none; cursor: pointer; color: var(--text-primary); }
        .chat-messages { flex-grow: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { padding: 10px 14px; border-radius: 18px; max-width: 80%; line-height: 1.4; }
        .user-message { background-color: var(--accent-action); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .bot-message { background-color: var(--bot-message-bg); align-self: flex-start; border-bottom-left-radius: 4px; }
        .typing-indicator { display: flex; align-items: center; gap: 5px; }
        .typing-indicator span { width: 8px; height: 8px; border-radius: 50%; background-color: var(--text-secondary); animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; } .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .chat-input-form { display: flex; padding: 12px; border-top: 1px solid var(--border-color); gap: 8px; }
        #chat-input { flex-grow: 1; border: none; background-color: var(--chat-input-bg); border-radius: 20px; padding: 10px 16px; font-family: 'Noto Sans', sans-serif; font-size: 16px; color: var(--text-primary); }
        #chat-input:focus { outline: none; box-shadow: 0 0 0 2px var(--accent-action); }
        .chat-action-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; }
        .chat-action-btn:hover { color: var(--accent-action); }
        .chat-action-btn.listening { color: var(--accent-alert); animation: pulse-mic 1.5s infinite; }
        @keyframes pulse-mic { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        #file-upload-input { display: none; }
        .chat-action-button { background-color: var(--bg-card); border: 1px solid var(--accent-action); color: var(--accent-action); padding: 8px 12px; border-radius: 15px; cursor: pointer; margin-top: 8px; display: inline-block; font-weight: 700; }
        
        /* Protections and other feature styles... */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked+.slider { background-color: var(--accent-action); }
        input:checked+.slider:before { transform: translateX(26px); }
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; }
        .tab-btn { padding: 10px 16px; cursor: pointer; background: none; border: none; color: var(--text-secondary); font-family: 'Noto Sans', sans-serif; font-size: 16px; font-weight: 700; border-bottom: 4px solid transparent; }
        .tab-btn.active { color: var(--text-primary); border-bottom-color: var(--accent-action); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
    </style>
</head>

<body>

    <!-- 1. Header -->
    <header class="header">
        <div class="header-identity">
            <div class="name" data-lang-key="greeting">Namaste, Sunita Devi</div>
            <div class="case-no" data-lang-key="case_no">Case No: SC-123-2024</div>
        </div>
        <div class="header-controls">
            <button class="control-btn" id="voice-mode-toggle" aria-label="Toggle Voice Mode"><i data-lucide="mic"></i></button>
            <div id="language-selector-wrapper">
                <button class="control-btn" id="lang-toggle" aria-label="Switch Language"><i data-lucide="languages"></i></button>
                <div id="language-circle-menu" class="language-circle">
                    <!-- Language options will be injected here by JS -->
                </div>
            </div>
            <button class="control-btn" id="theme-toggle" aria-label="Toggle light/dark mode"><i data-lucide="sun"></i></button>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            
            <div id="case-active-content">
                <!-- 2. "What's Next?" Action Card -->
                <section class="card action-card">
                    <div class="action-card-icon"><i data-lucide="shield" style="width:64px; height:64px;"></i></div>
                    <h2 class="action-card-instruction" data-lang-key="next_step_title">Go to the Police Station</h2>
                    <div class="action-card-subtext" data-lang-key="next_step_subtitle">Show them this FIR number: 123-456-7890</div>
                    <button class="voice-note-btn" aria-label="Play instruction audio"><i data-lucide="play-circle"></i></button>
                </section>

                <!-- Redesigned Justice Delivery Timeline -->
                <section class="card" id="journey-map-card">
                    <h2 class="card-title" data-lang-key="timeline_title">Justice Delivery Timeline</h2>
                    <div class="journey-map">
                        <div class="journey-line"></div>
                        
                        <!-- Stage 1: FIR Registered -->
                        <div class="journey-stage completed" data-modal="fir-details-modal">
                            <div class="journey-node"><i data-lucide="check"></i></div>
                            <div class="journey-details">
                                <div class="journey-details-title" data-lang-key="stage_fir">FIR Registered</div>
                                <div class="journey-details-sub" data-lang-key="stage1_sub">Your complaint is officially recorded.</div>
                            </div>
                        </div>

                        <!-- Stage 2: Investigation & Initial Relief -->
                        <div class="journey-stage active">
                             <div class="journey-node" style="visibility: hidden;"></div> <!-- Placeholder for alignment -->
                             <div class="journey-details" style="width: 100%;">
                                <!-- Sub-Node 2A -->
                                <div class="journey-stage sub-stage" data-modal="investigation-details-modal">
                                    <div class="journey-node active"><i data-lucide="search"></i></div>
                                    <div class="journey-details">
                                        <div class="journey-details-title" data-lang-key="stage2a_title">Investigation Assigned</div>
                                        <div class="journey-details-sub" data-lang-key="stage2a_sub">A senior officer is now in charge.</div>
                                    </div>
                                </div>
                                <!-- Sub-Node 2B -->
                                <div class="journey-stage sub-stage" data-modal="relief1-details-modal">
                                    <div class="journey-node active"><i data-lucide="indian-rupee"></i></div>
                                    <div class="journey-details">
                                        <div class="journey-details-title" data-lang-key="stage2b_title">First Relief Payment</div>
                                        <div class="journey-details-sub" data-lang-key="stage2b_sub">(Due within 7 Days of FIR)</div>
                                        <div class="countdown-clock" id="relief-countdown">--d --h --m --s</div>
                                    </div>
                                </div>
                             </div>
                        </div>
                        
                        <!-- Stage 3: Charge Sheet Filed -->
                        <div class="journey-stage" data-modal="chargesheet-details-modal">
                            <div class="journey-node"><i data-lucide="gavel"></i></div>
                            <div class="journey-details">
                                <div class="journey-details-title" data-lang-key="stage_chargesheet">Charge Sheet Filed</div>
                                <div class="journey-details-sub" data-lang-key="stage3_sub">(Due within 60 Days of FIR)</div>
                                <div class="countdown-clock" id="chargesheet-countdown">--d --h --m --s</div>
                            </div>
                        </div>

                        <!-- Stage 4: Second Relief Payment -->
                        <div class="journey-stage" data-modal="relief2-details-modal">
                            <div class="journey-node"><i data-lucide="indian-rupee"></i></div>
                            <div class="journey-details">
                                <div class="journey-details-title" data-lang-key="stage4_title">Second Relief Payment</div>
                                <div class="journey-details-sub" data-lang-key="stage4_sub">Triggered after charge sheet is filed.</div>
                            </div>
                        </div>

                        <!-- Stage 5: Trial in Special Court -->
                        <div class="journey-stage" data-modal="trial-details-modal">
                            <div class="journey-node"><i data-lucide="calendar"></i></div>
                            <div class="journey-details">
                                <div class="journey-details-title" data-lang-key="stage5_title">Trial in Progress</div>
                                <div class="journey-details-sub" id="next-hearing-subtext"></div>
                            </div>
                        </div>

                        <!-- Stage 6: Final Judgment & Final Relief -->
                        <div class="journey-stage" data-modal="judgment-details-modal">
                            <div class="journey-node"><i data-lucide="scroll"></i></div>
                            <div class="journey-details">
                                <div class="journey-details-title" data-lang-key="stage6_title">Final Judgment</div>
                                <div class="journey-details-sub" data-lang-key="stage6_sub">Verified by eCourts API</div>
                            </div>
                        </div>

                        <!-- Conditional Final Payment Node -->
                        <div class="journey-stage hidden" id="final-relief-stage" data-modal="relief-final-details-modal">
                            <div class="journey-node"><i data-lucide="award"></i></div>
                             <div class="journey-details">
                                <div class="journey-details-title" data-lang-key="stage_final_relief_title">Final Relief Payment</div>
                                <div class="journey-details-sub" data-lang-key="stage_final_relief_sub">Payable upon conviction.</div>
                            </div>
                        </div>

                    </div>
                </section>
            </div>

            <!-- Feature 10: Post-Case Rehabilitation & Livelihood Connector -->
            <section class="card hidden" id="path-to-recovery">
                <h2 class="card-title" data-lang-key="recovery_title">Your Path to Recovery</h2>
                <p data-lang-key="recovery_desc">The court case has concluded. Here are some government schemes to support you in the next phase of your life.</p>
                <div class="schemes-grid">
                    <div class="scheme-card">
                        <h3 class="scheme-card-title" data-lang-key="scheme_mgnrega_title">MGNREGA Employment</h3>
                        <p class="scheme-card-desc" data-lang-key="scheme_mgnrega_desc">Guaranteed 100 days of wage employment in a financial year.</p>
                        <button class="btn-full" data-lang-key="apply_now">Apply Now</button>
                    </div>
                </div>
            </section>

            <!-- All Other Features Restored -->
             <section class="card">
                <h2 class="card-title" data-lang-key="event_stream_title">Case Event Stream</h2>
                <ul class="event-stream-list" id="event-stream"></ul>
            </section>
            <section class="card" id="evidence-vault">
                <h2 class="card-title" data-lang-key="evidence_vault_title">Chronological Evidence Vault</h2>
                 <div class="evidence-timeline" id="evidence-timeline">
                    <div class="evidence-card">
                        <div class="timestamp">Oct 12, 2025, 8:15 PM</div>
                        <div class="media-icon"><i data-lucide="image" style="width:48px; height:48px;"></i></div>
                        <div class="caption">"Photo of the broken lock on my door."</div>
                    </div>
                    <div class="evidence-card add-evidence-card" id="add-evidence-btn">
                        <i data-lucide="plus" style="width:48px; height:48px;"></i>
                        <div data-lang-key="add_evidence">Add Evidence</div>
                    </div>
                </div>
            </section>
            <section class="card hidden" id="fir-sanity-check">
                 <h2 class="card-title">AI-Powered FIR Sanity Check</h2>
                 <div id="fir-sanity-check-content"></div>
            </section>
            <section class="card">
                <h2 class="card-title" data-lang-key="financial_title">Your Financial Rights</h2>
                <div class="financial-total">₹8,25,000 <span style="font-size: 16px; font-weight: 400;" data-lang-key="financial_total">Total Entitlement</span></div>
                <div class="progress-bar"><div class="progress-bar-fill"></div></div>
                <div class="ledger-item">
                    <div>
                        <div data-lang-key="payment_item1_desc">25% on FIR/Chargesheet</div>
                        <div>₹2,06,250</div>
                    </div>
                    <div class="ledger-status status-paid" data-lang-key="status_paid">PAID</div>
                </div>
            </section>
            <section class="card" id="travel-log-card">
                <h2 class="card-title" data-lang-key="travel_log_title">Court Hearing Travel Allowance</h2>
                <p data-lang-key="travel_log_desc">You are entitled to a travel allowance for your upcoming hearing.</p>
                <button class="btn-full" id="log-travel-btn" data-lang-key="log_travel_btn">Log Travel & Expenses</button>
            </section>
            <section class="card">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="officials-content" data-lang-key="tab_officials">Know Your Officials</button>
                    <button class="tab-btn" data-tab="witness-content" data-lang-key="tab_witness">Witness Support</button>
                    <button class="tab-btn" data-tab="rights-content" data-lang-key="tab_rights">Your Rights</button>
                </div>
                <div id="officials-content" class="tab-content active">
                    <div class="officials-grid">
                        <div class="official-card">
                            <img src="https://placehold.co/100x100/E7F0FA/0056b3?text=IO" alt="Investigating Officer">
                            <div class="name">A. K. Sharma</div>
                            <div class="rank">DSP</div>
                        </div>
                    </div>
                </div>
                <div id="witness-content" class="tab-content">
                    <div class="toggle-item">
                        <span>Request Witness Protection</span>
                        <label class="switch"><input type="checkbox"><span class="slider"></span></label>
                    </div>
                </div>
                 <div id="rights-content" class="tab-content"><p>Right to Free Legal Aid...</p></div>
            </section>
            <section class="card">
                <h2 class="card-title" data-lang-key="community_safety_title">Community Safety Settings</h2>
                <div class="toggle-item">
                    <span data-lang-key="community_safety_toggle">Enable Community Safety Alerts</span>
                    <label class="switch"><input type="checkbox" id="community-alerts-toggle"><span class="slider"></span></label>
                </div>
                <div class="alert-example hidden" id="alert-example">
                    <b>Sample Alert:</b> "Incident reported in your block."
                </div>
            </section>
            <section class="card">
                <h2 class="card-title" data-lang-key="report_title">Report an Issue</h2>
                <textarea class="report-textarea" data-lang-placeholder-key="report_placeholder" placeholder="..."></textarea>
                <button class="btn-full" data-lang-key="submit">Submit</button>
            </section>
        </div>
    </main>

    <!-- Modals & Banners -->
    <div class="protection-banner" id="protection-banner">
        <p data-lang-key="protection_banner_text">Are you or your witnesses being threatened?</p>
        <button class="btn-full btn-alert" style="width: auto;" id="request-protection-btn" data-lang-key="request_protection_btn">Request Protection</button>
    </div>
    
    <div class="modal-overlay" id="help-modal">
        <div class="modal-content" style="text-align:center;">
             <button class="modal-btn"><i data-lucide="phone"></i><span data-lang-key="call_helpline">Call Helpline</span></button>
            <button class="modal-btn" id="share-link-btn"><i data-lucide="share-2"></i><span data-lang-key="share_advisor_btn">Share with Advisor</span></button>
        </div>
    </div>
     <div class="modal-overlay" id="protection-confirm-modal">
        <div class="modal-content">
            <h2>Confirm Protection Request</h2>
            <p>This will send a high-priority alert to the DM and SP.</p>
            <button class="btn-full btn-alert" id="confirm-protection-final">I Confirm, Send Alert</button>
            <button class="modal-btn" style="margin-top: 12px;" id="cancel-protection">Cancel</button>
        </div>
    </div>
    <div class="modal-overlay" id="share-link-modal">
        <div class="modal-content">
            <h2>Secure Link</h2>
            <p>This link is valid for 24 hours.</p>
            <div class="generated-link">https://nyay.gov/case/s-123/view?token=...</div>
            <button class="btn-full" id="close-share-modal">Close</button>
        </div>
    </div>
    <div class="modal-overlay" id="travel-log-modal">
         <div class="modal-content">
            <h2>Log Travel Expenses</h2>
             <form id="travel-form">
                <input type="number" id="travel-distance" placeholder="Distance in KM" required style="width: 100%; padding: 8px; margin-bottom: 8px;">
                <p>Calculated Allowance: <b id="calculated-allowance">₹0</b></p>
                <button type="submit" class="btn-full">Submit</button>
             </form>
         </div>
    </div>

    <!-- Timeline Modals -->
    <div class="modal-overlay" id="fir-details-modal"><div class="modal-content" id="modal-fir-content"></div></div>
    <div class="modal-overlay" id="investigation-details-modal"><div class="modal-content" id="modal-investigation-content"></div></div>
    <div class="modal-overlay" id="relief1-details-modal"><div class="modal-content" id="modal-relief1-content"></div></div>
    <div class="modal-overlay" id="chargesheet-details-modal"><div class="modal-content"><h3>Charge Sheet</h3><p>Pending...</p></div></div>
    <div class="modal-overlay" id="relief2-details-modal"><div class="modal-content" id="modal-relief2-content"></div></div>
    <div class="modal-overlay" id="trial-details-modal"><div class="modal-content" id="modal-trial-content"></div></div>
    <div class="modal-overlay" id="judgment-details-modal"><div class="modal-content" id="modal-judgment-content"></div></div>
    <div class="modal-overlay" id="relief-final-details-modal"><div class="modal-content" id="modal-relief-final-content"></div></div>

    <!-- FABs and Chat -->
    <div class="fab" id="help-fab"><i data-lucide="help-circle"></i></div>
    <div class="ai-fab" id="ai-fab"><i data-lucide="bot"></i></div>
    <div class="chat-container" id="chat-container">
         <div class="chat-header"><span>Nyay Sahayak AI</span><button class="chat-header-close" id="chat-close-btn"><i data-lucide="x"></i></button></div>
        <div class="chat-messages" id="chat-messages"></div>
        <form class="chat-input-form" id="chat-form">
            <input type="file" id="file-upload-input" accept="image/*">
            <button type="button" class="chat-action-btn" id="file-upload-btn" aria-label="Attach file"><i data-lucide="paperclip"></i></button>
            <input type="text" id="chat-input" placeholder="Ask me anything..." autocomplete="off">
            <button type="button" class="chat-action-btn" id="mic-btn" aria-label="Use voice"><i data-lucide="mic"></i></button>
            <button type="submit" class="chat-action-btn" aria-label="Send message"><i data-lucide="send"></i></button>
        </form>
    </div>
    
    <!-- Voice Only Mode Overlay -->
    <div id="voice-mode-overlay" class="hidden">
        <div class="voice-content">
            <i data-lucide="mic" class="voice-mic-icon"></i>
            <p id="voice-status-text">Listening...</p>
            <button id="exit-voice-mode-btn">Exit Voice Mode</button>
        </div>
    </div>


    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            lucide.createIcons();
            
            // --- Gemini API Key ---
            const GEMINI_API_KEY = "";
            
            // App State, Data, and Translations
            const appState = {
                languages: ['en', 'hi', 'bho', 'ta', 'bn', 'mr', 'te'],
                currentLang: 'en'
            };
            const caseData = {
                fir: { number: "123-456", datetime: new Date(new Date().getTime() - 80 * 24 * 60 * 60 * 1000), station: "Noida Sec 24", sections: "IPC 323, PoA 3(1)(r)" },
                investigation: { officer: "A. K. Sharma", rank: "DSP", isValid: true },
                relief1: { amount: "₹2,06,250", status: "Pending" },
                relief2: { amount: "₹4,12,500", status: "Pending" },
                trial: { nextHearing: "2025-12-10T11:00:00", history: "15-11-2025: Appearance" },
                judgment: { verdict: "Conviction", date: "2026-03-01" },
                reliefFinal: { amount: "₹2,06,250", status: "Pending" }
            };
            const translations = {
                en: { greeting: "Namaste, Sunita Devi", case_no: "Case No: SC-123-2024", next_step_title: "Go to the Police Station", next_step_subtitle: "Show them this FIR number: 123-456-7890", timeline_title: "Justice Delivery Timeline", stage_fir: "FIR Registered", stage1_sub: "Your complaint is officially recorded.", stage2a_title: "Investigation Assigned", stage2a_sub: "A senior officer is now in charge.", stage2b_title: "First Relief Payment", stage2b_sub: "(Due within 7 Days of FIR)", stage_chargesheet: "Charge Sheet Filed", stage3_sub: "(Due within 60 Days of FIR)", stage4_title: "Second Relief Payment", stage4_sub: "Triggered after charge sheet is filed.", stage5_title: "Trial in Progress", stage6_title: "Final Judgment", stage6_sub: "Verified by eCourts API", stage_final_relief_title: "Final Relief Payment", stage_final_relief_sub: "Payable upon conviction.", recovery_title: "Your Path to Recovery", recovery_desc: "The court case has concluded. Here are some government schemes to support you.", scheme_mgnrega_title: "MGNREGA Employment", scheme_mgnrega_desc: "Guaranteed 100 days of wage employment.", apply_now: "Apply Now", event_stream_title: "Case Event Stream", evidence_vault_title: "Chronological Evidence Vault", add_evidence: "Add Evidence", financial_title: "Your Financial Rights", financial_total: "Total Entitlement", payment_item1_desc: "25% on FIR/Chargesheet", status_paid: "PAID", status_pending: "PENDING", travel_log_title: "Court Hearing Travel Allowance", travel_log_desc: "You are entitled to a travel allowance for your upcoming hearing.", log_travel_btn: "Log Travel & Expenses", tab_officials: "Know Your Officials", tab_witness: "Witness Support", tab_rights: "Your Rights", community_safety_title: "Community Safety Settings", community_safety_toggle: "Enable Community Safety Alerts", report_title: "Report an Issue", report_placeholder: "Tell us what is wrong...", submit: "Submit", protection_banner_text: "Are you or your witnesses being threatened?", request_protection_btn: "Request Protection", call_helpline: "Call Helpline", share_advisor_btn: "Share with Advisor" },
                hi: { greeting: "नमस्ते, सुनीता देवी", case_no: "केस नंबर: SC-123-2024", next_step_title: "पुलिस स्टेशन जाएं", next_step_subtitle: "उन्हें यह एफआईआर नंबर दिखाएं", timeline_title: "न्याय वितरण समयरेखा", stage_fir: "प्राथमिकी दर्ज", stage1_sub: "आपकी शिकायत आधिकारिक तौर पर दर्ज है।", stage2a_title: "जांच सौंपी गई", stage2a_sub: "एक वरिष्ठ अधिकारी अब प्रभारी है।", stage2b_title: "पहली राहत भुगतान", stage2b_sub: "(प्राथमिकी के 7 दिनों के भीतर देय)", stage_chargesheet: "आरोप पत्र दायर", stage3_sub: "(प्राथमिकी के 60 दिनों के भीतर देय)", stage4_title: "दूसरी राहत भुगतान", stage4_sub: "आरोप पत्र दाखिल होने के बाद शुरू हुआ।", stage5_title: "परीक्षण प्रगति पर है", stage6_title: "अंतिम निर्णय", stage6_sub: "ई-कोर्ट्स एपीआई द्वारा सत्यापित", stage_final_relief_title: "अंतिम राहत भुगतान", stage_final_relief_sub: "सजा पर देय।", event_stream_title: "केस घटनाक्रम", evidence_vault_title: "साक्ष्य वॉल्ट", add_evidence: "साक्ष्य जोड़ें", financial_title: "आपके वित्तीय अधिकार", financial_total: "कुल हकदारी", travel_log_title: "कोर्ट सुनवाई यात्रा भत्ता", log_travel_btn: "यात्रा और व्यय लॉग करें", tab_officials: "अपने अधिकारियों को जानें", tab_witness: "गवाह सहायता", tab_rights: "आपके अधिकार", community_safety_title: "सामुदायिक सुरक्षा सेटिंग्स", community_safety_toggle: "सामुदायिक सुरक्षा अलर्ट सक्षम करें", report_title: "समस्या की रिपोर्ट करें", submit: "प्रस्तुत करें", protection_banner_text: "क्या आपको या आपके गवाहों को धमकाया जा रहा है?", request_protection_btn: "सुरक्षा का अनुरोध करें", call_helpline: "हेल्पलाइन पर कॉल करें", share_advisor_btn: "सलाहकार के साथ साझा करें" },
                bho: { greeting: "नमस्ते, सुनीता देवी", case_no: "केस नंबर: SC-123-2024", next_step_title: "पुलिस स्टेशन जाईं", next_step_subtitle: "ओहिजा ई एफआईआर नंबर दिखाईं", timeline_title: "न्याय के समयरेखा", stage_fir: "FIR दर्ज हो गइल", stage1_sub: "रउआ शिकायत दर्ज हो गइल बा।", stage2a_title: "जांच सौंपल गइल", stage2a_sub: "अब एक वरिष्ठ अधिकारी प्रभारी बाड़ें।", stage2b_title: "पहिला राहत भुगतान", stage2b_sub: "(FIR के 7 दिन के भीतर)", stage_chargesheet: "चार्जशीट दाखिल हो गइल", stage3_sub: "(FIR के 60 दिन के भीतर)", stage4_title: "दूसर राहत भुगतान", stage4_sub: "चार्जशीट के बाद मिली।", stage5_title: "ट्रायल चल रहल बा", stage6_title: "अंतिम फैसला", stage6_sub: "ई-कोर्ट्स से सत्यापित", stage_final_relief_title: "अंतिम राहत भुगतान", stage_final_relief_sub: "सजा पर मिली।", event_stream_title: "केस के घटनाक्रम", evidence_vault_title: "सबूत के तिजोरी", add_evidence: "सबूत जोड़ीं", financial_title: "रउआ वित्तीय अधिकार", financial_total: "कुल हकदारी", travel_log_title: "कोर्ट सुनवाई के खरचा", log_travel_btn: "खरचा लिखीं", tab_officials: "अधिकारी के जानीं", tab_witness: "गवाह के मदद", tab_rights: "रउआ अधिकार", community_safety_title: "समाज के सुरक्षा", community_safety_toggle: "सुरक्षा अलर्ट चालू करीं", report_title: "समस्या बताईं", submit: "जमा करीं", protection_banner_text: "का रउआ भा रउआ गवाह के धमकी मिलत बा?", request_protection_btn: "सुरक्षा मांगीं", call_helpline: "हेल्पलाइन के फोन करीं", share_advisor_btn: "सलाहकार से साझा करीं" },
                ta: { greeting: "வணக்கம், சுனிதா தேவி", case_no: "வழக்கு எண்: SC-123-2024", next_step_title: "காவல் நிலையம் செல்லவும்", next_step_subtitle: "இந்த FIR எண்ணைக் காட்டுங்கள்", timeline_title: "நீதி வழங்கல் காலவரிசை", stage_fir: "FIR பதிவு செய்யப்பட்டது", stage1_sub: "உங்கள் புகார் பதிவு செய்யப்பட்டது.", stage2a_title: "விசாரணை ஒப்படைக்கப்பட்டது", stage2a_sub: "ஒரு மூத்த அதிகாரி பொறுப்பேற்றுள்ளார்.", stage2b_title: "முதல் நிவாரணத் தொகை", stage2b_sub: "(FIR செய்த 7 நாட்களுக்குள்)", stage_chargesheet: "குற்றப்பத்திரிகை தாக்கல்", stage3_sub: "(FIR செய்த 60 நாட்களுக்குள்)", stage4_title: "இரண்டாவது நிவாரணத் தொகை", stage4_sub: "குற்றப்பத்திரிகைக்குப் பிறகு வழங்கப்படும்.", stage5_title: "விசாரணை চলছে", stage6_title: "இறுதி தீர்ப்பு", stage6_sub: "eCourts மூலம் சரிபார்க்கப்பட்டது", stage_final_relief_title: "இறுதி நிவாரணத் தொகை", stage_final_relief_sub: "தண்டனைக்குப் பிறகு வழங்கப்படும்.", event_stream_title: "வழக்கு நிகழ்வுகள்", evidence_vault_title: "ஆதார பெட்டகம்", add_evidence: "ஆதாரம் சேர்க்கவும்", financial_title: "உங்கள் நிதி உரிமைகள்", financial_total: "மொத்த உரிமை", travel_log_title: "நீதிமன்ற விசாரணை பயணப்படி", log_travel_btn: "பயண செலவுகளை பதிவு செய்யவும்", tab_officials: "உங்கள் அதிகாரிகளை அறியுங்கள்", tab_witness: "சாட்சி ஆதரவு", tab_rights: "உங்கள் உரிமைகள்", community_safety_title: "சமூக பாதுகாப்பு", community_safety_toggle: "பாதுகாப்பு விழிப்பூட்டல்களை இயக்கு", report_title: "சிக்கலைப் புகாரளி", submit: "சமர்ப்பி", protection_banner_text: "நீங்களோ அல்லது உங்கள் சாட்சிகளோ அச்சுறுத்தப்படுகிறீர்களா?", request_protection_btn: "பாதுகாப்பு கோரவும்", call_helpline: "உதவி எண்ணை அழைக்கவும்", share_advisor_btn: "ஆலோசகருடன் பகிரவும்" },
                bn: { greeting: "নমস্কার, সুনিতা দেবী", case_no: "কেস নং: SC-123-2024", next_step_title: "থানায় যান", next_step_subtitle: "তাদের এই এফআইআর নম্বরটি দেখান", timeline_title: "বিচার বিতরণ টাইমলাইন", stage_fir: "এফআইআর दर्षित", stage1_sub: "আপনার অভিযোগ दर्षित হয়েছে।", stage2a_title: "তদন্ত অর্পিত", stage2a_sub: "একজন সিনিয়র অফিসার দায়িত্বে আছেন।", stage2b_title: "প্রথম ত্রাণ প্রদান", stage2b_sub: "(এফআইআর এর ৭ দিনের মধ্যে)", stage_chargesheet: "চার্জশিট দাখিল", stage3_sub: "(এফআইআর এর ৬০ দিনের মধ্যে)", stage4_title: "দ্বিতীয় ত্রাণ প্রদান", stage4_sub: "চার্জশিট দাখিলের পরে।", stage5_title: "বিচার চলছে", stage6_title: "চূড়ান্ত রায়", stage6_sub: "eCourts দ্বারা যাচাইকৃত", stage_final_relief_title: "চূড়ান্ত ত্রাণ প্রদান", stage_final_relief_sub: "সাজার পরে দেওয়া হবে।", event_stream_title: "কেস ইভেন্ট স্ট্রীম", evidence_vault_title: "প্রমাণ ভল্ট", add_evidence: "প্রমাণ যোগ করুন", financial_title: "আপনার আর্থিক অধিকার", financial_total: "মোট অধিকার", travel_log_title: "কোর্ট শুনানির ভ্রমণ ভাতা", log_travel_btn: "ভ্রমণ খরচ লগ করুন", tab_officials: "আপনার কর্মকর্তাদের জানুন", tab_witness: "সাক্ষী সমর্থন", tab_rights: "আপনার অধিকার", community_safety_title: "קהילה பாதுகாப்பு அமைப்புகள்", community_safety_toggle: "பாதுகாப்பு எச்சரிக்கைகளை இயக்கு", report_title: "সমস্যা রিপোর্ট করুন", submit: "জমা দিন", protection_banner_text: "আপনি বা আপনার সাক্ষীরা কি হুমকির সম্মুখীন হচ্ছেন?", request_protection_btn: "সুরক্ষার অনুরোধ করুন", call_helpline: "হেল্পলাইনে কল করুন", share_advisor_btn: " উপদেষ্টার সাথে শেয়ার করুন" },
                mr: { greeting: "नमस्कार, सुनीता देवी", case_no: "केस क्र: SC-123-2024", next_step_title: "पोलीस स्टेशनला जा", next_step_subtitle: "त्यांना हा एफआयआर क्रमांक दाखवा", timeline_title: "न्याय वितरण टाइमलाइन", stage_fir: "एफआयआर दाखल", stage1_sub: "तुमची तक्रार अधिकृतपणे नोंदवली आहे.", stage2a_title: "तपास सोपवला", stage2a_sub: "एक वरिष्ठ अधिकारी आता प्रभारी आहेत.", stage2b_title: "पहिली मदत रक्कम", stage2b_sub: "(एफआयआरच्या ७ दिवसांच्या आत)", stage_chargesheet: "आरोपपत्र दाखल", stage3_sub: "(एफआयआरच्या ६० दिवसांच्या आत)", stage4_title: "दुसरी मदत रक्कम", stage4_sub: "आरोपपत्र दाखल केल्यानंतर.", stage5_title: "खटला सुरू आहे", stage6_title: "अंतिम निकाल", stage6_sub: "ई-कोर्टद्वारे सत्यापित", stage_final_relief_title: "अंतिम मदत रक्कम", stage_final_relief_sub: "दोषी ठरल्यास देय.", event_stream_title: "केस घटना क्रम", evidence_vault_title: "पुरावा तिजोरी", add_evidence: "पुरावा जोडा", financial_title: "तुमचे आर्थिक हक्क", financial_total: "एकूण हक्क", travel_log_title: "कोर्ट सुनावणी प्रवास भत्ता", log_travel_btn: "प्रवास खर्च नोंदवा", tab_officials: "तुमचे अधिकारी जाणून घ्या", tab_witness: "साक्षीदार समर्थन", tab_rights: "तुमचे हक्क", community_safety_title: "समुदाय सुरक्षा सेटिंग्ज", community_safety_toggle: "समुदाय सुरक्षा सूचना सक्षम करा", report_title: "समस्येचा अहवाल द्या", submit: "सादर करा", protection_banner_text: "तुम्हाला किंवा तुमच्या साक्षीदारांना धमकावले जात आहे का?", request_protection_btn: "संरक्षणाची विनंती करा", call_helpline: "हेल्पलाइनवर কল करा", share_advisor_btn: "सल्लागारासोबत शेअर करा" },
                te: { greeting: "నమస్కారం, సునీతా దేవి", case_no: "కేసు నెం: SC-123-2024", next_step_title: "పోలీస్ స్టేషన్‌కు వెళ్లండి", next_step_subtitle: "వారికి ఈ FIR నంబర్‌ను చూపండి", timeline_title: "న్యాయ పంపిణీ టైమ్‌లైన్", stage_fir: "FIR దాఖలు", stage1_sub: "మీ ఫిర్యాదు అధికారికంగా నమోదు చేయబడింది.", stage2a_title: "దర్యాప్తు అప్పగించబడింది", stage2a_sub: "ఒక సీనియర్ అధికారి ఇప్పుడు బాధ్యత వహిస్తున్నారు.", stage2b_title: "మొదటి நிவாரண చెల్లింపు", stage2b_sub: "(FIR చేసిన 7 రోజులలోపు)", stage_chargesheet: "ఛార్జ్ షీట్ దాఖలు", stage3_sub: "(FIR చేసిన 60 రోజులలోపు)", stage4_title: "రెండవ நிவாரண చెల్లింపు", stage4_sub: "ఛార్జ్ షీట్ దాఖలు చేసిన తర్వాత.", stage5_title: "విచారణ జరుగుతోంది", stage6_title: "తుది తీర్పు", stage6_sub: "eCourts ద్వారా ధృవీకరించబడింది", stage_final_relief_title: "తుది நிவாரண చెల్లింపు", stage_final_relief_sub: "శిక్ష పడిన తర్వాత చెల్లించబడుతుంది.", event_stream_title: "కేసు ఈవెంట్ స్ట్రీమ్", evidence_vault_title: "సాక్ష్యాల ఖజానా", add_evidence: "సాక్ష్యం జోడించండి", financial_title: "మీ ఆర్థిక హక్కులు", financial_total: "మొత్తం హక్కు", travel_log_title: "కోర్టు విచారణ ప్రయాణ భత్యం", log_travel_btn: "ప్రయాణ ఖర్చులను లాగ్ చేయండి", tab_officials: "మీ అధికారులను తెలుసుకోండి", tab_witness: "సాక్షి మద్దతు", tab_rights: "మీ హక్కులు", community_safety_title: "కమ్యూనిటీ భద్రతా సెట్టింగ్‌లు", community_safety_toggle: "కమ్యూనిటీ భద్రతా హెచ్చరికలను ప్రారంభించండి", report_title: "సమస్యను నివేదించండి", submit: "సమర్పించు", protection_banner_text: "మీరు లేదా మీ సాక్షులు బెదిరింపులకు గురవుతున్నారా?", request_protection_btn: "రక్షణను అభ్యర్థించండి", call_helpline: "హెల్ప్‌లైన్‌కు కాల్ చేయండి", share_advisor_btn: "సలహాదారుతో పంచుకోండి" }
            };
            
            // --- Consolidated App Logic ---

            const setLanguage = (lang) => {
                appState.currentLang = lang;
                document.querySelectorAll('[data-lang-key]').forEach(el => {
                    const key = el.getAttribute('data-lang-key');
                    const translation = (translations[lang] && translations[lang][key]) || translations['en'][key];
                    if (translation) {
                        el.innerText = translation;
                    }
                });
            };

            function updateCountdown() {
                const now = new Date();
                const reliefCountdownEl = document.getElementById('relief-countdown');
                const chargesheetCountdownEl = document.getElementById('chargesheet-countdown');
                const reliefDeadline = new Date(caseData.fir.datetime.getTime() + 7 * 24 * 60 * 60 * 1000);
                const chargesheetDeadline = new Date(caseData.fir.datetime.getTime() + 60 * 24 * 60 * 60 * 1000);

                [reliefCountdownEl, chargesheetCountdownEl].forEach((el, index) => {
                    if (!el) return;
                    const deadline = index === 0 ? reliefDeadline : chargesheetDeadline;
                    let diff = deadline - now;
                    if (diff > 0) {
                        const d = Math.floor(diff / (1000*60*60*24));
                        const h = Math.floor((diff % (1000*60*60*24)) / (1000*60*60));
                        el.textContent = `${d}d ${h}h left`;
                        el.classList.remove('overdue');
                    } else {
                        const daysOverdue = Math.floor(Math.abs(diff) / (1000*60*60*24));
                        el.textContent = `OVERDUE by ${daysOverdue} Days`;
                        el.classList.add('overdue');
                    }
                });
            }
            
            function createDetailItem(label, value) { return `<div class="detail-item"><span class="detail-label">${label}</span><span class="detail-value">${value}</span></div>`; }

            function initializeEventStream() {
                const eventStreamEl = document.getElementById('event-stream');
                if (!eventStreamEl) return;
                eventStreamEl.innerHTML = '';
                const now = new Date();
                const events = [
                    { ts: new Date(now.getTime() - 5 * 60000), desc: "Document 'Caste_Cert.pdf' successfully uploaded." },
                    { ts: new Date(now.getTime() - 360 * 60000), desc: "Official A. K. Sharma viewed your case file." },
                    { ts: new Date(now.getTime() - 1440 * 60000), desc: "First relief payment of ₹2,06,250 was disbursed." }
                ];

                events.forEach(event => {
                    const li = document.createElement('li');
                    li.className = 'event-item';
                    const minutesAgo = Math.round((now - event.ts) / 60000);
                    let timeAgo = `${minutesAgo} mins ago`;
                    if (minutesAgo >= 1440) { timeAgo = `${Math.round(minutesAgo / 1440)} days ago`; } 
                    else if (minutesAgo >= 60) { timeAgo = `${Math.round(minutesAgo / 60)} hours ago`; }
                    li.innerHTML = `<div class="timestamp">${timeAgo}</div><div class="description">${event.desc}</div>`;
                    eventStreamEl.appendChild(li);
                });
            }
            
            function initializeTimeline() {
                const nextHearingEl = document.getElementById('next-hearing-subtext');
                if (nextHearingEl) {
                    nextHearingEl.textContent = `Next Hearing: ${new Date(caseData.trial.nextHearing).toLocaleDateString()}`;
                }
                if (caseData.judgment.verdict === "Conviction") {
                    const finalReliefStage = document.getElementById('final-relief-stage');
                    if(finalReliefStage) finalReliefStage.classList.remove('hidden');
                }
            }

            function initializeLanguageCircle() {
                const languageCircleMenu = document.getElementById('language-circle-menu');
                if(!languageCircleMenu) return;
                languageCircleMenu.innerHTML = '';
                const angleStep = 360 / appState.languages.length;
                const radius = 85;
                appState.languages.forEach((lang, index) => {
                    const angle = angleStep * index - 90;
                    const x = radius * Math.cos(angle * Math.PI / 180);
                    const y = radius * Math.sin(angle * Math.PI / 180);
                    const option = document.createElement('div');
                    option.className = 'language-option';
                    option.textContent = lang.toUpperCase();
                    option.dataset.lang = lang;
                    const transformValue = `translate(${x}px, ${y}px)`;
                    option.style.transform = transformValue;
                    option.style.setProperty('--initial-transform', transformValue);
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        setLanguage(lang);
                        localStorage.setItem('language', lang);
                        languageCircleMenu.classList.remove('visible');
                    });
                    languageCircleMenu.appendChild(option);
                });
            }

            function addUserMessage(text) {
                const chatMessages = document.getElementById('chat-messages');
                const el = document.createElement('div');
                el.className = 'chat-message user-message';
                el.innerText = text;
                chatMessages.appendChild(el);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function addBotMessage(text) {
                const chatMessages = document.getElementById('chat-messages');
                const el = document.createElement('div');
                el.className = 'chat-message bot-message';
                el.innerHTML = text;
                chatMessages.appendChild(el);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function showTypingIndicator() {
                const chatMessages = document.getElementById('chat-messages');
                const typingEl = document.createElement('div');
                typingEl.id = 'typing-indicator';
                typingEl.className = 'chat-message bot-message typing-indicator';
                typingEl.innerHTML = '<span></span><span></span><span></span>';
                chatMessages.appendChild(typingEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function hideTypingIndicator() {
                const typingEl = document.getElementById('typing-indicator');
                if (typingEl) typingEl.remove();
            }

            function handleChatSubmit(e) {
                e.preventDefault();
                const chatInput = document.getElementById('chat-input');
                const userInput = chatInput.value.trim();
                if (userInput) {
                    addUserMessage(userInput);
                    handleUserQuery(userInput);
                    chatInput.value = '';
                }
            }

            function handleFileUpload(e) {
                const file = e.target.files[0];
                if (file) {
                    addUserMessage(`Uploading ${file.name}...`);
                    showTypingIndicator();
                    setTimeout(() => {
                        hideTypingIndicator();
                        addBotMessage("Thank you for the document.");
                    }, 1500);
                }
            }
            
            async function handleUserQuery(query, isVoiceMode = false) {
                if(!isVoiceMode) showTypingIndicator();
                
                const systemPrompt = `You are Nyay Sahayak, an AI assistant for victims of caste-based atrocities in India under the PoA/PCR Acts. Your user is Sunita Devi. Her case number is SC-123-2024. Your tone is empathetic, simple, and reassuring. Use the provided case data to answer questions. Current case data is: ${JSON.stringify(caseData)}`;

                const payload = {
                    contents: [{ parts: [{ text: query }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API error: ${response.status} ${response.statusText} - ${errorBody}`);
                    }

                    const result = await response.json();
                    const botResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if(!isVoiceMode) hideTypingIndicator();

                    if (botResponse) {
                        if (isVoiceMode) {
                            speak(botResponse);
                        } else {
                            addBotMessage(botResponse);
                        }
                    } else {
                        const errorMessage = "Sorry, I could not process your request at this moment.";
                        if(isVoiceMode) speak(errorMessage);
                        else addBotMessage(errorMessage);
                    }
                } catch (error) {
                    if(!isVoiceMode) hideTypingIndicator();
                    console.error("Gemini API call failed:", error);
                    const errorMessage = "Sorry, I'm having trouble connecting. Please check your API key or network and try again.";
                    if(isVoiceMode) speak(errorMessage);
                    else addBotMessage(errorMessage);
                }
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;

            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const isVoiceMode = !document.getElementById('voice-mode-overlay').classList.contains('hidden');
                    if(isVoiceMode) {
                        document.getElementById('voice-status-text').textContent = `You said: "${transcript}"`;
                        handleUserQuery(transcript, true);
                    } else {
                        document.getElementById('chat-input').value = transcript;
                    }
                };
                
                recognition.onend = () => {
                    const isVoiceMode = !document.getElementById('voice-mode-overlay').classList.contains('hidden');
                    if(!isVoiceMode) {
                       document.getElementById('mic-btn').classList.remove('listening');
                    }
                };
            }
            
            function startSpeechRecognition(isVoiceOnly = false) {
                if (recognition) {
                    if (isVoiceOnly) {
                        document.getElementById('voice-status-text').textContent = "Listening...";
                    } else {
                        document.getElementById('mic-btn').classList.add('listening');
                    }
                    const langMap = { 'en': 'en-US', 'hi': 'hi-IN', 'bho': 'hi-IN', 'ta': 'ta-IN', 'bn': 'bn-IN', 'mr': 'mr-IN', 'te': 'te-IN' };
                    recognition.lang = langMap[appState.currentLang] || 'en-US';
                    recognition.start();
                } else {
                    alert("Voice recognition is not supported in your browser.");
                }
            }

            function speak(text) {
                const utterance = new SpeechSynthesisUtterance(text);
                const langMap = { 'en': 'en-US', 'hi': 'hi-IN' };
                utterance.lang = langMap[appState.currentLang] || 'en-US';
                utterance.onstart = () => {
                    document.getElementById('voice-status-text').textContent = "Speaking...";
                };
                utterance.onend = () => {
                    // Automatically listen for the next command
                    startSpeechRecognition(true);
                };
                speechSynthesis.speak(utterance);
            }

            function enterVoiceMode() {
                document.getElementById('voice-mode-overlay').classList.remove('hidden');
                speak("Voice mode activated. How can I help you?");
            }

            function exitVoiceMode() {
                speechSynthesis.cancel();
                if(recognition) recognition.stop();
                document.getElementById('voice-mode-overlay').classList.add('hidden');
            }


            function setupEventListeners() {
                document.getElementById('theme-toggle').addEventListener('click', () => { 
                    const isDark = document.body.classList.toggle('dark-mode');
                    document.getElementById('theme-toggle').innerHTML = `<i data-lucide="${isDark ? 'sun' : 'moon'}"></i>`;
                    lucide.createIcons();
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                });
                
                document.getElementById('lang-toggle').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.getElementById('language-circle-menu').classList.toggle('visible');
                });
                document.body.addEventListener('click', () => document.getElementById('language-circle-menu').classList.remove('visible'));

                document.querySelectorAll('.journey-stage').forEach(stage => {
                     stage.addEventListener('click', () => {
                        const modalId = stage.dataset.modal;
                        if (!modalId) return;
                        const modal = document.getElementById(modalId);
                        const modalContentEl = modal.querySelector('.modal-content');
                        
                        const modalContents = {
                             'fir-details-modal': `<h3>FIR Details</h3>` + createDetailItem('FIR Number', caseData.fir.number) + createDetailItem('Date & Time', caseData.fir.datetime.toLocaleString()) + createDetailItem('Police Station', caseData.fir.station) + createDetailItem('Sections Applied', caseData.fir.sections),
                             'investigation-details-modal': `<h3>Investigation</h3>` + createDetailItem('Investigating Officer', caseData.investigation.officer) + createDetailItem('Rank', `${caseData.investigation.rank} ${caseData.investigation.isValid ? '✅' : '❌'}`),
                             'relief1-details-modal': `<h3>First Relief</h3>` + createDetailItem('Amount Due', caseData.relief1.amount) + createDetailItem('Status', caseData.relief1.status),
                             'relief2-details-modal': `<h3>Second Relief</h3>` + createDetailItem('Amount Due', caseData.relief2.amount) + createDetailItem('Status', caseData.relief2.status),
                             'trial-details-modal': `<h3>Trial Details</h3>` + createDetailItem('Next Hearing', new Date(caseData.trial.nextHearing).toLocaleString()) + createDetailItem('Hearing History', caseData.trial.history),
                             'judgment-details-modal': `<h3>Final Judgment</h3>` + createDetailItem('Verdict', caseData.judgment.verdict) + createDetailItem('Date of Judgment', new Date(caseData.judgment.date).toLocaleDateString()) + `<button class="btn-full" style="margin-top: 20px;"><i data-lucide="download" style="vertical-align: middle; margin-right: 8px;"></i>Download Court Order</button>`,
                             'relief-final-details-modal': `<h3>Final Relief</h3>` + createDetailItem('Amount Due', caseData.reliefFinal.amount) + createDetailItem('Status', caseData.reliefFinal.status),
                        };
                        if (modalContents[modalId]) {
                           modalContentEl.innerHTML = modalContents[modalId];
                           lucide.createIcons();
                        }
                        modal.classList.add('active');
                    });
                });
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });
                });
                document.getElementById('help-fab').addEventListener('click', () => document.getElementById('help-modal').classList.add('active'));
                
                document.getElementById('ai-fab').addEventListener('click', () => document.getElementById('chat-container').classList.add('active'));
                document.getElementById('chat-close-btn').addEventListener('click', () => document.getElementById('chat-container').classList.remove('active'));
                document.getElementById('chat-form').addEventListener('submit', handleChatSubmit);
                document.getElementById('file-upload-btn').addEventListener('click', () => document.getElementById('file-upload-input').click());
                document.getElementById('file-upload-input').addEventListener('change', handleFileUpload);
                document.getElementById('mic-btn').addEventListener('click', () => startSpeechRecognition(false));

                 document.querySelectorAll('.tab-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const tabId = button.dataset.tab;
                        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                        document.getElementById(tabId).classList.add('active');
                    });
                });

                // Voice Mode Listeners
                document.getElementById('voice-mode-toggle').addEventListener('click', enterVoiceMode);
                document.getElementById('exit-voice-mode-btn').addEventListener('click', exitVoiceMode);
            }
            
            // --- App Initialization ---
            function init() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                const themeToggle = document.getElementById('theme-toggle');
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-mode');
                    if(themeToggle) themeToggle.innerHTML = `<i data-lucide="sun"></i>`;
                } else {
                    if(themeToggle) themeToggle.innerHTML = `<i data-lucide="moon"></i>`;
                }
                
                const savedLang = localStorage.getItem('language') || 'en';
                setLanguage(savedLang);
                
                initializeEventStream();
                initializeTimeline();
                initializeLanguageCircle();
                setupEventListeners();
                setInterval(updateCountdown, 60000);
                updateCountdown();
                
                lucide.createIcons();
            }
            
            init();

        });
    </script>

</body>
</html>

