<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legal Aid Lifeline</title>
    <!-- Noto Sans Font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Light Mode (Default) */
            --bg-primary: #F7F7FF;
            --bg-card: #FFFFFF;
            --text-primary: #1C1C1C;
            --text-secondary: #555;
            --border-color: #E0E0E0;
            --header-bg: rgba(247, 247, 247, 0.8);
            --chat-bg: #FFFFFF;
            --chat-input-bg: #F0F0F0;
            --bot-message-bg: #E7F0FA;

            /* Accents */
            --accent-action: #0056b3;
            --accent-action-glow: rgba(0, 86, 179, 0.2);
            --accent-success: #28a745;
            --accent-alert: #dc3545;
            --accent-help: #ffc107;
            --bg-action-light: #E7F0FA;
        }

        body.dark-mode {
            --bg-primary: #000000;
            --bg-card: #1A1A1A;
            --text-primary: #FFFFFF;
            --text-secondary: #AAAAAA;
            --border-color: #333333;
            --header-bg: rgba(0, 0, 0, 0.7);
            --chat-bg: #121212;
            --chat-input-bg: #2C2C2C;
            --bot-message-bg: #0A1929;
        }

        body {
            font-family: 'Noto Sans', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            font-size: 18px;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 16px;
        }

        .main-content {
            padding-top: 100px;
            /* Space for fixed header */
            padding-bottom: 180px;
            /* Space for FABs and protection banner */
        }

        /* --- 1. Header --- */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background-color: var(--header-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-identity .name {
            font-size: 18px;
            font-weight: 700;
        }

        .header-identity .case-no {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .header-controls {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .control-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-primary);
            padding: 0;
        }

        /* --- Language Circle Meter --- */
        #language-selector-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .language-circle {
            position: absolute;
            top: calc(100% + 15px);
            /* Position below the header */
            right: 0;
            /* Align to the right of the container */
            width: 200px;
            height: 200px;
            pointer-events: none;
            opacity: 0;
            transform-origin: top right;
            /* Animate from the top right corner */
            transform: scale(0.5);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
            z-index: 1001;
        }

        .language-circle.visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: all;
        }

        .language-option {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 44px;
            height: 44px;
            margin: -22px 0 0 -22px;
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid var(--accent-action);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .language-option:hover {
            background-color: var(--accent-action);
            color: white;
            transform: var(--initial-transform) scale(1.15) !important;
        }


        /* --- Generic Card Style --- */
        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            transition: background-color 0.3s, border-color 0.3s;
        }

        h2.card-title {
            font-size: 22px;
            margin-bottom: 20px;
        }

        h5.card-subtitle {
            font-size: 16px;
            margin-top: -10px;
            margin-bottom: 15px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }


        .hidden {
            display: none !important;
        }

        /* --- 2. Action Card --- */
        .action-card {
            background-color: var(--bg-action-light);
            text-align: center;
            border-color: var(--accent-action);
            box-shadow: 0 0 20px var(--accent-action-glow);
        }

        body.dark-mode .action-card {
            background-color: #0A1929;
        }

        .action-card-icon {
            color: var(--accent-action);
            margin-bottom: 16px;
        }

        .action-card-instruction {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .action-card-subtext {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .voice-note-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-primary);
            vertical-align: middle;
            margin-left: 8px;
        }

        .btn-full {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            background-color: var(--accent-action);
            color: white;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
        }

        .btn-full:disabled {
            background-color: #888;
            cursor: not-allowed;
        }

        .btn-alert {
            background-color: var(--accent-alert);
        }

        .btn-success {
            background-color: var(--accent-success);
        }

        /* --- Redesigned Journey Map --- */
        .journey-map {
            position: relative;
            padding-left: 20px;
        }

        .journey-line {
            position: absolute;
            left: 43px;
            top: 0;
            bottom: 0;
            width: 6px;
            background-color: var(--border-color);
            border-radius: 3px;
        }

        .journey-stage {
            display: flex;
            align-items: flex-start;
            position: relative;
            padding-left: 80px;
            margin-bottom: 30px;
            cursor: pointer;
        }

        .journey-node {
            position: absolute;
            left: 20px;
            top: 5px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-secondary);
        }

        .journey-stage.completed .journey-node {
            background-color: var(--accent-success);
            border-color: var(--accent-success);
            color: white;
        }

        .journey-stage.active .journey-node,
        .journey-stage.verifying .journey-node {
            background-color: var(--accent-action);
            border-color: var(--accent-action);
            color: white;
            animation: pulse 2s infinite;
        }

        .journey-details-title {
            font-weight: 700;
            font-size: 18px;
        }

        .journey-details-sub {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .ecourts-badge {
            font-size: 12px;
            background-color: var(--accent-action);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            margin-left: 8px;
        }

        .countdown-clock {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-action);
            margin-top: 8px;
            background-color: var(--bg-action-light);
            padding: 8px;
            border-radius: 6px;
            display: inline-block;
        }

        body.dark-mode .countdown-clock {
            background-color: #0A1929;
        }

        .countdown-clock.overdue {
            color: var(--accent-alert);
            background-color: #FFE3E3;
        }

        body.dark-mode .countdown-clock.overdue {
            background-color: #4D1212;
        }

        .sub-stage {
            margin-left: -50px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .sub-stage .journey-node {
            width: 36px;
            height: 36px;
            left: 26px;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 86, 179, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(0, 86, 179, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 86, 179, 0);
            }
        }

        /* --- 4. DBT Hub / Financial Rights --- */
        .financial-total {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .progress-bar {
            height: 12px;
            background-color: var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-bar-fill {
            height: 100%;
            width: 25%;
            background-color: var(--accent-success);
            border-radius: 6px;
        }

        .ledger-item {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .ledger-item:last-child {
            border-bottom: none;
        }

        .ledger-details {
            flex-grow: 1;
        }

        .ledger-amount {
            font-weight: 700;
            font-size: 18px;
        }

        .ledger-status {
            display: block;
            font-size: 14px;
            margin-top: 4px;
        }

        .ledger-actions {
            flex-shrink: 0;
            margin-left: 16px;
        }

        .status-paid {
            color: var(--accent-success);
        }

        .status-disbursed {
            color: var(--accent-action);
        }

        .status-pending {
            color: var(--text-secondary);
        }

        .bank-status-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bg-primary);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 14px;
        }

        .status-badge-unlinked {
            background-color: #FFE3E3;
            color: var(--accent-alert);
            border: 1px solid var(--accent-alert);
        }

        .status-badge-verifying {
            background-color: #FFF9C4;
            color: #F57F17;
            border: 1px solid #F57F17;
        }

        .status-badge-verified {
            background-color: #EAF6EC;
            color: var(--accent-success);
            border: 1px solid var(--accent-success);
        }

        .dbt-flow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: center;
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 20px;
        }

        .dbt-flow-item {
            flex: 1;
        }

        .dbt-flow-icon {
            margin: 0 auto 4px;
        }

        .dbt-flow-arrow {
            flex-shrink: 0;
            color: var(--border-color);
        }


        /* --- Feature 5: Chronological Evidence Vault --- */
        .evidence-controls {
            display: flex;
            gap: 12px;
            margin-top: -10px;
            margin-bottom: 20px;
        }

        .evidence-btn {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid var(--accent-action);
            background: none;
            color: var(--accent-action);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .evidence-btn:hover {
            background-color: var(--bg-action-light);
        }

        #evidence-vault {
            padding: 0;
        }

        .evidence-timeline {
            display: flex;
            overflow-x: auto;
            gap: 16px;
            padding: 16px;
            min-height: 150px;
        }

        .evidence-card {
            flex: 0 0 220px;
            background-color: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }

        .evidence-card .timestamp {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .evidence-card .media-icon {
            text-align: center;
            margin-bottom: 8px;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .evidence-card .caption {
            font-size: 15px;
            font-style: italic;
            white-space: normal;
        }

        .evidence-card .ai-summary {
            font-size: 13px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
        }

        /* --- Feature 1: AI FIR Sanity Check --- */
        #fir-sanity-check {
            border-left: 4px solid var(--accent-action);
        }

        .sanity-check-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .sanity-check-item .icon-success {
            color: var(--accent-success);
        }

        .sanity-check-item .icon-warning {
            color: var(--accent-help);
        }

        .sanity-check-item .icon-error {
            color: var(--accent-alert);
        }

        /* --- Feature 2: Immutable Event Stream --- */
        .event-stream-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .event-item {
            display: flex;
            gap: 16px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-item .timestamp {
            font-size: 14px;
            color: var(--text-secondary);
            width: 120px;
            flex-shrink: 0;
        }

        .event-item .description {
            font-size: 16px;
        }

        /* --- Feature 4: Know Your Officials Directory --- */
        #officials-content .officials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .official-card {
            text-align: center;
        }

        .official-card img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            border: 2px solid var(--border-color);
        }

        .official-card .name {
            font-weight: 700;
        }

        .official-card .rank {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* --- Feature 6: Automated Travel & Expense Log --- */
        #travel-log-card {
            background-color: var(--bg-action-light);
        }

        body.dark-mode #travel-log-card {
            background-color: #0A1929;
        }

        .travel-log-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 4px 16px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .travel-log-item:last-child {
            border-bottom: none;
        }

        .travel-log-route {
            font-weight: 700;
            grid-column: 1 / 2;
        }

        .travel-log-amount {
            font-weight: 700;
            font-size: 20px;
            grid-column: 2 / 3;
            grid-row: 1 / 3;
            align-self: center;
        }

        .travel-log-details {
            font-size: 14px;
            color: var(--text-secondary);
            grid-column: 1 / 2;
        }

        /* --- Feature 8: Community Alerts --- */
        .toggle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-example {
            font-size: 14px;
            font-style: italic;
            color: var(--text-secondary);
            background-color: var(--bg-primary);
            padding: 8px;
            border-radius: 4px;
            margin-top: 12px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 700;
            font-size: 16px;
        }

        .form-group select,
        .form-group textarea,
        .form-group input {
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px;
            font-family: 'Noto Sans', sans-serif;
            box-sizing: border-box;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .error-message {
            color: var(--accent-alert);
            font-size: 14px;
            margin-top: 4px;
        }

        /* --- Feature 10: Post-Case Rehabilitation --- */
        #path-to-recovery .schemes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .scheme-card {
            background-color: var(--bg-primary);
            padding: 16px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .scheme-card-title {
            font-weight: 700;
            margin-bottom: 8px;
        }

        .scheme-card-desc {
            font-size: 15px;
            margin-bottom: 12px;
        }

        /* --- Feature 3: Dynamic Witness Protection Request --- */
        .protection-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-card);
            border-top: 2px solid var(--accent-alert);
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 999;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
        }

        #legal-support-card {
            border-left: 4px solid var(--accent-success);
        }

        .lawyer-profile {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .lawyer-profile img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
        }

        .lawyer-info .name {
            font-weight: bold;
            font-size: 20px;
        }

        .lawyer-info .title {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        /* --- Voice Only Mode --- */
        #voice-mode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        #voice-mode-overlay:not(.hidden) {
            opacity: 1;
            visibility: visible;


        }

        .mismatch-link {
            font-size: 12px;
            color: var(--text-secondary);
            text-decoration: underline;
            cursor: pointer;
            margin-top: 8px;
            display: inline-block;
        }

        .voice-mic-icon {
            width: 128px;
            height: 128px;
            margin-bottom: 24px;
            animation: pulse-mic 2s infinite ease-in-out;
        }

        #voice-status-text {
            font-size: 22px;
            font-weight: 700;
        }

        #exit-voice-mode-btn {
            margin-top: 40px;
            padding: 12px 24px;
            font-size: 18px;
            background-color: var(--accent-alert);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }


        /* --- Modals and FABs --- */
        .fab {
            position: fixed;
            bottom: 90px;
            right: 30px;
            width: 60px;
            height: 60px;
            background-color: var(--accent-help);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 1001;
            animation: pulse-fab 2.5s infinite;
        }

        .ai-fab {
            position: fixed;
            bottom: 90px;
            left: 30px;
            width: 60px;
            height: 60px;
            background-color: var(--accent-action);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 1001;
            color: white;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            text-align: left;
        }

        .modal-content h3 {
            font-size: 20px;
            margin-top: 0;
        }

        .modal-content .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-content .detail-item:last-child {
            border-bottom: none;
        }

        .modal-content .detail-label {
            color: var(--text-secondary);
        }

        .modal-content .detail-value {
            font-weight: 700;
        }

        .modal-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 16px;
            font-size: 18px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            margin-bottom: 16px;
        }

        .modal-btn:last-child {
            margin-bottom: 0;
        }

        #share-link-modal .generated-link {
            background-color: var(--bg-primary);
            padding: 12px;
            border-radius: 8px;
            font-family: monospace;
            word-break: break-all;
            margin-bottom: 16px;
        }

        .consent-check {
            margin-top: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        #calculator-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* --- Chat styles --- */
        .chat-container {
            position: fixed;
            bottom: 160px;
            left: 30px;
            width: 90%;
            max-width: 400px;
            height: 60vh;
            max-height: 500px;
            background-color: var(--chat-bg);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: scale(0.95) translateY(20px);
            opacity: 0;
            visibility: hidden;
            transition: transform 0.3s ease, opacity 0.3s ease, visibility 0.3s;
            z-index: 1002;
        }

        .chat-container.active {
            transform: scale(1) translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .chat-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-primary);
        }

        .chat-messages {
            flex-grow: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-message {
            padding: 10px 14px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.4;
        }

        .user-message {
            background-color: var(--accent-action);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .bot-message {
            background-color: var(--bot-message-bg);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-secondary);
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1.0);
            }
        }

        .chat-input-form {
            display: flex;
            padding: 12px;
            border-top: 1px solid var(--border-color);
            gap: 8px;
        }

        #chat-input {
            flex-grow: 1;
            border: none;
            background-color: var(--chat-input-bg);
            border-radius: 20px;
            padding: 10px 16px;
            font-family: 'Noto Sans', sans-serif;
            font-size: 16px;
            color: var(--text-primary);
        }

        #chat-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-action);
        }

        .chat-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
        }

        .chat-action-btn:hover {
            color: var(--accent-action);
        }

        .chat-action-btn.listening {
            color: var(--accent-alert);
            animation: pulse-mic 1.5s infinite;
        }

        @keyframes pulse-mic {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        #file-upload-input {
            display: none;
        }

        .chat-action-button {
            background-color: var(--bg-card);
            border: 1px solid var(--accent-action);
            color: var(--accent-action);
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            margin-top: 8px;
            display: inline-block;
            font-weight: 700;
        }

        /* Protections and other feature styles... */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent-action);
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 16px;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-family: 'Noto Sans', sans-serif;
            font-size: 16px;
            font-weight: 700;
            border-bottom: 4px solid transparent;
        }

        .tab-btn.active {
            color: var(--text-primary);
            border-bottom-color: var(--accent-action);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* --- Responsive Design Adjustments --- */
        @media (max-width: 768px) {
            body {
                font-size: 16px;
                /* Adjust base font size for smaller screens */
            }

            .container {
                padding: 0 8px;
                /* Reduce side padding */
            }

            .main-content {
                padding-top: 80px;
                /* Less space for a smaller header */
                padding-bottom: 200px;
                /* More space for stacked bottom elements */
            }

            .header {
                padding: 12px 8px;
            }

            .header-identity .name {
                font-size: 16px;
            }

            .card {
                padding: 16px;
                margin-bottom: 16px;
            }

            h2.card-title {
                font-size: 20px;
            }

            .journey-stage {
                padding-left: 60px;
                /* Adjust timeline padding */
            }

            .journey-node {
                left: 0;
                width: 40px;
                height: 40px;
            }

            .journey-line {
                left: 19px;
                /* Re-center the timeline */
            }

            .sub-stage {
                margin-left: -35px;
            }

            .sub-stage .journey-node {
                width: 30px;
                height: 30px;
                left: 4px;
            }

            /* Adjust FABs to be less intrusive */
            .fab,
            .ai-fab {
                width: 50px;
                height: 50px;
                bottom: 100px;
                /* Position above the protection banner */
            }

            .fab {
                right: 15px;
            }

            .ai-fab {
                left: 15px;
            }

            /* Handle the chat window on mobile */
            .chat-container {
                left: 5%;
                width: 90%;
                max-width: none;
                bottom: 90px;
                max-height: 65vh;
            }

            .protection-banner {
                flex-direction: column;
                /* Stack banner content */
                text-align: center;
                gap: 12px;
                padding: 12px;
            }

            .protection-banner p {
                margin: 0;
            }

            .evidence-timeline {
                padding: 8px;
            }

            .evidence-card {
                flex: 0 0 180px;
                /* Make evidence cards a bit smaller */
            }

            /* Ensure grids stack to a single column */
            #officials-content .officials-grid,
            #path-to-recovery .schemes-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>

    <!-- 1. Header -->
    <header class="header">
        <div class="header-identity">
            <div class="name" data-lang-key="greeting">Namaste, Sunita Devi</div>
            <div class="case-no" data-lang-key="case_no">Case No: SC-123-2024</div>
        </div>
        <div class="header-controls">
            <button class="control-btn" id="voice-mode-toggle" aria-label="Toggle Voice Mode"><i
                    data-lucide="mic"></i></button>
            <div id="language-selector-wrapper">
                <button class="control-btn" id="lang-toggle" aria-label="Switch Language"><i
                        data-lucide="languages"></i></button>
                <div id="language-circle-menu" class="language-circle">
                    <!-- Language options will be injected here by JS -->
                </div>
            </div>
            <button class="control-btn" id="theme-toggle" aria-label="Toggle light/dark mode"><i
                    data-lucide="sun"></i></button>
        </div>
    </header>

    <main class="main-content">
        <div class="container">

            <div id="case-active-content">
                <!-- 2. "What's Next?" Action Card -->
                <section class="card action-card">
                    <div class="action-card-icon"><i data-lucide="shield" style="width:64px; height:64px;"></i></div>
                    <h2 class="action-card-instruction" data-lang-key="next_step_title">Go to the Police Station</h2>
                    <div class="action-card-subtext" data-lang-key="next_step_subtitle">Show them this FIR number:
                        123-456-7890</div>
                    <button class="voice-note-btn" aria-label="Play instruction audio"><i
                            data-lucide="play-circle"></i></button>
                </section>

                <!-- Legal Support Card (Initially hidden) -->
                <section class="card hidden" id="legal-support-card">
                    <h2 class="card-title">Legal Support Assigned</h2>
                    <div class="lawyer-profile">
                        <img src="https://placehold.co/100x100/EAF6EC/28a745?text=LA" alt="Legal Aid Lawyer">
                        <div class="lawyer-info">
                            <div class="name">Advocate Priya Sharma</div>
                            <div class="title">Legal Aid Counsel</div>
                            <button class="btn-full btn-success" style="width: auto; padding: 10px 20px;">
                                <i data-lucide="phone" style="vertical-align: middle; margin-right: 8px;"></i>Call Now
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Redesigned Justice Delivery Timeline -->
                <section class="card" id="journey-map-card">
                    <h2 class="card-title" data-lang-key="timeline_title">Justice Delivery Timeline</h2>
                    <div class="journey-map">
                        <div class="journey-line"></div>

                        <!-- START: MODIFICATION -->
                        <!-- Stage 1: FIR Registered -->
                        <div class="journey-stage" data-stage-id="fir-registered">
                            <div class="journey-node"><i data-lucide="check"></i></div>
                            <div class="journey-details">
                                <div class="journey-details-title" data-lang-key="stage_fir">FIR Registered</div>
                                <div class="journey-details-sub" data-lang-key="stage1_sub">Your complaint is officially
                                    recorded.</div>
                                <div class="mismatch-link" data-lang-key="report_mismatch">Report Mismatch</div>
                            </div>
                        </div>

                        <!-- Stage 2: Investigation & Initial Relief -->
                        <div class="journey-stage" data-stage-id="investigation-relief">
                            <div class="journey-node" style="visibility: hidden;"></div>
                            <!-- Placeholder for alignment -->
                            <div class="journey-details" style="width: 100%;">
                                <!-- Sub-Node 2A -->
                                <div class="journey-stage sub-stage" data-stage-id="investigation-assigned">
                                    <div class="journey-node"><i data-lucide="search"></i></div>
                                    <div class="journey-details">
                                        <div class="journey-details-title" data-lang-key="stage2a_title">Investigation
                                            Assigned</div>
                                        <div class="journey-details-sub" data-lang-key="stage2a_sub">A senior officer is
                                            now in charge.</div>
                                        <div class="mismatch-link" data-lang-key="report_mismatch">Report Mismatch</div>
                                    </div>
                                </div>
                                <!-- Sub-Node 2B -->
                                <div class="journey-stage sub-stage" data-stage-id="relief1-paid">
                                    <div class="journey-node"><i data-lucide="indian-rupee"></i></div>
                                    <div class="journey-details">
                                        <div class="journey-details-title" data-lang-key="stage2b_title">First Relief
                                            Payment</div>
                                        <div class="journey-details-sub" data-lang-key="stage2b_sub">(Due within 7 Days
                                            of FIR)</div>
                                        <div class="countdown-clock" id="relief-countdown">--d --h --m --s</div>
                                        <div class="mismatch-link" data-lang-key="report_mismatch">Report Mismatch</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stage 3: Charge Sheet Filed -->
                        <div class="journey-stage" data-stage-id="chargesheet-filed" data-verifiable="true">
                            <div class="journey-node"><i data-lucide="gavel"></i></div>
                            <div class="journey-details">
                                <div class="journey-details-title" data-lang-key="stage_chargesheet">Charge Sheet Filed
                                </div>
                                <div class="journey-details-sub" data-lang-key="stage3_sub">(Due within 60 Days of FIR)
                                </div>
                                <div class="countdown-clock" id="chargesheet-countdown">--d --h --m --s</div>
                                <div class="mismatch-link" data-lang-key="report_mismatch">Report Mismatch</div>
                            </div>
                        </div>

                        <!-- Stage 4: Second Relief Payment -->
                        <div class="journey-stage" data-stage-id="relief2-paid">
                            <div class="journey-node"><i data-lucide="indian-rupee"></i></div>
                            <div class="journey-details">
                                <div class="journey-details-title" data-lang-key="stage4_title">Second Relief Payment
                                </div>
                                <div class="journey-details-sub" data-lang-key="stage4_sub">Triggered after charge sheet
                                    is filed.</div>
                                <div class="mismatch-link" data-lang-key="report_mismatch">Report Mismatch</div>
                            </div>
                        </div>

                        <!-- Stage 5: Trial in Special Court -->
                        <div class="journey-stage" data-stage-id="trial-progress" data-verifiable="true">
                            <div class="journey-node"><i data-lucide="calendar"></i></div>
                            <div class="journey-details">
                                <div class="journey-details-title">
                                    <span data-lang-key="stage5_title">Trial in Progress</span>
                                    <span class="ecourts-badge">eCourts</span>
                                </div>
                                <div class="journey-details-sub" id="next-hearing-subtext"></div>
                                <div class="mismatch-link" data-lang-key="report_mismatch">Report Mismatch</div>
                            </div>
                        </div>

                        <!-- Stage 6: Final Judgment & Final Relief -->
                        <div class="journey-stage" data-stage-id="final-judgment" data-verifiable="true">
                            <div class="journey-node"><i data-lucide="scroll"></i></div>
                            <div class="journey-details">
                                <div class="journey-details-title">
                                    <span data-lang-key="stage6_title">Final Judgment</span>
                                    <span class="ecourts-badge">eCourts</span>
                                </div>
                                <div class="journey-details-sub" data-lang-key="stage6_sub">Verified by eCourts API
                                </div>
                                <div class="mismatch-link" data-lang-key="report_mismatch">Report Mismatch</div>
                            </div>
                        </div>

                        <!-- Conditional Final Payment Node -->
                        <div class="journey-stage hidden" id="final-relief-stage" data-stage-id="relief-final-paid">
                            <div class="journey-node"><i data-lucide="award"></i></div>
                            <div class="journey-details">
                                <div class="journey-details-title" data-lang-key="stage_final_relief_title">Final Relief
                                    Payment</div>
                                <div class="journey-details-sub" data-lang-key="stage_final_relief_sub">Payable upon
                                    conviction.</div>
                                <div class="mismatch-link" data-lang-key="report_mismatch">Report Mismatch</div>
                            </div>
                        </div>
                        <!-- END: MODIFICATION -->
                    </div>
                </section>
            </div>

            <!-- Feature 10: Post-Case Rehabilitation & Livelihood Connector -->
            <section class="card hidden" id="path-to-recovery">
                <h2 class="card-title" data-lang-key="recovery_title">Your Path to Recovery</h2>
                <p data-lang-key="recovery_desc">The court case has concluded. Here are some government schemes to
                    support you in the next phase of your life.</p>
                <div class="schemes-grid">
                    <div class="scheme-card">
                        <h3 class="scheme-card-title" data-lang-key="scheme_mgnrega_title">MGNREGA Employment</h3>
                        <p class="scheme-card-desc" data-lang-key="scheme_mgnrega_desc">Guaranteed 100 days of wage
                            employment in a financial year.</p>
                        <button class="btn-full" data-lang-key="apply_now">Apply Now</button>
                    </div>
                </div>
            </section>

            <!-- All Other Features Restored -->
            <section class="card">
                <h2 class="card-title" data-lang-key="event_stream_title">Case Event Stream</h2>
                <ul class="event-stream-list" id="event-stream"></ul>
            </section>

            <section class="card" id="evidence-vault">
                <h2 class="card-title" data-lang-key="evidence_vault_title">Chronological Evidence Vault</h2>
                <div class="evidence-controls">
                    <input type="file" id="evidence-file-input" class="hidden" accept="image/*">
                    <button class="evidence-btn" id="upload-evidence-btn"><i data-lucide="upload"></i><span
                            data-lang-key="upload_device">Upload from Device</span></button>
                    <button class="evidence-btn" id="digilocker-fetch-btn"><i data-lucide="shield-check"></i><span
                            data-lang-key="fetch_digilocker">Fetch from DigiLocker</span></button>
                </div>
                <div class="evidence-timeline" id="evidence-timeline">
                    <!-- Evidence cards will be dynamically inserted here -->
                </div>
            </section>
            <section class="card" id="relief-calculator-card">
                <h2 class="card-title" data-lang-key="relief_calculator_title">Relief Entitlement Calculator</h2>
                <p data-lang-key="relief_calculator_desc">Answer a few questions about the incident to get an estimate
                    of the financial assistance you are entitled to under the PoA/PCR Act norms.</p>
                <button class="btn-full" id="start-relief-calculation-btn" data-lang-key="start_calculation">Start
                    Calculation</button>
            </section>
            <section class="card hidden" id="fir-sanity-check">
                <h2 class="card-title">AI-Powered FIR Sanity Check</h2>
                <div id="fir-sanity-check-content"></div>
            </section>

            <section class="card" id="dbt-hub-card">
                <h2 class="card-title" data-lang-key="dbt_hub_title">Direct Benefit Transfer (DBT) Hub</h2>

                <h5 class="card-subtitle" data-lang-key="bank_account_title">Bank Account Status</h5>
                <div class="bank-status-container" id="bank-status-container">
                    <!-- Bank status content will be injected by JS -->
                </div>

                <h5 class="card-subtitle" data-lang-key="payment_ledger_title">Payment Ledger</h5>
                <div class="financial-total">8,25,000 <span style="font-size: 16px; font-weight: 400;"
                        data-lang-key="financial_total">Total Entitlement</span></div>
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="payment-progress-bar"></div>
                </div>
                <div id="payment-ledger">
                    <!-- Ledger items will be injected by JS -->
                </div>
                <h5 class="card-subtitle" style="margin-top:24px;" data-lang-key="dbt_flow_title">How DBT Works</h5>
                <div class="dbt-flow">
                    <div class="dbt-flow-item">
                        <div class="dbt-flow-icon"><i data-lucide="file-check-2"></i></div>
                        <div data-lang-key="dbt_flow1">Sanctioned by State</div>
                    </div>
                    <div class="dbt-flow-arrow"><i data-lucide="chevron-right"></i></div>
                    <div class="dbt-flow-item">
                        <div class="dbt-flow-icon"><i data-lucide="server"></i></div>
                        <div data-lang-key="dbt_flow2">Processed by PFMS</div>
                    </div>
                    <div class="dbt-flow-arrow"><i data-lucide="chevron-right"></i></div>
                    <div class="dbt-flow-item">
                        <div class="dbt-flow-icon"><i data-lucide="landmark"></i></div>
                        <div data-lang-key="dbt_flow3">Sent to Bank</div>
                    </div>
                    <div class="dbt-flow-arrow"><i data-lucide="chevron-right"></i></div>
                    <div class="dbt-flow-item">
                        <div class="dbt-flow-icon"><i data-lucide="wallet"></i></div>
                        <div data-lang-key="dbt_flow4">Credited to You</div>
                    </div>
                </div>
            </section>

            <section class="card" id="travel-log-card">
                <h2 class="card-title" data-lang-key="travel_log_title">Court Hearing Travel Allowance</h2>
                <div id="logged-travel-expenses">
                    <!-- Logged expenses will be dynamically inserted here -->
                </div>
                <button class="btn-full" id="log-travel-btn" data-lang-key="log_travel_btn">Log Travel &
                    Expenses</button>
            </section>
            <section class="card">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="officials-content" data-lang-key="tab_officials">Know Your
                        Officials</button>
                    <button class="tab-btn" data-tab="witness-content" data-lang-key="tab_witness">Witness
                        Support</button>
                    <button class="tab-btn" data-tab="rights-content" data-lang-key="tab_rights">Your Rights</button>
                </div>
                <div id="officials-content" class="tab-content active">
                    <div class="officials-grid">
                        <div class="official-card">
                            <img src="https://placehold.co/100x100/E7F0FA/0056b3?text=IO" alt="Investigating Officer">
                            <div class="name">A. K. Sharma</div>
                            <div class="rank">DSP</div>
                        </div>
                    </div>
                </div>
                <div id="witness-content" class="tab-content">
                    <div class="toggle-item">
                        <span data-lang-key="request_witness_protection">Request Witness Protection</span>
                        <label class="switch"><input type="checkbox"><span class="slider"></span></label>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4 data-lang-key="witness_rights_title">Your Rights as a Witness</h4>
                        <p data-lang-key="witness_rights_p1">As a witness, you have the right to be treated with dignity
                            and respect. You are entitled to protection from any harm, intimidation, or threat.</p>
                        <ul>
                            <li data-lang-key="witness_right_1">Right to a safe and secure waiting area at the court.
                            </li>
                            <li data-lang-key="witness_right_2">Right to receive travel and subsistence allowances for
                                court appearances.</li>
                            <li data-lang-key="witness_right_3">Right to request in-camera (private) proceedings if you
                                feel threatened.</li>
                        </ul>
                    </div>
                </div>
                <div id="rights-content" class="tab-content">
                    <h4 data-lang-key="victim_rights_title">Your Rights as a Victim/Survivor</h4>
                    <p data-lang-key="victim_rights_p1">Under the Scheduled Castes and the Scheduled Tribes (Prevention
                        of Atrocities) Act, you have several rights to ensure justice and dignity:</p>
                    <ul>
                        <li data-lang-key="victim_right_1"><strong>Right to Free Legal Aid:</strong> You are entitled to
                            free legal services from the District/State Legal Services Authority.</li>
                        <li data-lang-key="victim_right_2"><strong>Right to Information:</strong> You have the right to
                            be informed about the status of your case at every stage.</li>
                        <li data-lang-key="victim_right_3"><strong>Right to Relief and Rehabilitation:</strong> You are
                            entitled to timely monetary relief and other rehabilitation measures as prescribed by the
                            government.</li>
                        <li data-lang-key="victim_right_4"><strong>Right to a Speedy Trial:</strong> Cases under this
                            Act are to be tried in Special Courts for expeditious disposal.</li>
                        <li data-lang-key="victim_right_5"><strong>Right to be Treated with Dignity:</strong> All
                            proceedings should be conducted in a way that respects your dignity and privacy.</li>
                    </ul>
                    <h5 class="card-subtitle" data-lang-key="poa_act_title">About the PoA Act, 1989</h5>
                    <p data-lang-key="poa_act_desc">The Prevention of Atrocities (PoA) Act is a special law to prevent
                        crimes against Scheduled Castes (SCs) and Scheduled Tribes (STs). It lists specific offenses,
                        such as forcing someone to eat an inedible substance, social or economic boycott, or sexual
                        exploitation, and provides for stringent punishments.</p>
                    <h5 class="card-subtitle" data-lang-key="pcr_act_title">About the PCR Act, 1955</h5>
                    <p data-lang-key="pcr_act_desc">The Protection of Civil Rights (PCR) Act deals with the offense of
                        "untouchability." It makes it illegal to prevent any person from entering a place of public
                        worship, accessing shops or public restaurants, or using any public utilities on the grounds of
                        untouchability.</p>
                </div>
            </section>
            <section class="card">
                <h2 class="card-title" data-lang-key="community_safety_title">Community Safety Settings</h2>
                <div class="toggle-item">
                    <span data-lang-key="community_safety_toggle">Enable Safety Alerts (WhatsApp, Push, IVR
                        Calls)</span>
                    <label class="switch"><input type="checkbox" id="community-alerts-toggle"><span
                            class="slider"></span></label>
                </div>
                <div class="alert-example hidden" id="whatsapp-support-link" style="margin-top: 12px;">
                    <b>Whatsapp support:</b> <a href="https://wa.me/911234567890" target="_blank"
                        style="color: var(--accent-action);">Click here to chat</a>
                </div>
            </section>
            <section class="card">
                <h2 class="card-title" data-lang-key="report_title">Report an Issue</h2>
                <form id="report-issue-form">
                    <div class="form-group">
                        <label for="issue-category" data-lang-key="issue_category_label">Category</label>
                        <select id="issue-category" name="issue-category">
                            <option value="delay" data-lang-key="issue_cat_delay">Delay in Relief Payment</option>
                            <option value="threat" data-lang-key="issue_cat_threat">Threat from Accused</option>
                            <option value="info" data-lang-key="issue_cat_info">Incorrect Information in App</option>
                            <option value="other" data-lang-key="issue_cat_other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="issue-details" data-lang-key="issue_details_label">Details</label>
                        <textarea id="issue-details" name="issue-details" data-lang-placeholder-key="report_placeholder"
                            placeholder="..."></textarea>
                    </div>
                    <button type="submit" class="btn-full" data-lang-key="submit">Submit</button>
                </form>
            </section>
        </div>
    </main>

    <!-- Modals & Banners -->
    <div class="protection-banner" id="protection-banner">
        <p data-lang-key="protection_banner_text">Are you or your witnesses being threatened?</p>
        <button class="btn-full btn-alert" style="width: auto;" id="request-protection-btn"
            data-lang-key="request_protection_btn">Request Protection</button>
    </div>

    <div class="modal-overlay" id="help-modal">
        <div class="modal-content" style="text-align:center;">
            <button class="modal-btn"><i data-lucide="phone"></i><span data-lang-key="call_helpline">Call
                    Helpline</span></button>
            <button class="modal-btn"><i data-lucide="gavel"></i><span data-lang-key="connect_lawyer">Connect to a
                    Lawyer</span></button>
            <button class="modal-btn"><i data-lucide="users"></i><span data-lang-key="contact_ngo">Contact an
                    NGO</span></button>
            <button class="modal-btn" id="share-link-btn"><i data-lucide="share-2"></i><span
                    data-lang-key="share_advisor_btn">Share with Advisor</span></button>
        </div>
    </div>
    <div class="modal-overlay" id="protection-confirm-modal">
        <div class="modal-content">
            <h3 data-lang-key="confirm_protection_title">Confirm Protection Request</h3>
            <p data-lang-key="confirm_protection_desc">This will send a high-priority alert to the DM and SP.</p>
            <button class="btn-full btn-alert" id="confirm-protection-final" data-lang-key="confirm_protection_btn">I
                Confirm, Send Alert</button>
            <button class="modal-btn" style="margin-top: 12px;" id="cancel-protection"
                data-lang-key="cancel">Cancel</button>
        </div>
    </div>
    <div class="modal-overlay" id="share-link-modal">
        <div class="modal-content">
            <h3 data-lang-key="share_link_title">Secure Link</h3>
            <p data-lang-key="share_link_desc">This link is valid for 24 hours.</p>
            <div class="generated-link">https://nyay.gov/case/s-123/view?token=...</div>
            <button class="btn-full" id="close-share-modal" data-lang-key="close">Close</button>
        </div>
    </div>
    <div class="modal-overlay" id="travel-log-modal">
        <div class="modal-content">
            <h3 data-lang-key="travel_modal_title">Log Travel Expenses</h3>
            <div id="travel-step-1">
                <form id="travel-form">
                    <div class="form-group">
                        <label for="travel-from" data-lang-key="travel_from_label">From</label>
                        <input type="text" id="travel-from" data-lang-placeholder-key="travel_from_placeholder"
                            placeholder="e.g., Your current location" required>
                    </div>
                    <div class="form-group">
                        <label for="travel-to" data-lang-key="travel_to_label">To</label>
                        <input type="text" id="travel-to" data-lang-placeholder-key="travel_to_placeholder"
                            placeholder="e.g., Tis Hazari Court, Delhi" required>
                    </div>
                    <button type="submit" class="btn-full" data-lang-key="calculate">Calculate Allowance</button>
                </form>
            </div>
            <div id="travel-step-2" class="hidden">
                <h4 data-lang-key="travel_details_title">Confirm Travel Details</h4>
                <div class="detail-item">
                    <span class="detail-label" data-lang-key="estimated_distance_range">Estimated Distance Range</span>
                    <span class="detail-value" id="results-distance-range"></span>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label for="actual-distance" data-lang-key="actual_distance_label">Enter Actual Distance (in
                        km)</label>
                    <input type="number" id="actual-distance" step="0.1" required>
                    <div class="error-message hidden" id="distance-error"></div>
                </div>
                <div class="detail-item" style="font-size: 20px;">
                    <span class="detail-label" data-lang-key="calculated_allowance">Calculated Allowance</span>
                    <b class="detail-value" id="results-allowance">0.00</b>
                </div>
                <button class="btn-full" style="margin-top: 20px;" id="confirm-travel-log"
                    data-lang-key="confirm_log_expense">Confirm & Log Expense</button>
            </div>
        </div>
    </div>
    <!-- Add Evidence Modal -->
    <div class="modal-overlay" id="add-evidence-modal">
        <div class="modal-content">
            <h3 data-lang-key="add_evidence_title">Add New Evidence</h3>
            <form id="add-evidence-form">
                <div class="form-group">
                    <label for="evidence-caption" data-lang-key="evidence_caption_label">Caption</label>
                    <textarea id="evidence-caption" required data-lang-placeholder-key="evidence_caption_placeholder"
                        placeholder="Briefly describe the evidence..."></textarea>
                </div>
                <div class="consent-check">
                    <input type="checkbox" id="ai-consent-checkbox">
                    <label for="ai-consent-checkbox" data-lang-key="ai_consent_label">Allow AI to process this document
                        to extract key information.</label>
                </div>
                <button type="submit" class="btn-full" style="margin-top: 20px;" data-lang-key="upload_submit">Upload
                    and Save</button>
            </form>
        </div>
    </div>

    <!-- DigiLocker Modal -->
    <div class="modal-overlay" id="digilocker-modal">
        <div class="modal-content">
            <h3 data-lang-key="digilocker_title">Connect to DigiLocker</h3>
            <p data-lang-key="digilocker_desc">To securely fetch documents, this application needs to connect to your
                DigiLocker account. This requires a secure server-to-server connection.</p>
            <p data-lang-key="digilocker_redirect_info">Clicking below will redirect you to DigiLocker to authorize this
                application. You will be redirected back to complete the process.</p>
            <button class="btn-full" id="proceed-to-digilocker" data-lang-key="digilocker_proceed_btn">Proceed to
                DigiLocker</button>
            <button class="modal-btn" id="simulate-digilocker-fetch" style="margin-top: 12px; font-size: 16px;"
                data-lang-key="digilocker_simulate_btn">Run Simulation Instead</button>
        </div>
    </div>

    <!-- Relief Calculator Modal -->
    <div class="modal-overlay" id="relief-calculator-modal">
        <div class="modal-content">
            <h3 data-lang-key="relief_calculator_modal_title">Relief Entitlement Calculator</h3>
            <div id="calculator-content">
                <!-- Questions and results will be injected here -->
            </div>
            <div id="calculator-options" style="margin-top: 20px;">
                <!-- Answer buttons will be injected here -->
            </div>
            <button class="modal-btn" id="restart-calculator-btn" style="margin-top: 12px; font-size: 16px;"
                data-lang-key="restart_calculation">Restart</button>
        </div>
    </div>

    <!-- Bank Account Modal -->
    <div class="modal-overlay" id="bank-account-modal">
        <div class="modal-content">
            <h3 data-lang-key="link_bank_account_title">Link Bank Account</h3>
            <p data-lang-key="link_bank_account_desc">Please provide your bank account details for DBT. This information
                is stored securely.</p>
            <form id="bank-account-form">
                <div class="form-group">
                    <label for="bank-account-number" data-lang-key="account_number_label">Account Number</label>
                    <input type="text" id="bank-account-number" required pattern="\d{9,18}"
                        title="Account number should be 9 to 18 digits.">
                </div>
                <div class="form-group">
                    <label for="bank-ifsc-code" data-lang-key="ifsc_code_label">IFSC Code</label>
                    <input type="text" id="bank-ifsc-code" required pattern="[A-Z]{4}0[A-Z0-9]{6}"
                        title="Please enter a valid 11-character IFSC code.">
                </div>
                <button type="submit" class="btn-full" data-lang-key="verify_save_btn">Verify & Save</button>
            </form>
        </div>
    </div>
    <!-- START: MODIFICATION -->
    <!-- Stage Completion Modal -->
    <div class="modal-overlay" id="stage-confirm-modal">
        <div class="modal-content">
            <h3 data-lang-key="stage_confirm_title">Update Status</h3>
            <p id="stage-confirm-text"></p>
            <button class="btn-full btn-success" id="confirm-stage-completion" data-lang-key="stage_confirm_yes">Yes,
                Mark as Complete</button>
            <button class="modal-btn" style="margin-top: 12px;" id="cancel-stage-completion"
                data-lang-key="cancel">Cancel</button>
        </div>
    </div>

    <!-- Mismatch Ticket Modal -->
    <div class="modal-overlay" id="mismatch-ticket-modal">
        <div class="modal-content">
            <h3 data-lang-key="mismatch_ticket_title">Report a Mismatch</h3>
            <form id="mismatch-ticket-form">
                <p id="mismatch-stage-name" class="font-semibold mb-2"></p>
                <div class="form-group">
                    <label for="mismatch-details" data-lang-key="mismatch_details_label">Please describe the
                        issue</label>
                    <textarea id="mismatch-details" required data-lang-placeholder-key="mismatch_placeholder"
                        placeholder="Explain what is incorrect about the current status..."></textarea>
                </div>
                <button type="submit" class="btn-full" data-lang-key="submit_ticket">Submit Ticket</button>
            </form>
        </div>
    </div>
    <!-- END: MODIFICATION -->

    <!-- Timeline Modals -->
    <div class="modal-overlay" id="fir-details-modal">
        <div class="modal-content" id="modal-fir-content"></div>
    </div>
    <div class="modal-overlay" id="investigation-details-modal">
        <div class="modal-content" id="modal-investigation-content"></div>
    </div>
    <div class="modal-overlay" id="relief1-details-modal">
        <div class="modal-content" id="modal-relief1-content"></div>
    </div>
    <div class="modal-overlay" id="chargesheet-details-modal">
        <div class="modal-content">
            <h3>Charge Sheet</h3>
            <p>Pending...</p>
        </div>
    </div>
    <div class="modal-overlay" id="relief2-details-modal">
        <div class="modal-content" id="modal-relief2-content"></div>
    </div>
    <div class="modal-overlay" id="trial-details-modal">
        <div class="modal-content" id="modal-trial-content"></div>
    </div>
    <div class="modal-overlay" id="judgment-details-modal">
        <div class="modal-content" id="modal-judgment-content"></div>
    </div>
    <div class="modal-overlay" id="relief-final-details-modal">
        <div class="modal-content" id="modal-relief-final-content"></div>
    </div>

    <!-- FABs and Chat -->
    <div class="fab" id="help-fab"><i data-lucide="help-circle"></i></div>
    <div class="ai-fab" id="ai-fab"><i data-lucide="bot"></i></div>
    <div class="chat-container" id="chat-container">
        <div class="chat-header"><span>Nyay Sahayak AI</span><button class="chat-header-close" id="chat-close-btn"><i
                    data-lucide="x"></i></button></div>
        <div class="chat-messages" id="chat-messages"></div>
        <form class="chat-input-form" id="chat-form">
            <input type="file" id="chat-file-upload-input" class="hidden" accept="image/*">
            <button type="button" class="chat-action-btn" id="chat-file-upload-btn" aria-label="Attach file"><i
                    data-lucide="paperclip"></i></button>
            <input type="text" id="chat-input" placeholder="Ask me anything..." autocomplete="off">
            <button type="button" class="chat-action-btn" id="mic-btn" aria-label="Use voice"><i
                    data-lucide="mic"></i></button>
            <button type="submit" class="chat-action-btn" aria-label="Send message"><i data-lucide="send"></i></button>
        </form>
    </div>

    <!-- Voice Only Mode Overlay -->
    <div id="voice-mode-overlay" class="hidden">
        <div class="voice-content">
            <i data-lucide="mic" class="voice-mic-icon"></i>
            <p id="voice-status-text">Listening...</p>
            <button id="exit-voice-mode-btn">Exit Voice Mode</button>
        </div>
    </div>


    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.js"></script>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-functions.js";


        document.addEventListener("DOMContentLoaded", () => {
            // --- Firebase Config ---
            // Use the config provided by the environment, with a fallback for local development
            const firebaseConfig = {
                apiKey: "AIzaSyCOveO-NFW_X5FkINfh5KMgCBBMlOej8M4",
                authDomain: "student-dashboard-4ec02.firebaseapp.com",
                projectId: "student-dashboard-4ec02",
                storageBucket: "student-dashboard-4ec02.firebasestorage.app",
                messagingSenderId: "250478137189",
                appId: "1:250478137189:web:bbd2014b95b0f14d4edb8c",
                measurementId: "G-JYZCG7X3WS"
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const functions = getFunctions(app);
            const appId = firebaseConfig.appId || firebaseConfig.appId || 'default-app';

            // --- Gemini API Key ---
            const GEMINI_API_KEY = "AIzaSyBKIy8ScHv6JqVJAMuTibo7ikvBzMSfwXo";

            // --- App State, Data, and Translations ---
            let reliefConversationHistory = [];
            const appState = {
                languages: ['en', 'hi', 'bho', 'ta', 'bn', 'mr', 'te'],
                currentLang: 'en',
                currentFile: null,
                userId: null,
                digilockerEvidence: [],
                journeyStatus: {}, // Will be populated from Firestore
            };
            const caseData = {
                cnr: "DLCT010012342024", // Case Number for eCourts
                fir: { number: "123-456", datetime: new Date(new Date().getTime() - 80 * 24 * 60 * 60 * 1000), station: "Noida Sec 24", sections: "IPC 323, PoA 3(1)(r)" },
                investigation: { officer: "A. K. Sharma", rank: "DSP", isValid: true },
                relief1: { amount: "2,06,250", status: "Pending" },
                relief2: { amount: "4,12,500", status: "Pending" },
                trial: { nextHearing: "2025-12-10T11:00:00", history: "15-11-2025: Appearance" },
                judgment: { verdict: "Conviction", date: "2026-03-01" },
                reliefFinal: { amount: "2,06,250", status: "Pending" }
            };
            const translations = {
                en: {
                    greeting: "Namaste, Sunita Devi", case_no: "Case No: SC-123-2024", next_step_title: "Go to the Police Station", next_step_subtitle: "Show them this FIR number: 123-456-7890", timeline_title: "Justice Delivery Timeline", stage_fir: "FIR Registered", stage1_sub: "Your complaint is officially recorded.", stage2a_title: "Investigation Assigned", stage2a_sub: "A senior officer is now in charge.", stage2b_title: "First Relief Payment", stage2b_sub: "(Due within 7 Days of FIR)", stage_chargesheet: "Charge Sheet Filed", stage3_sub: "(Due within 60 Days of FIR)", stage4_title: "Second Relief Payment", stage4_sub: "Triggered after charge sheet is filed.", stage5_title: "Trial in Progress", stage6_title: "Final Judgment", stage6_sub: "Verified by eCourts API", stage_final_relief_title: "Final Relief Payment", stage_final_relief_sub: "Payable upon conviction.", recovery_title: "Your Path to Recovery", recovery_desc: "The court case has concluded. Here are some government schemes to support you.", scheme_mgnrega_title: "MGNREGA Employment", scheme_mgnrega_desc: "Guaranteed 100 days of wage employment.", apply_now: "Apply Now", event_stream_title: "Case Event Stream", evidence_vault_title: "Chronological Evidence Vault", add_evidence: "Add Evidence",
                    dbt_hub_title: "Direct Benefit Transfer (DBT) Hub", bank_account_title: "Bank Account Status", payment_ledger_title: "Payment Ledger", dbt_flow_title: "How DBT Works",
                    financial_total: "Total Entitlement", payment_item1_desc: "25% on FIR/Chargesheet", status_paid: "PAID", status_pending: "PENDING",
                    travel_log_title: "Court Hearing Travel Allowance", travel_log_desc: "You are entitled to a travel allowance for your upcoming hearing.", log_travel_btn: "Log Travel & Expenses", tab_officials: "Know Your Officials", tab_witness: "Witness Support", tab_rights: "Your Rights", community_safety_title: "Community Safety Settings", community_safety_toggle: "Enable Safety Alerts (WhatsApp, Push, IVR Calls)", report_title: "Report an Issue", report_placeholder: "Tell us what is wrong...", submit: "Submit", protection_banner_text: "Are you or your witnesses being threatened?", request_protection_btn: "Request Protection", call_helpline: "Call Helpline", share_advisor_btn: "Share with Advisor", connect_lawyer: "Connect to a Lawyer", contact_ngo: "Contact an NGO",
                    request_witness_protection: "Request Witness Protection", witness_rights_title: "Your Rights as a Witness", witness_rights_p1: "As a witness, you have the right to be treated with dignity and respect. You are entitled to protection from any harm, intimidation, or threat.", witness_right_1: "Right to a safe and secure waiting area at the court.", witness_right_2: "Right to receive travel and subsistence allowances for court appearances.", witness_right_3: "Right to request in-camera (private) proceedings if you feel threatened.",
                    victim_rights_title: "Your Rights as a Victim/Survivor", victim_rights_p1: "Under the Scheduled Castes and the Scheduled Tribes (Prevention of Atrocities) Act, you have several rights to ensure justice and dignity:", victim_right_1: "<strong>Right to Free Legal Aid:</strong> You are entitled to free legal services from the District/State Legal Services Authority.", victim_right_2: "<strong>Right to Information:</strong> You have the right to be informed about the status of your case at every stage.", victim_right_3: "<strong>Right to Relief and Rehabilitation:</strong> You are entitled to timely monetary relief and other rehabilitation measures as prescribed by the government.", victim_right_4: "<strong>Right to a Speedy Trial:</strong> Cases under this Act are to be tried in Special Courts for expeditious disposal.", victim_right_5: "<strong>Right to be Treated with Dignity:</strong> All proceedings should be conducted in a way that respects your dignity and privacy.",
                    poa_act_title: "About the PoA Act, 1989", poa_act_desc: "The Prevention of Atrocities (PoA) Act is a special law to prevent crimes against Scheduled Castes (SCs) and Scheduled Tribes (STs). It lists specific offenses, such as forcing someone to eat an inedible substance, social or economic boycott, or sexual exploitation, and provides for stringent punishments.", pcr_act_title: "About the PCR Act, 1955", pcr_act_desc: "The Protection of Civil Rights (PCR) Act deals with the offense of 'untouchability.' It makes it illegal to prevent any person from entering a place of public worship, accessing shops or public restaurants, or using any public utilities on the grounds of untouchability.",
                    issue_category_label: "Category", issue_cat_delay: "Delay in Relief Payment", issue_cat_threat: "Threat from Accused", issue_cat_info: "Incorrect Information in App", issue_cat_other: "Other", issue_details_label: "Details",
                    travel_modal_title: "Log Travel Expenses", travel_from_label: "From", travel_from_placeholder: "e.g., Your current location", travel_to_label: "To", travel_to_placeholder: "e.g., Tis Hazari Court, Delhi", calculate: "Calculate Allowance", calculating: "Calculating...", travel_details_title: "Confirm Travel Details", estimated_distance_range: "Estimated Distance Range", actual_distance_label: "Enter Actual Distance (in km)", calculated_allowance: "Calculated Allowance", confirm_log_expense: "Confirm & Log Expense", distance_error_text: "Please enter a distance within the suggested range.",
                    add_evidence_title: "Add New Evidence", evidence_caption_label: "Caption", evidence_caption_placeholder: "Briefly describe the evidence...", ai_consent_label: "Allow AI to process this document to extract key information.", upload_submit: "Upload and Save", upload_processing: "Processing with AI...",
                    digilocker_title: "Connect to DigiLocker", digilocker_desc: "To securely fetch documents, this application needs to connect to your DigiLocker account. This requires a secure server-to-server connection.", digilocker_redirect_info: "Clicking below will redirect you to DigiLocker to authorize this application. You will be redirected back to complete the process.", digilocker_proceed_btn: "Proceed to DigiLocker", digilocker_simulate_btn: "Run Simulation Instead",
                    upload_device: "Upload from Device", fetch_digilocker: "Fetch from DigiLocker",
                    confirm_protection_title: "Confirm Protection Request", confirm_protection_desc: "This will send a high-priority alert to the DM and SP.", confirm_protection_btn: "I Confirm, Send Alert", cancel: "Cancel",
                    share_link_title: "Secure Link", share_link_desc: "This link is valid for 24 hours.", close: "Close",
                    relief_calculator_title: "Relief Entitlement Calculator", relief_calculator_desc: "Answer a few questions about the incident to get an estimate of the financial assistance you are entitled to under the PoA/PCR Act norms.", start_calculation: "Start Calculation",
                    relief_calculator_modal_title: "Relief Entitlement Calculator", restart_calculation: "Restart",
                    fetch_ecourts_status: "Fetch Latest Status", fetching: "Fetching...",
                    dbt_flow1: "Sanctioned by State", dbt_flow2: "Processed by PFMS", dbt_flow3: "Sent to Bank", dbt_flow4: "Credited to You",
                    link_bank_account: "Link Bank Account", link_bank_account_title: "Link Bank Account", link_bank_account_desc: "Please provide your bank account details for DBT. This information is stored securely.",
                    account_number_label: "Account Number", ifsc_code_label: "IFSC Code", verify_save_btn: "Verify & Save",
                    bank_status_unlinked: "Not Linked", bank_status_verifying: "Verifying...", bank_status_verified: "Verified",
                    payment_status_pending: "Pending", payment_status_disbursed: "Disbursed by State", payment_status_credited: "Credited to Account",
                    track_payment: "Track Payment",
                    report_mismatch: "Report Mismatch", // Add comma to the previous last line
                    no_evidence: "No evidence uploaded yet.",
                    stage_confirm_question: "Have you completed this step?",
                    stage_confirm_title: "Update Status",
                    stage_confirm_yes: "Yes, Mark as Complete",
                    mismatch_ticket_title: "Report a Mismatch",
                    mismatch_details_label: "Please describe the issue",
                    mismatch_placeholder: "Explain what is incorrect about the current status...",
                    submit_ticket: "Submit Ticket"
                },
                hi: {
                    greeting: ",  ", case_no: " : SC-123-2024", next_step_title: "  ", next_step_subtitle: "    ", timeline_title: "  ", stage_fir: " ", stage1_sub: "      ", stage2a_title: "  ", stage2a_sub: "     ", stage2b_title: "  ", stage2b_sub: "(  7    )", stage_chargesheet: "  ", stage3_sub: "(  60    )", stage4_title: "  ", stage4_sub: "       ", stage5_title: "   ", stage6_title: " ", stage6_sub: "-   ", stage_final_relief_title: "  ", stage_final_relief_sub: "  ", event_stream_title: " ", evidence_vault_title: " ", add_evidence: " ",
                    dbt_hub_title: "   (DBT) ", bank_account_title: "  ", payment_ledger_title: " ", dbt_flow_title: "DBT    ",
                    financial_total: " ", travel_log_title: "   ", log_travel_btn: "    ", tab_officials: "   ", tab_witness: " ", tab_rights: " ", community_safety_title: "  ", community_safety_toggle: "    (, ,  )", report_title: "   ", submit: " ", protection_banner_text: "         ?", request_protection_btn: "   ", call_helpline: "   ", share_advisor_btn: "    ", connect_lawyer: "  ", contact_ngo: "   ",
                    request_witness_protection: "    ", witness_rights_title: "      ", witness_rights_p1: "    ,                 ,        ", witness_right_1: "      ", witness_right_2: "            ", witness_right_3: "       - ()      ",
                    victim_rights_title: " /     ", victim_rights_p1: "     ( )   ,            :", victim_right_1: "<strong>    :</strong>  /          ", victim_right_2: "<strong>  :</strong>                ", victim_right_3: "<strong>    :</strong>               ", victim_right_4: "<strong>   :</strong>              ", victim_right_5: "<strong>     :</strong>                 ",
                    poa_act_title: " , 1989   ", poa_act_desc: "  ()    ()    ()                  ,          ,    ,   ,       ", pcr_act_title: " , 1955   ", pcr_act_desc: "   ()  ''                    ,      ,             ",
                    issue_category_label: "", issue_cat_delay: "   ", issue_cat_threat: "  ", issue_cat_info: "   ", issue_cat_other: "", issue_details_label: "",
                    travel_modal_title: "   ", travel_from_label: "", travel_from_placeholder: ".,   ", travel_to_label: "", travel_to_placeholder: ".,   , ", calculate: "   ", calculating: "   ...", travel_details_title: "    ", estimated_distance_range: "  ", actual_distance_label: "    ( )", calculated_allowance: "   ", confirm_log_expense: "     ", distance_error_text: "        ",
                    add_evidence_title: "  ", evidence_caption_label: "", evidence_caption_placeholder: "    ...", ai_consent_label: "     AI         ", upload_submit: "   ", upload_processing: "AI   ...",
                    digilocker_title: "   ", digilocker_desc: "        ,                 --    ", digilocker_redirect_info: "                        ", digilocker_proceed_btn: "  ", digilocker_simulate_btn: "   ",
                    upload_device: "   ", fetch_digilocker: "   ",
                    confirm_protection_title: "    ", confirm_protection_desc: "      -   ", confirm_protection_btn: "   ,  ", cancel: " ",
                    share_link_title: " ", share_link_desc: "  24     ", close: " ",
                    relief_calculator_title: "  ", relief_calculator_desc: "           PoA/PCR           ", start_calculation: "  ",
                    relief_calculator_modal_title: "  ", restart_calculation: "  ",
                    fetch_ecourts_status: "   ", fetching: "   ...",
                    dbt_flow1: "  ", dbt_flow2: "PFMS  ", dbt_flow3: "   ", dbt_flow4: "   ",
                    link_bank_account: "   ", link_bank_account_title: "   ", link_bank_account_desc: " DBT                ",
                    account_number_label: " ", ifsc_code_label: "IFSC ", verify_save_btn: "   ",
                    bank_status_unlinked: "  ", bank_status_verifying: "   ...", bank_status_verified: "",
                    payment_status_pending: "", payment_status_disbursed: "  ", payment_status_credited: "    ",
                    track_payment: "  ",
                    report_mismatch: "   ", // Add comma to the previous last line
                    no_evidence: "        ",
                    stage_confirm_question: "       ?",
                    stage_confirm_title: "  ",
                    stage_confirm_yes: ",      ",
                    mismatch_ticket_title: "   ",
                    mismatch_details_label: "    ",
                    mismatch_placeholder: "         ...",
                    submit_ticket: "  "
                },

                
                
                bho: { greeting: ",  ", case_no: " : SC-123-2024", next_step_title: "  ", next_step_subtitle: "    ", timeline_title: "  ", stage_fir: "FIR   ", stage1_sub: "     ", stage2a_title: "  ", stage2a_sub: "     ", stage2b_title: "  ", stage2b_sub: "(FIR  7   )", stage_chargesheet: "   ", stage3_sub: "(FIR  60   )", stage4_title: "  ", stage4_sub: "   ", stage5_title: "   ", stage6_title: " ", stage6_sub: "-  ", stage_final_relief_title: "  ", stage_final_relief_sub: "  ", event_stream_title: "  ", evidence_vault_title: "  ", add_evidence: " ", financial_title: "  ", financial_total: " ", travel_log_title: "   ", log_travel_btn: " ", tab_officials: "  ", tab_witness: "  ", tab_rights: " ", community_safety_title: "  ", community_safety_toggle: "   ", report_title: " ", submit: " ", protection_banner_text: "        ?", request_protection_btn: " ", call_helpline: "   ", share_advisor_btn: "   ", connect_lawyer: "  ", contact_ngo: "NGO   ", report_mismatch: " ", stage_confirm_yes: ",    ", },


                ta: { greeting: ",  ", case_no: " : SC-123-2024", next_step_title: "  ", next_step_subtitle: " FIR  ", timeline_title: "  ", stage_fir: "FIR  ", stage1_sub: "   .", stage2a_title: " ", stage2a_sub: "   .", stage2b_title: "  ", stage2b_sub: "(FIR  7 )", stage_chargesheet: " ", stage3_sub: "(FIR  60 )", stage4_title: "  ", stage4_sub: "  .", stage5_title: " ", stage6_title: " ", stage6_sub: "eCourts  ", stage_final_relief_title: "  ", stage_final_relief_sub: "  .", event_stream_title: " ", evidence_vault_title: " ", add_evidence: " ", financial_title: "  ", financial_total: " ", travel_log_title: "  ", log_travel_btn: "   ", tab_officials: "  ", tab_witness: " ", tab_rights: " ", community_safety_title: " ", community_safety_toggle: "  ", report_title: " ", submit: "", protection_banner_text: "    ?", request_protection_btn: " ", call_helpline: "  ", share_advisor_btn: " ", connect_lawyer: " ", contact_ngo: "    ", report_mismatch: " ", stage_confirm_yes: ",  ", },
                bn: { greeting: ",  ", case_no: " : SC-123-2024", next_step_title: " ", next_step_subtitle: "    ", timeline_title: "  ", stage_fir: " ", stage1_sub: "   ", stage2a_title: " ", stage2a_sub: "    ", stage2b_title: "  ", stage2b_sub: "(    )", stage_chargesheet: " ", stage3_sub: "(    )", stage4_title: "  ", stage4_sub: "  ", stage5_title: " ", stage6_title: " ", stage6_sub: "eCourts  ", stage_final_relief_title: "  ", stage_final_relief_sub: "   ", event_stream_title: "  ", evidence_vault_title: " ", add_evidence: "  ", financial_title: "  ", financial_total: " ", travel_log_title: "   ", log_travel_btn: "   ", tab_officials: "  ", tab_witness: " ", tab_rights: " ", community_safety_title: "  ", community_safety_toggle: "  ", report_title: "  ", submit: " ", protection_banner_text: "       ?", request_protection_btn: "  ", call_helpline: "  ", share_advisor_btn: "    ", connect_lawyer: "   ", contact_ngo: "   ", report_mismatch: "  ", stage_confirm_yes: ",    ", },
                mr: { greeting: ",  ", case_no: " : SC-123-2024", next_step_title: "  ", next_step_subtitle: "    ", timeline_title: "  ", stage_fir: " ", stage1_sub: "    .", stage2a_title: " ", stage2a_sub: "     .", stage2b_title: "  ", stage2b_sub: "(   )", stage_chargesheet: " ", stage3_sub: "(   )", stage4_title: "  ", stage4_sub: "  .", stage5_title: "  ", stage6_title: " ", stage6_sub: "- ", stage_final_relief_title: "  ", stage_final_relief_sub: "  .", event_stream_title: "  ", evidence_vault_title: " ", add_evidence: " ", financial_title: "  ", financial_total: " ", travel_log_title: "   ", log_travel_btn: "  ", tab_officials: "   ", tab_witness: " ", tab_rights: " ", community_safety_title: "  ", community_safety_toggle: "    ", report_title: "  ", submit: " ", protection_banner_text: "       ?", request_protection_btn: "  ", call_helpline: "  ", share_advisor_btn: "  ", connect_lawyer: "  ", contact_ngo: "  ", report_mismatch: "  ", stage_confirm_yes: ",     " },
                te: { greeting: ",  ", case_no: " : SC-123-2024", next_step_title: "  ", next_step_subtitle: "  FIR  ", timeline_title: "  ", stage_fir: "FIR ", stage1_sub: "    .", stage2a_title: " ", stage2a_sub: "     .", stage2b_title: "  ", stage2b_sub: "(FIR  7 )", stage_chargesheet: "  ", stage3_sub: "(FIR  60 )", stage4_title: "  ", stage4_sub: "    .", stage5_title: " ", stage6_title: " ", stage6_sub: "eCourts  ", stage_final_relief_title: "  ", stage_final_relief_sub: "   .", event_stream_title: "  ", evidence_vault_title: " ", add_evidence: " ", financial_title: "  ", financial_total: " ", travel_log_title: "   ", log_travel_btn: "   ", tab_officials: "  ", tab_witness: " ", tab_rights: " ", community_safety_title: "  ", community_safety_toggle: "   ", report_title: " ", submit: "", protection_banner_text: "     ?", request_protection_btn: " ", call_helpline: "  ", share_advisor_btn: " ", connect_lawyer: "  ", contact_ngo: "NGO ", report_mismatch: " ", stage_confirm_yes: ",  ", },

                // Other language translations would be updated similarly...
            };

            // --- Main App Logic ---

            function setLanguage(lang) {
                appState.currentLang = lang;
                document.querySelectorAll('[data-lang-key]').forEach(el => {
                    const key = el.getAttribute('data-lang-key');
                    const translation = (translations[lang] && translations[lang][key]) || translations['en'][key];
                    if (translation) {
                        el.innerHTML = translation;
                    }
                });
                document.querySelectorAll('[data-lang-placeholder-key]').forEach(el => {
                    const key = el.getAttribute('data-lang-placeholder-key');
                    const translation = (translations[lang] && translations[lang][key]) || translations['en'][key];
                    if (translation) {
                        el.placeholder = translation;
                    }
                });
            }

            function updateCountdown() {
                const now = new Date();
                const reliefCountdownEl = document.getElementById('relief-countdown');
                const chargesheetCountdownEl = document.getElementById('chargesheet-countdown');
                const reliefDeadline = new Date(caseData.fir.datetime.getTime() + 7 * 24 * 60 * 60 * 1000);
                const chargesheetDeadline = new Date(caseData.fir.datetime.getTime() + 60 * 24 * 60 * 60 * 1000);

                [reliefCountdownEl, chargesheetCountdownEl].forEach((el, index) => {
                    if (!el) return;
                    const deadline = index === 0 ? reliefDeadline : chargesheetDeadline;
                    let diff = deadline - now;
                    if (diff > 0) {
                        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        el.textContent = `${d}d ${h}h left`;
                        el.classList.remove('overdue');
                    } else {
                        const daysOverdue = Math.floor(Math.abs(diff) / (1000 * 60 * 60 * 24));
                        el.textContent = `OVERDUE by ${daysOverdue} Days`;
                        el.classList.add('overdue');
                    }
                });
            }

            function createDetailItem(label, value) { return `<div class="detail-item"><span class="detail-label">${label}</span><span class="detail-value">${value}</span></div>`; }

            function initializeEventStream() {
                const eventStreamEl = document.getElementById('event-stream');
                if (!eventStreamEl) return;
                eventStreamEl.innerHTML = '';
                const now = new Date();
                const events = [
                    { ts: new Date(now.getTime() - 5 * 60000), desc: "Document 'Caste_Cert.pdf' successfully uploaded." },
                    { ts: new Date(now.getTime() - 360 * 60000), desc: "Official A. K. Sharma viewed your case file." },
                    { ts: new Date(now.getTime() - 1440 * 60000), desc: "First relief payment of 2,06,250 was disbursed." }
                ];

                events.forEach(event => {
                    const li = document.createElement('li');
                    li.className = 'event-item';
                    const minutesAgo = Math.round((now - event.ts) / 60000);
                    let timeAgo = `${minutesAgo} mins ago`;
                    if (minutesAgo >= 1440) { timeAgo = `${Math.round(minutesAgo / 1440)} days ago`; }
                    else if (minutesAgo >= 60) { timeAgo = `${Math.round(minutesAgo / 60)} hours ago`; }
                    li.innerHTML = `<div class="timestamp">${timeAgo}</div><div class="description">${event.desc}</div>`;
                    eventStreamEl.appendChild(li);
                });
            }

            function initializeTimeline() {
                const nextHearingEl = document.getElementById('next-hearing-subtext');
                if (nextHearingEl) {
                    nextHearingEl.textContent = `Next Hearing: ${new Date(caseData.trial.nextHearing).toLocaleDateString()}`;
                }
                if (caseData.judgment.verdict === "Conviction") {
                    const finalReliefStage = document.getElementById('final-relief-stage');
                    if (finalReliefStage) finalReliefStage.classList.remove('hidden');
                }
            }

            function renderTimeline(statusData) {
                document.querySelectorAll('.journey-stage[data-stage-id]').forEach(stage => {
                    const stageId = stage.dataset.stageId;
                    if (statusData[stageId]) {
                        stage.classList.remove('active', 'verifying');
                        stage.classList.add('completed');
                        const node = stage.querySelector('.journey-node');
                        if (node) node.innerHTML = `<i data-lucide="check"></i>`;
                    } else {
                        stage.classList.remove('completed');
                    }
                });

                // Set initial "active" state logic (can be more complex)
                const firstIncomplete = document.querySelector('.journey-stage:not(.completed)');
                if (firstIncomplete) {
                    // firstIncomplete.classList.add('active'); // This can be enabled for more explicit guidance
                }

                const nextHearingEl = document.getElementById('next-hearing-subtext');
                if (nextHearingEl) {
                    nextHearingEl.textContent = `Next Hearing: ${new Date(caseData.trial.nextHearing).toLocaleDateString()}`;
                }
                if (caseData.judgment.verdict === "Conviction") {
                    const finalReliefStage = document.getElementById('final-relief-stage');
                    if (finalReliefStage) finalReliefStage.classList.remove('hidden');
                }

                lucide.createIcons();
            }

            function initializeLanguageCircle() {
                const languageCircleMenu = document.getElementById('language-circle-menu');
                if (!languageCircleMenu) return;
                languageCircleMenu.innerHTML = '';
                const angleStep = 360 / appState.languages.length;
                const radius = 85;
                appState.languages.forEach((lang, index) => {
                    const angle = angleStep * index - 90;
                    const x = radius * Math.cos(angle * Math.PI / 180);
                    const y = radius * Math.sin(angle * Math.PI / 180);
                    const option = document.createElement('div');
                    option.className = 'language-option';
                    option.textContent = lang.toUpperCase();
                    option.dataset.lang = lang;
                    const transformValue = `translate(${x}px, ${y}px)`;
                    option.style.transform = transformValue;
                    option.style.setProperty('--initial-transform', transformValue);
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        setLanguage(lang);
                        localStorage.setItem('language', lang);
                        languageCircleMenu.classList.remove('visible');
                    });
                    languageCircleMenu.appendChild(option);
                });
            }

            function addUserMessage(text) {
                const chatMessages = document.getElementById('chat-messages');
                const el = document.createElement('div');
                el.className = 'chat-message user-message';
                el.innerText = text;
                chatMessages.appendChild(el);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function addBotMessage(text) {
                const chatMessages = document.getElementById('chat-messages');
                const el = document.createElement('div');
                el.className = 'chat-message bot-message';
                el.innerHTML = text;
                chatMessages.appendChild(el);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function showTypingIndicator() {
                const chatMessages = document.getElementById('chat-messages');
                const typingEl = document.createElement('div');
                typingEl.id = 'typing-indicator';
                typingEl.className = 'chat-message bot-message typing-indicator';
                typingEl.innerHTML = '<span></span><span></span><span></span>';
                chatMessages.appendChild(typingEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function hideTypingIndicator() {
                const typingEl = document.getElementById('typing-indicator');
                if (typingEl) typingEl.remove();
            }

            function handleChatSubmit(e) {
                e.preventDefault();
                const chatInput = document.getElementById('chat-input');
                const userInput = chatInput.value.trim();
                if (userInput) {
                    addUserMessage(userInput);
                    handleUserQuery(userInput);
                    chatInput.value = '';
                }
            }

            function handleFileUpload(e) {
                const file = e.target.files[0];
                if (file) {
                    addUserMessage(`Uploading ${file.name}...`);
                    showTypingIndicator();
                    setTimeout(() => {
                        hideTypingIndicator();
                        addBotMessage("Thank you for the document. I will review it shortly.");
                    }, 1500);
                }
            }

            async function handleUserQuery(query, isVoiceMode = false) {
                if (!isVoiceMode) showTypingIndicator();

                const systemPrompt = `You are Nyay Sahayak, an AI assistant for victims of caste-based atrocities in India under the PoA/PCR Acts. Your user is Sunita Devi. Her case number is SC-123-2024. Your tone is empathetic, simple, and reassuring. Use the provided case data to answer questions. Current case data is: ${JSON.stringify(caseData)}`;

                const payload = {
                    contents: [{ parts: [{ text: query }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API error: ${response.status} ${response.statusText} - ${errorBody}`);
                    }

                    const result = await response.json();
                    const botResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!isVoiceMode) hideTypingIndicator();

                    if (botResponse) {
                        if (isVoiceMode) {
                            speak(botResponse);
                        } else {
                            addBotMessage(botResponse);
                        }
                    } else {
                        const errorMessage = "Sorry, I could not process your request at this moment.";
                        if (isVoiceMode) speak(errorMessage);
                        else addBotMessage(errorMessage);
                    }
                } catch (error) {
                    if (!isVoiceMode) hideTypingIndicator();
                    console.error("Gemini API call failed:", error);
                    const errorMessage = "Sorry, I'm having trouble connecting. Please check your API key or network and try again.";
                    if (isVoiceMode) speak(errorMessage);
                    else addBotMessage(errorMessage);
                }
            }

            async function calculateTravelDetails(from, to, submitButton) {
                const userQuery = `Calculate a realistic travel distance range (min and max km) for a road trip from "${from}" to "${to}".`;
                const systemPrompt = `You are a travel calculation assistant. Your task is to calculate a travel distance range.`;
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                min_distance_km: { "type": "NUMBER", description: "The lower bound of the estimated distance in kilometers." },
                                max_distance_km: { "type": "NUMBER", description: "The upper bound of the estimated distance in kilometers." },
                            },
                            "required": ["min_distance_km", "max_distance_km"]
                        }
                    }
                };
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!jsonText) throw new Error("No response text from API");

                    const data = JSON.parse(jsonText);

                    if (data.min_distance_km > data.max_distance_km || data.min_distance_km <= 0) {
                        throw new Error("API returned an illogical distance range.");
                    }

                    const avgDistance = (data.min_distance_km + data.max_distance_km) / 2;
                    const actualDistanceInput = document.getElementById('actual-distance');
                    document.getElementById('results-distance-range').textContent = `${data.min_distance_km.toFixed(1)} km - ${data.max_distance_km.toFixed(1)} km`;
                    actualDistanceInput.min = data.min_distance_km.toFixed(1);
                    actualDistanceInput.max = data.max_distance_km.toFixed(1);
                    actualDistanceInput.value = avgDistance.toFixed(1);
                    actualDistanceInput.dispatchEvent(new Event('input')); // Trigger calculation
                    document.getElementById('travel-step-1').classList.add('hidden');
                    document.getElementById('travel-step-2').classList.remove('hidden');
                } catch (error) {
                    console.error("Gemini travel calculation failed:", error);
                    alert("Could not calculate distance. The locations might be too far or invalid. Please try again.");
                } finally {
                    submitButton.disabled = false;
                    setLanguage(appState.currentLang); // Reset button text
                }
            }

            async function extractInfoWithGemini(base64ImageData) {
                const userPrompt = "Analyze this image, which is a legal or official document from India (like a Caste Certificate, FIR, Aadhaar card, etc.). Extract key information such as Document Type, Full Name, Date of Issue, and any relevant ID or Case Numbers. Present the extracted information clearly.";

                const payload = {
                    contents: [{
                        parts: [
                            { text: userPrompt },
                            { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }
                        ]
                    }]
                };

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API error: ${response.status}`);
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.text || "Could not extract details.";
                } catch (error) {
                    console.error("Gemini image analysis failed:", error);
                    return "AI analysis failed. Please check the console for errors.";
                }
            }


            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const isVoiceMode = !document.getElementById('voice-mode-overlay').classList.contains('hidden');
                    if (isVoiceMode) {
                        document.getElementById('voice-status-text').textContent = `You said: "${transcript}"`;
                        handleUserQuery(transcript, true);
                    } else {
                        document.getElementById('chat-input').value = transcript;
                    }
                };
                recognition.onend = () => {
                    const isVoiceMode = !document.getElementById('voice-mode-overlay').classList.contains('hidden');
                    if (!isVoiceMode) {
                        document.getElementById('mic-btn').classList.remove('listening');
                    }
                };
            }

            function startSpeechRecognition(isVoiceOnly = false) {
                if (recognition) {
                    if (isVoiceOnly) {
                        document.getElementById('voice-status-text').textContent = "Listening...";
                    } else {
                        document.getElementById('mic-btn').classList.add('listening');
                    }
                    const langMap = { 'en': 'en-US', 'hi': 'hi-IN', 'bho': 'hi-IN', 'ta': 'ta-IN', 'bn': 'bn-IN', 'mr': 'mr-IN', 'te': 'te-IN' };
                    recognition.lang = langMap[appState.currentLang] || 'en-US';
                    recognition.start();
                } else {
                    alert("Voice recognition is not supported in your browser.");
                }
            }

            function speak(text) {
                const utterance = new SpeechSynthesisUtterance(text);
                const langMap = { 'en': 'en-US', 'hi': 'hi-IN' };
                utterance.lang = langMap[appState.currentLang] || 'en-US';
                utterance.onstart = () => { document.getElementById('voice-status-text').textContent = "Speaking..."; };
                utterance.onend = () => { startSpeechRecognition(true); };
                speechSynthesis.speak(utterance);
            }

            function enterVoiceMode() {
                document.getElementById('voice-mode-overlay').classList.remove('hidden');
                speak("Voice mode activated. How can I help you?");
            }

            function exitVoiceMode() {
                speechSynthesis.cancel();
                if (recognition) recognition.stop();
                document.getElementById('voice-mode-overlay').classList.add('hidden');
            }

            function getFromStorage(key) { return JSON.parse(localStorage.getItem(key) || '[]'); }
            function saveToStorage(key, data) { localStorage.setItem(key, JSON.stringify(data)); }

            // --- Evidence Vault Logic ---
            function renderEvidenceVault() {
                const localEvidence = getFromStorage('evidenceVault').map(item => ({ ...item, isLocal: true }));
                const digilockerEvidence = appState.digilockerEvidence.map(item => ({ ...item, isLocal: false }));

                const allEvidence = [...localEvidence, ...digilockerEvidence];

                // Convert Firestore timestamps to match local timestamps for sorting
                allEvidence.forEach(item => {
                    if (item.timestamp && item.timestamp.seconds) { // It's a Firestore timestamp
                        item.sortableTimestamp = item.timestamp.seconds * 1000;
                    } else if (item.timestamp) { // It's a local ISO string
                        item.sortableTimestamp = new Date(item.timestamp).getTime();
                    }
                });

                allEvidence.sort((a, b) => b.sortableTimestamp - a.sortableTimestamp);

                const timelineEl = document.getElementById('evidence-timeline');
                timelineEl.innerHTML = '';

                if (allEvidence.length === 0) {
                    timelineEl.innerHTML = `<p style="color: var(--text-secondary);">${translations[appState.currentLang].no_evidence || 'No evidence uploaded yet.'}</p>`;
                } else {
                    allEvidence.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'evidence-card';
                        const iconHtml = item.type === 'digilocker' ? `<i data-lucide="shield-check" style="width:48px; height:48px; color: var(--accent-success)"></i>` : `<i data-lucide="image" style="width:48px; height:48px;"></i>`;

                        const displayTimestamp = item.isLocal ? new Date(item.timestamp).toLocaleString() : new Date(item.sortableTimestamp).toLocaleString();

                        card.innerHTML = `
                            <div class="timestamp">${displayTimestamp}</div>
                            <div class="media-icon">${iconHtml}</div>
                            <div class="caption">"${item.caption}"</div>
                            ${item.aiSummary ? `<div class="ai-summary"><strong>AI Summary:</strong> ${item.aiSummary.replace(/\n/g, '<br>')}</div>` : ''}
                        `;
                        timelineEl.appendChild(card);
                    });
                }
                lucide.createIcons();
            }

            function addLocalEvidenceToVault(evidenceData) {
                const evidence = getFromStorage('evidenceVault');
                evidence.unshift(evidenceData); // Add to the beginning
                saveToStorage('evidenceVault', evidence);
                renderEvidenceVault();
            }

            // --- Travel Log Logic (Stays with localStorage) ---
            function renderTravelLogs() {
                const expenses = getFromStorage('travelExpenses');
                const container = document.getElementById('logged-travel-expenses');
                container.innerHTML = '';
                if (expenses.length > 0) {
                    expenses.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    expenses.forEach(log => {
                        const item = document.createElement('div');
                        item.className = 'travel-log-item';
                        item.innerHTML = `
                            <div class="travel-log-route">${log.from}  ${log.to}</div>
                            <div class="travel-log-amount">${log.allowance}</div>
                            <div class="travel-log-details">${log.actualDistance} km  ${new Date(log.timestamp).toLocaleDateString()}</div>
                        `;
                        container.appendChild(item);
                    });
                }
            }

            // --- DBT Hub Logic ---
            function renderDBTHub() {
                const bankStatusContainer = document.getElementById('bank-status-container');
                const paymentLedger = document.getElementById('payment-ledger');

                // 1. Render Bank Account Status
                const bankInfo = JSON.parse(localStorage.getItem('bankAccount')) || { status: 'unlinked' };
                let statusBadge, actionBtn;

                switch (bankInfo.status) {
                    case 'verified':
                        statusBadge = `<div class="status-badge status-badge-verified">${translations[appState.currentLang].bank_status_verified || 'Verified'}</div>`;
                        actionBtn = `<p class="text-sm text-gray-600">A/C: ...${bankInfo.account.slice(-4)}</p>`;
                        break;
                    case 'verifying':
                        statusBadge = `<div class="status-badge status-badge-verifying">${translations[appState.currentLang].bank_status_verifying || 'Verifying...'}</div>`;
                        actionBtn = `<button class="btn-full btn-sm" disabled>${translations[appState.currentLang].verifying || 'Verifying...'}</button>`;
                        break;
                    default: // unlinked
                        statusBadge = `<div class="status-badge status-badge-unlinked">${translations[appState.currentLang].bank_status_unlinked || 'Not Linked'}</div>`;
                        actionBtn = `<button class="btn-full btn-sm" id="link-bank-account-btn" data-lang-key="link_bank_account">Link Bank Account</button>`;
                }
                bankStatusContainer.innerHTML = `<div>${statusBadge}</div><div>${actionBtn}</div>`;

                // 2. Render Payment Ledger (simulated data)
                const payments = [
                    { name: 'First Installment', amount: '2,06,250', status: 'credited', date: 'Oct 05, 2025' },
                    { name: 'Second Installment', amount: '4,12,500', status: 'disbursed', date: 'Oct 12, 2025' },
                    { name: 'Final Installment', amount: '2,06,250', status: 'pending', date: null },
                ];
                let creditedAmount = 0;
                const totalAmount = 825000;

                paymentLedger.innerHTML = payments.map(p => {
                    let statusClass, statusText, actionButton = '';
                    if (p.status === 'credited') {
                        statusClass = 'status-paid';
                        statusText = translations[appState.currentLang].payment_status_credited || 'Credited to Account';
                        creditedAmount += 206250; // Simplified for demo
                    } else if (p.status === 'disbursed') {
                        statusClass = 'status-disbursed';
                        statusText = translations[appState.currentLang].payment_status_disbursed || 'Disbursed by State';
                        actionButton = `<button class="btn-full btn-sm" onclick="alert('Checking payment status... This would integrate with a payment tracking API.')" data-lang-key="track_payment">Track Payment</button>`;
                    } else {
                        statusClass = 'status-pending';
                        statusText = translations[appState.currentLang].payment_status_pending || 'Pending';
                    }

                    return `
                        <div class="ledger-item">
                            <div class="ledger-details">
                                <div class="ledger-amount">${p.amount}</div>
                                <div>${p.name}</div>
                                <span class="ledger-status ${statusClass}">${statusText} ${p.date ? `(${p.date})` : ''}</span>
                            </div>
                            <div class="ledger-actions">${actionButton}</div>
                        </div>`;
                }).join('');

                // 3. Update progress bar
                const progressPercent = (creditedAmount / totalAmount) * 100;
                document.getElementById('payment-progress-bar').style.width = `${progressPercent}%`;

                // Add event listener for the new button if it exists
                const linkBtn = document.getElementById('link-bank-account-btn');
                if (linkBtn) {
                    linkBtn.addEventListener('click', () => {
                        document.getElementById('bank-account-modal').classList.add('active');
                    });
                }
            }

            // --- Relief Calculator Logic ---
            async function manageReliefCalculator(userInput = "Let's begin") {
                const modalContent = document.getElementById('calculator-content');
                const modalOptions = document.getElementById('calculator-options');

                if (userInput === "Let's begin" || userInput === "Let's restart") {
                    reliefConversationHistory = [];
                }

                reliefConversationHistory.push({ role: "user", parts: [{ text: userInput }] });

                modalContent.innerHTML = `<p>Thinking...</p>`;
                modalOptions.innerHTML = '';

                const systemPrompt = `You are an expert on the relief norms of India's Scheduled Castes and the Scheduled Tribes (Prevention of Atrocities) Act, 1989 and its amendments. Your goal is to determine the exact relief amount a victim is entitled to.
                1. Ask the user questions one by one. Keep questions simple and provide clear, distinct options for answers (e.g., "Yes", "No", "It was a different type of harm").
                2. Based on the user's answers, ask follow-up questions to narrow down the specific offense listed in the Act's Annexure.
                3. Once you have identified the specific offense, provide the final calculation.
                4. For your final answer, you MUST respond ONLY with a JSON object in the following format: {"offense": "Description of the offense", "total_relief": "Total amount in INR", "installments": [{"stage": "Stage description e.g., On filing FIR", "amount": "Amount in INR"}, {"stage": "Stage description e.g., On chargesheet", "amount": "Amount in INR"}], "source": "Mention the specific rule or Annexure item number from the PoA rules."}
                5. Do not provide the final JSON until you are certain you have all the information. Until then, continue asking questions by responding with plain text.`;

                const payload = {
                    contents: reliefConversationHistory,
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error("API request failed");
                    const result = await response.json();
                    const botResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!botResponseText) throw new Error("Empty response from API");

                    reliefConversationHistory.push({ role: "model", parts: [{ text: botResponseText }] });

                    try {
                        const jsonData = JSON.parse(botResponseText);
                        displayReliefResults(jsonData);
                    } catch (e) {
                        displayCalculatorQuestion(botResponseText);
                    }
                } catch (error) {
                    console.error("Relief Calculator Error:", error);
                    modalContent.innerHTML = `<p>Sorry, something went wrong. Please try again.</p>`;
                }
            }

            function displayCalculatorQuestion(question) {
                const modalContent = document.getElementById('calculator-content');
                const modalOptions = document.getElementById('calculator-options');
                modalContent.innerHTML = `<p>${question}</p>`;

                const options = ["Yes", "No", "Not Applicable"];
                modalOptions.innerHTML = options.map(opt => `<button class="modal-btn calculator-option-btn">${opt}</button>`).join('');

                document.querySelectorAll('.calculator-option-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        manageReliefCalculator(btn.textContent);
                    });
                });
            }

            function displayReliefResults(data) {
                const modalContent = document.getElementById('calculator-content');
                const modalOptions = document.getElementById('calculator-options');

                let installmentsHtml = data.installments.map(item => `
                    <div class="detail-item">
                        <span class="detail-label">${item.stage}</span>
                        <span class="detail-value">${item.amount}</span>
                    </div>
                `).join('');

                modalContent.innerHTML = `
                    <h5 class="card-subtitle">Calculation Complete</h5>
                    <p><strong>Offense Category:</strong> ${data.offense}</p>
                    <div class="detail-item" style="font-size: 20px;">
                        <b class="detail-label">Total Relief Entitlement</b>
                        <b class="detail-value">${data.total_relief}</b>
                    </div>
                    <h5 class="card-subtitle" style="margin-top: 20px;">Installment Plan</h5>
                    ${installmentsHtml}
                    <p style="font-size: 14px; color: var(--text-secondary); margin-top: 15px;"><em>Source: ${data.source}</em></p>
                `;
                modalOptions.innerHTML = ''; // Clear options
            }

            async function markStageAsComplete(stageId) {
                if (!appState.userId) return;

                const stageEl = document.querySelector(`.journey-stage[data-stage-id="${stageId}"]`);
                if (!stageEl) return;

                const isVerifiable = stageEl.dataset.verifiable === 'true';
                const node = stageEl.querySelector('.journey-node');

                const journeyDocRef = doc(db, 'apps', appId, 'users', appState.userId, 'journeyStatus', 'main');
                const completeAction = async () => {
                    await setDoc(journeyDocRef, { [stageId]: true }, { merge: true });
                    // The onSnapshot listener will handle the UI update automatically.
                };

                if (isVerifiable) {
                    stageEl.classList.add('verifying');
                    if (node) node.innerHTML = `<i data-lucide="refresh-cw" class="animate-spin"></i>`;
                    lucide.createIcons();
                    // Simulate a network call to verify
                    setTimeout(completeAction, 2000);
                } else {
                    completeAction();
                }
            }

            function setupEventListeners() {
                document.getElementById('theme-toggle').addEventListener('click', () => {
                    const isDark = document.body.classList.toggle('dark-mode');
                    document.getElementById('theme-toggle').innerHTML = `<i data-lucide="${isDark ? 'sun' : 'moon'}"></i>`;
                    lucide.createIcons();
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                });

                document.getElementById('lang-toggle').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.getElementById('language-circle-menu').classList.toggle('visible');
                });
                document.body.addEventListener('click', () => document.getElementById('language-circle-menu').classList.remove('visible'));

                document.querySelectorAll('.journey-stage').forEach(stage => {
                    stage.addEventListener('click', () => {
                        const modalId = stage.dataset.modal;
                        if (!modalId) return;
                        const modal = document.getElementById(modalId);
                        const modalContentEl = modal.querySelector('.modal-content');

                        let modalContents = {
                            'fir-details-modal': `<h3>FIR Details</h3>` + createDetailItem('FIR Number', caseData.fir.number) + createDetailItem('Date & Time', caseData.fir.datetime.toLocaleString()) + createDetailItem('Police Station', caseData.fir.station) + createDetailItem('Sections Applied', caseData.fir.sections),
                            'investigation-details-modal': `<h3>Investigation</h3>` + createDetailItem('Investigating Officer', caseData.investigation.officer) + createDetailItem('Rank', `${caseData.investigation.rank} ${caseData.investigation.isValid ? '' : ''}`),
                            'relief1-details-modal': `<h3>First Relief</h3>` + createDetailItem('Amount Due', caseData.relief1.amount) + createDetailItem('Status', caseData.relief1.status),
                            'relief2-details-modal': `<h3>Second Relief</h3>` + createDetailItem('Amount Due', caseData.relief2.amount) + createDetailItem('Status', caseData.relief2.status),
                            'trial-details-modal': `<h3>Trial Details</h3>` + createDetailItem('Next Hearing', new Date(caseData.trial.nextHearing).toLocaleString()) + createDetailItem('Hearing History', caseData.trial.history) + `<button class="btn-full" id="fetch-ecourts-status-btn" style="margin-top: 20px;"><i data-lucide="refresh-cw"></i><span data-lang-key="fetch_ecourts_status">Fetch Latest Status</span></button>`,
                            'judgment-details-modal': `<h3>Final Judgment</h3>` + createDetailItem('Verdict', caseData.judgment.verdict) + createDetailItem('Date of Judgment', new Date(caseData.judgment.date).toLocaleDateString()) + `<button class="btn-full" style="margin-top: 20px;"><i data-lucide="download" style="vertical-align: middle; margin-right: 8px;"></i>Download Court Order</button>`,
                            'relief-final-details-modal': `<h3>Final Relief</h3>` + createDetailItem('Amount Due', caseData.reliefFinal.amount) + createDetailItem('Status', caseData.reliefFinal.status),
                        };

                        if (modalContents[modalId]) {
                            modalContentEl.innerHTML = modalContents[modalId];
                            setLanguage(appState.currentLang); // Translate modal content
                            lucide.createIcons();
                        }

                        if (modalId === 'trial-details-modal') {
                            const fetchBtn = modalContentEl.querySelector('#fetch-ecourts-status-btn');
                            if (fetchBtn) {
                                fetchBtn.addEventListener('click', async (e) => {
                                    const btn = e.currentTarget;
                                    btn.disabled = true;
                                    btn.innerHTML = `<i data-lucide="refresh-cw" class="animate-spin"></i> <span data-lang-key="fetching">${translations[appState.currentLang].fetching || "Fetching..."}</span>`;
                                    lucide.createIcons();

                                    try {
                                        // In a real app, this would call your Firebase function
                                        // const getCaseStatus = httpsCallable(functions, 'getECourtsCaseStatus');
                                        // const result = await getCaseStatus({ cnr: caseData.cnr });
                                        // const data = result.data;

                                        // --- SIMULATION ---
                                        await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate network delay
                                        const simulatedData = {
                                            nextHearing: new Date(new Date(caseData.trial.nextHearing).getTime() + 15 * 24 * 60 * 60 * 1000).toISOString(),
                                            history: "25-11-2025: Witness testimony recorded. " + caseData.trial.history
                                        };
                                        // --- END SIMULATION ---

                                        // Update caseData and UI
                                        caseData.trial.nextHearing = simulatedData.nextHearing;
                                        caseData.trial.history = simulatedData.history;
                                        modalContentEl.querySelector('.detail-item:first-child .detail-value').textContent = new Date(simulatedData.nextHearing).toLocaleString();
                                        modalContentEl.querySelector('.detail-item:nth-child(2) .detail-value').textContent = simulatedData.history;
                                        document.getElementById('next-hearing-subtext').textContent = `Next Hearing: ${new Date(simulatedData.nextHearing).toLocaleDateString()}`;

                                    } catch (error) {
                                        console.error("eCourts fetch error:", error);
                                        alert("Could not fetch latest case status.");
                                    } finally {
                                        btn.disabled = false;
                                        btn.innerHTML = `<i data-lucide="refresh-cw"></i> <span data-lang-key="fetch_ecourts_status">${translations[appState.currentLang].fetch_ecourts_status || "Fetch Latest Status"}</span>`;
                                        lucide.createIcons();
                                    }
                                });
                            }
                        }

                        modal.classList.add('active');
                    });
                });


                document.querySelectorAll('.journey-stage[data-stage-id]').forEach(stage => {
                    const stageId = stage.dataset.stageId;
                    const stageTitle = stage.querySelector('.journey-details-title').textContent;

                    // Listener for opening confirmation/details modal
                    stage.addEventListener('click', (e) => {
                        e.stopPropagation();

                        if (e.target.classList.contains('mismatch-link')) return; // Ignore clicks on the mismatch link

                        if (stage.classList.contains('completed') || stage.classList.contains('verifying')) {
                            const modalId = stage.dataset.modal;
                            if (modalId) {
                                document.getElementById(modalId)?.classList.add('active');
                            }
                        } else {
                            const confirmModal = document.getElementById('stage-confirm-modal');
                            const confirmText = document.getElementById('stage-confirm-text');
                            confirmText.textContent = (translations[appState.currentLang].stage_confirm_question || "Have you completed this step?") + ` (${stageTitle})`;
                            confirmModal.dataset.stageToComplete = stageId;
                            confirmModal.classList.add('active');
                        }
                    });

                    // Listener for the mismatch link
                    const mismatchLink = stage.querySelector('.mismatch-link');
                    if (mismatchLink) {
                        mismatchLink.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const mismatchModal = document.getElementById('mismatch-ticket-modal');
                            document.getElementById('mismatch-stage-name').textContent = `Regarding Stage: ${stageTitle}`;
                            mismatchModal.dataset.stageId = stageId;
                            mismatchModal.classList.add('active');
                        });
                    }
                });

                document.getElementById('confirm-stage-completion').addEventListener('click', () => {
                    const stageId = document.getElementById('stage-confirm-modal').dataset.stageToComplete;
                    if (stageId) {
                        markStageAsComplete(stageId);
                    }
                    document.getElementById('stage-confirm-modal').classList.remove('active');
                });

                document.getElementById('cancel-stage-completion').addEventListener('click', () => {
                    document.getElementById('stage-confirm-modal').classList.remove('active');
                });

                document.getElementById('mismatch-ticket-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!appState.userId) return;

                    const mismatchModal = document.getElementById('mismatch-ticket-modal');
                    const stageId = mismatchModal.dataset.stageId;
                    const details = document.getElementById('mismatch-details').value;

                    if (!details.trim()) {
                        alert("Please provide details about the mismatch.");
                        return;
                    }

                    try {
                        const ticketsCol = collection(db, 'apps', appId, 'tickets');
                        await addDoc(ticketsCol, {
                            userId: appState.userId,
                            stageId: stageId,
                            details: details,
                            status: 'open',
                            createdAt: serverTimestamp()
                        });
                        alert("Ticket submitted successfully. An administrator will review your report.");
                        e.target.reset();
                        mismatchModal.classList.remove('active');
                    } catch (error) {
                        console.error("Error submitting ticket:", error);
                        alert("Failed to submit ticket. Please try again.");
                    }
                });

                document.querySelectorAll('[data-modal]').forEach(element => {
                    if (!element.classList.contains('journey-stage')) {
                        element.addEventListener('click', (e) => {
                            const modalId = e.currentTarget.dataset.modal;
                            if (modalId) {
                                const modal = document.getElementById(modalId);
                                if (modal) modal.classList.add('active');
                            }
                        });
                    }
                });

                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.addEventListener('click', e => {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                            if (modal.id === 'travel-log-modal') {
                                document.getElementById('travel-step-1').classList.remove('hidden');
                                document.getElementById('travel-step-2').classList.add('hidden');
                                document.getElementById('travel-form').reset();
                            }
                            if (modal.id === 'add-evidence-modal') {
                                document.getElementById('add-evidence-form').reset();
                                appState.currentFile = null;
                            }
                        }
                    });
                });

                document.getElementById('help-fab').addEventListener('click', () => document.getElementById('help-modal').classList.add('active'));

                document.getElementById('ai-fab').addEventListener('click', () => document.getElementById('chat-container').classList.add('active'));
                document.getElementById('chat-close-btn').addEventListener('click', () => document.getElementById('chat-container').classList.remove('active'));
                document.getElementById('chat-form').addEventListener('submit', handleChatSubmit);
                document.getElementById('chat-file-upload-btn').addEventListener('click', () => document.getElementById('chat-file-upload-input').click());
                document.getElementById('chat-file-upload-input').addEventListener('change', handleFileUpload);
                document.getElementById('mic-btn').addEventListener('click', () => startSpeechRecognition(false));

                document.querySelectorAll('.tab-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const tabId = button.dataset.tab;
                        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                        document.getElementById(tabId).classList.add('active');
                    });
                });

                document.getElementById('community-alerts-toggle').addEventListener('change', function () {
                    document.getElementById('whatsapp-support-link').classList.toggle('hidden', !this.checked);
                });

                document.getElementById('report-issue-form').addEventListener('submit', function (e) {
                    e.preventDefault();
                    alert('Issue reported. Thank you for your feedback.');
                    this.reset();
                });


                // Travel Log Modal Logic
                const TRAVEL_RATE_PER_KM = 8;
                document.getElementById('log-travel-btn').addEventListener('click', () => document.getElementById('travel-log-modal').classList.add('active'));

                const travelForm = document.getElementById('travel-form');
                travelForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const from = document.getElementById('travel-from').value;
                    const to = document.getElementById('travel-to').value;
                    if (!from.trim() || !to.trim()) return;
                    const submitButton = travelForm.querySelector('button[type="submit"]');
                    submitButton.disabled = true;
                    submitButton.textContent = translations[appState.currentLang].calculating || 'Calculating...';
                    calculateTravelDetails(from, to, submitButton);
                });

                const actualDistanceInput = document.getElementById('actual-distance');
                const resultsAllowanceEl = document.getElementById('results-allowance');
                const distanceErrorEl = document.getElementById('distance-error');
                actualDistanceInput.addEventListener('input', () => {
                    const distance = parseFloat(actualDistanceInput.value) || 0;
                    const min = parseFloat(actualDistanceInput.min);
                    const max = parseFloat(actualDistanceInput.max);
                    if (distance < min || distance > max) {
                        distanceErrorEl.textContent = translations[appState.currentLang].distance_error_text || "Please enter a distance within the suggested range.";
                        distanceErrorEl.classList.remove('hidden');
                    } else {
                        distanceErrorEl.classList.add('hidden');
                    }
                    resultsAllowanceEl.textContent = `${(distance * TRAVEL_RATE_PER_KM).toFixed(2)}`;
                });

                document.getElementById('confirm-travel-log').addEventListener('click', () => {
                    if (!distanceErrorEl.classList.contains('hidden')) return;
                    const expenses = getFromStorage('travelExpenses');
                    expenses.unshift({
                        from: document.getElementById('travel-from').value,
                        to: document.getElementById('travel-to').value,
                        actualDistance: actualDistanceInput.value,
                        allowance: resultsAllowanceEl.textContent,
                        timestamp: new Date().toISOString()
                    });
                    saveToStorage('travelExpenses', expenses);
                    renderTravelLogs();
                    document.getElementById('travel-log-modal').classList.remove('active');
                    document.getElementById('travel-step-1').classList.remove('hidden');
                    document.getElementById('travel-step-2').classList.add('hidden');
                    travelForm.reset();
                });


                // Evidence Upload Logic (Local Storage)
                const evidenceFileInput = document.getElementById('evidence-file-input');
                document.getElementById('upload-evidence-btn').addEventListener('click', () => evidenceFileInput.click());
                evidenceFileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        appState.currentFile = file;
                        document.getElementById('add-evidence-modal').classList.add('active');
                    }
                    e.target.value = ''; // Reset file input
                });

                document.getElementById('add-evidence-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!appState.currentFile) return;

                    const caption = document.getElementById('evidence-caption').value;
                    const useAi = document.getElementById('ai-consent-checkbox').checked;
                    const submitButton = e.target.querySelector('button[type="submit"]');

                    submitButton.disabled = true;
                    let aiSummary = null;

                    if (useAi && appState.currentFile.type.startsWith('image/')) {
                        submitButton.textContent = translations[appState.currentLang].upload_processing || "Processing with AI...";
                        const reader = new FileReader();
                        reader.onloadend = async () => {
                            const base64Data = reader.result.split(',')[1];
                            aiSummary = await extractInfoWithGemini(base64Data);
                            finalizeEvidenceUpload(caption, aiSummary);
                        };
                        reader.readAsDataURL(appState.currentFile);
                    } else {
                        finalizeEvidenceUpload(caption, null);
                    }
                });

                function finalizeEvidenceUpload(caption, aiSummary) {
                    addLocalEvidenceToVault({
                        caption: caption,
                        timestamp: new Date().toISOString(),
                        type: 'upload',
                        aiSummary: aiSummary
                    });
                    document.getElementById('add-evidence-modal').classList.remove('active');
                    document.getElementById('add-evidence-form').reset();
                    appState.currentFile = null;
                    const submitButton = document.querySelector('#add-evidence-form button');
                    submitButton.disabled = false;
                    setLanguage(appState.currentLang);
                }


                // DigiLocker Logic (Firestore)
                document.getElementById('digilocker-fetch-btn').addEventListener('click', () => {
                    document.getElementById('digilocker-modal').classList.add('active');
                });

                document.getElementById('proceed-to-digilocker').addEventListener('click', () => {
                    // This now redirects to your backend endpoint to start the flow
                    window.location.href = 'http://localhost:3000/api/connect-digilocker';
                });

                document.getElementById('simulate-digilocker-fetch').addEventListener('click', async () => {
                    if (!appState.userId) {
                        alert("Authentication not ready. Please wait a moment.");
                        return;
                    }
                    const digilockerCol = collection(db, 'apps', appId, 'users', appState.userId, 'digilockerEvidence');
                    await addDoc(digilockerCol, {
                        caption: "Aadhaar Card (Simulated)",
                        timestamp: serverTimestamp(),
                        type: 'digilocker',
                        aiSummary: 'Name: Sunita Devi, ID: XXXX-XXXX-1234'
                    });
                    document.getElementById('digilocker-modal').classList.remove('active');
                });

                // Relief Calculator Listeners
                document.getElementById('start-relief-calculation-btn').addEventListener('click', () => {
                    document.getElementById('relief-calculator-modal').classList.add('active');
                    manageReliefCalculator("Let's begin");
                });

                document.getElementById('restart-calculator-btn').addEventListener('click', () => {
                    manageReliefCalculator("Let's restart");
                });

                // Bank Account Modal Logic
                document.getElementById('bank-account-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const accountNumber = document.getElementById('bank-account-number').value;
                    const ifsc = document.getElementById('bank-ifsc-code').value;

                    // Store details and set status to verifying
                    let bankInfo = { account: accountNumber, ifsc: ifsc, status: 'verifying' };
                    localStorage.setItem('bankAccount', JSON.stringify(bankInfo));
                    renderDBTHub(); // Re-render the hub to show "Verifying..."
                    document.getElementById('bank-account-modal').classList.remove('active');

                    // Simulate verification delay
                    setTimeout(() => {
                        bankInfo.status = 'verified';
                        localStorage.setItem('bankAccount', JSON.stringify(bankInfo));
                        renderDBTHub(); // Re-render to show "Verified"
                    }, 2000);
                });


                // Voice Mode Listeners & Other Buttons
                document.getElementById('voice-mode-toggle').addEventListener('click', enterVoiceMode);
                document.getElementById('exit-voice-mode-btn').addEventListener('click', exitVoiceMode);
                document.getElementById('request-protection-btn').addEventListener('click', () => document.getElementById('protection-confirm-modal').classList.add('active'));
                document.getElementById('cancel-protection').addEventListener('click', () => document.getElementById('protection-confirm-modal').classList.remove('active'));
                document.getElementById('close-share-modal').addEventListener('click', () => document.getElementById('share-link-modal').classList.remove('active'));
                document.getElementById('share-link-btn').addEventListener('click', () => {
                    document.getElementById('help-modal').classList.remove('active');
                    document.getElementById('share-link-modal').classList.add('active');
                });
                document.getElementById('confirm-protection-final').addEventListener('click', () => {
                    document.getElementById('protection-confirm-modal').classList.remove('active');
                    console.log("High-priority protection alert sent to DM and SP.");
                    document.getElementById('protection-banner').style.display = 'none';
                });

                document.querySelector('.voice-note-btn').addEventListener('click', (e) => {
                    const instruction = e.currentTarget.previousElementSibling.previousElementSibling.textContent;
                    const subtext = e.currentTarget.previousElementSibling.textContent;
                    speak(`${instruction}. ${subtext}`);
                });
            }

            // --- App Initialization ---
            function initializeAppLogic() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                const themeToggle = document.getElementById('theme-toggle');
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-mode');
                    if (themeToggle) themeToggle.innerHTML = `<i data-lucide="sun"></i>`;
                } else {
                    if (themeToggle) themeToggle.innerHTML = `<i data-lucide="moon"></i>`;
                }

                let savedLang = localStorage.getItem('language');
                // If the saved language is not a valid key in our translations, default to 'en'.
                if (!translations[savedLang]) {
                    savedLang = 'en';
                }
                setLanguage(savedLang);

                initializeEventStream();
                initializeTimeline();
                initializeLanguageCircle();
                setupEventListeners();
                renderTravelLogs(); // Load initial local travel logs
                renderEvidenceVault(); // Load initial local evidence
                renderDBTHub(); // Render the DBT hub
                setInterval(updateCountdown, 60000);
                updateCountdown();

                lucide.createIcons();
            }

            // --- Firebase Listeners ---
            function setupFirestoreListeners() {
                if (!appState.userId) return;

                // Listener for Journey Status
                // Listener for Journey Status
                const journeyDocRef = doc(db, 'apps', appId, 'users', appState.userId, 'journeyStatus', 'main');
                // ...
                // Listener for DigiLocker Evidence
                onSnapshot(journeyDocRef, (docSnap) => {
                    const statusData = docSnap.exists() ? docSnap.data() : { 'fir-registered': true }; // Default to FIR being complete
                    appState.journeyStatus = statusData;
                    renderTimeline(statusData);
                });

                // Listener for DigiLocker Evidence
                const digilockerCol = collection(db, 'apps', appId, 'users', appState.userId, 'digilockerEvidence');

                onSnapshot(digilockerCol, (snapshot) => {
                    appState.digilockerEvidence = [];
                    snapshot.forEach(doc => appState.digilockerEvidence.push({ ...doc.data(), id: doc.id }));
                    renderEvidenceVault(); // Re-render with new Firestore data
                });
            }
            // END: MODIFICATION

            // --- Firebase Auth Listener ---
            onAuthStateChanged(auth, user => {
                if (user) {
                    // User is signed in.
                    appState.userId = user.uid;

                    initializeAppLogic(); // Run the main app logic
                    setupFirestoreListeners(); // Set up Firestore listeners

                    // // Set up Firestore listener for DigiLocker evidence
                    // const digilockerCol = collection(db, 'users', appState.userId, 'digilockerEvidence');
                    // onSnapshot(digilockerCol, (snapshot) => {
                    //     appState.digilockerEvidence = [];
                    //     snapshot.forEach(doc => appState.digilockerEvidence.push({ ...doc.data(), id: doc.id }));
                    //     renderEvidenceVault(); // Re-render with new Firestore data
                    // });

                } else {
                    // No user signed in yet.
                    console.log("No user is currently signed in.");
                }
            });

            // --- Start Authentication ---
            const authenticateUser = async () => {
                try {
                    // Check if a custom token is provided by the environment
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        // Fallback to anonymous sign-in
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    // Display an error to the user in the UI if needed
                }
            };

            authenticateUser(); // Trigger the authentication process

        });
    </script>
</body>

</html>