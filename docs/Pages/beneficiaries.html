<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>State-wise Beneficiary Dashboard | PM-AJAY</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar { background-color: #ffffff; }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .dark .sidebar, .dark .card { background-color: #1c1b1a; }
        .dark .card { border: 1px solid #374151; box-shadow: none; }
        .data-table th, .data-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .dark .data-table th, .dark .data-table td {
            border-bottom-color: #374151;
        }
        .data-table td:focus {
            outline: 2px solid #4f46e5;
            background-color: #eef2ff;
        }
        .dark .data-table td:focus {
            background-color: #312e81;
        }
    </style>
</head>
<body class="flex min-h-screen bg-[#fdfaf6] dark:bg-black">
    <aside class="sidebar w-64 flex-shrink-0 border-r border-slate-200 dark:border-gray-700 flex flex-col">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-slate-800 dark:text-gray-100 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-2 text-indigo-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.874 6 7.5 6h5c.626 0 .988-.27 1.256-.579A6.012 6.012 0 0115.668 8.027c.21.34 .332.732 .332 1.155a3.999 3.999 0 01-4 4c-1.933 0-3.5-1.567-3.5-3.5a3.999 3.999 0 011.006-2.622c.23-.352.484-.65.744-.897C10.5 6.27 10.246 6 10 6h-.5a.5.5 0 00-.5.5v1.5a.5.5 0 00.5.5h.5a.5.5 0 00.5-.5v-1a.5.5 0 00-.5-.5h-2a.5.5 0 00-.5.5v1a.5.5 0 00.5.5h.5a.5.5 0 00.5-.5V8.5a.5.5 0 00-.5-.5h-2a.5.5 0 00-.5.5v1.5a.5.5 0 00.5.5H8a.5.5 0 00.5-.5V9.5a3.5 3.5 0 00-3.5-3.5c-.538 0-1.03.123-1.468.342z" clip-rule="evenodd" /></svg>
                PM-AJAY
            </h1>
        </div>
        <nav class="flex-1 px-4 py-2">
            <a href="central.html" class="flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>Dashboard</a>
            <a href="reports.html" class="flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium"><i data-lucide="bar-chart-3" class="w-5 h-5 mr-3"></i>Reports</a>
            <a href="projects-alert.html" class="flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium"><i data-lucide="bell" class="w-5 h-5 mr-3"></i>Alerts</a>
            <a href="beneficiaries.html" class="flex items-center px-4 py-2.5 text-slate-700 bg-indigo-50 dark:bg-gray-700 dark:text-gray-100 rounded-lg font-semibold"><i data-lucide="users" class="w-5 h-5 mr-3 text-indigo-600 dark:text-indigo-400"></i>Beneficiaries</a>
            <a href="#" class="flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium"><i data-lucide="settings" class="w-5 h-5 mr-3"></i>Settings</a>
        </nav>
    </aside>

    <main class="flex-1 p-6 lg:p-8 overflow-y-auto">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-slate-800 dark:text-gray-100">State-wise Beneficiaries</h2>
                <p id="dashboard-subtitle" class="text-slate-500 dark:text-gray-400 mt-1">Select a state to view detailed graphs and data.</p>
            </div>
            <div class="flex items-center gap-4 mt-4 sm:mt-0">
                <select id="state-select" class="bg-white dark:bg-gray-800 border border-slate-300 dark:border-gray-600 rounded-lg px-4 py-2 text-slate-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <!-- Options will be populated by JS -->
                </select>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700">
                    <i data-lucide="sun" id="theme-toggle-light-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400"></i>
                    <i data-lucide="moon" id="theme-toggle-dark-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400 hidden"></i>
                </button>
            </div>
        </div>
        
        <!-- KPI Cards Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="card p-5 bg-indigo-600 dark:bg-indigo-800 text-white"><div class="flex justify-between items-start"><h3 class="font-medium opacity-80">State Impact Score</h3><i data-lucide="gauge-circle" class="w-6 h-6 opacity-80"></i></div><p id="kpi-impact-score" class="text-5xl font-bold mt-2">0</p><p class="text-xs opacity-70 mt-1">Disbursement, coverage & speed metric</p></div>
            <div class="card p-5"><div class="flex justify-between items-start"><h3 class="text-slate-500 dark:text-gray-400 font-medium">Total Disbursed</h3><div class="p-2 bg-green-100 dark:bg-green-500/10 rounded-md"><i data-lucide="indian-rupee" class="w-5 h-5 text-green-600 dark:text-green-400"></i></div></div><p id="kpi-total-disbursed" class="text-4xl font-bold text-slate-800 dark:text-gray-100 mt-2">0</p></div>
            <div class="card p-5"><div class="flex justify-between items-start"><h3 class="text-slate-500 dark:text-gray-400 font-medium">Total Beneficiaries</h3><div class="p-2 bg-blue-100 dark:bg-blue-500/10 rounded-md"><i data-lucide="users" class="w-5 h-5 text-blue-600 dark:text-blue-400"></i></div></div><p id="kpi-total-beneficiaries" class="text-4xl font-bold text-slate-800 dark:text-gray-100 mt-2">0</p></div>
            <div class="card p-5"><div class="flex justify-between items-start"><h3 class="text-slate-500 dark:text-gray-400 font-medium">Avg. Time to Disburse</h3><div class="p-2 bg-yellow-100 dark:bg-yellow-500/10 rounded-md"><i data-lucide="timer" class="w-5 h-5 text-yellow-600 dark:text-yellow-400"></i></div></div><p id="kpi-avg-time" class="text-4xl font-bold text-slate-800 dark:text-gray-100 mt-2">0 <span class="text-xl">days</span></p></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="card p-5">
                <h3 class="font-semibold text-slate-800 dark:text-gray-100 mb-4">Scheme-wise Disbursement</h3>
                <div id="bar-graph-container" class="min-h-[300px]"></div>
            </div>
            <div class="card p-5">
                <h3 class="font-semibold text-slate-800 dark:text-gray-100 mb-4">Beneficiary Trend (Last 12 Months)</h3>
                <div id="line-graph-container" class="min-h-[300px]"></div>
            </div>
        </div>

        <div class="card p-5">
             <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                <h3 class="font-semibold text-slate-800 dark:text-gray-100">State Data Details</h3>
                <div class="flex items-center gap-2 mt-3 sm:mt-0">
                    <button id="download-csv-btn" class="flex items-center gap-2 text-xs font-semibold bg-green-100 text-green-700 dark:bg-green-500/10 dark:text-green-400 px-3 py-2 rounded-lg hover:bg-green-200">
                        <i data-lucide="file-down" class="w-4 h-4"></i> Download CSV
                    </button>
                    <button id="download-pdf-btn" class="flex items-center gap-2 text-xs font-semibold bg-orange-100 text-orange-700 dark:bg-orange-500/10 dark:text-orange-400 px-3 py-2 rounded-lg hover:bg-orange-200">
                        <i data-lucide="file-text" class="w-4 h-4"></i> Download PDF
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600 dark:text-gray-300 data-table">
                    <thead class="bg-slate-50 dark:bg-gray-800 text-xs uppercase">
                        <tr>
                            <th>ID</th>
                            <th>Scheme</th>
                            <th>Amount (â‚¹)</th>
                            <th>Beneficiaries</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        <!-- Rows will be populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>
    
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const stateData = {};
        const states = [
            "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", "Gujarat", "Haryana", 
            "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur", 
            "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", 
            "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal"
        ];
        const schemes = ["Housing Grant", "Scholarship", "Atrocity Relief", "Skill Development", "Marriage Incentive"];

        // --- 1. DATA GENERATION ---
        function generateStateData() {
            states.forEach(state => {
                stateData[state] = [];
                for (let i = 1; i <= 10; i++) {
                    const scheme = schemes[Math.floor(Math.random() * schemes.length)];
                    const date = new Date(Date.now() - Math.random() * 365 * 24 * 36e5);
                    const timeToDisbursement = Math.floor(Math.random() * 40) + 5; // Added for KPI calculation
                    stateData[state].push({
                        id: `${state.slice(0,2).toUpperCase()}${1000 + i}`,
                        scheme: scheme,
                        amount: Math.floor(Math.random() * (scheme === 'Marriage Incentive' ? 250000 : 50000)) + 1000,
                        beneficiaries: Math.floor(Math.random() * 200) + 10,
                        date: date.toISOString().split('T')[0], // YYYY-MM-DD
                        timeToDisbursement: timeToDisbursement
                    });
                }
            });
        }

        // --- 2. RENDER FUNCTIONS ---
        const formatCurrency = num => (num >= 1e7) ? `${(num/1e7).toFixed(2)} Cr` : (num >= 1e5) ? `${(num/1e5).toFixed(2)} L` : new Intl.NumberFormat('en-IN').format(num.toFixed(0));

        // Update KPI Cards
        function updateKPIs(data) {
            const totalDisbursed = data.reduce((sum, d) => sum + d.amount, 0);
            const totalBeneficiaries = data.reduce((sum, d) => sum + d.beneficiaries, 0);
            const avgTime = data.length > 0 ? (data.reduce((sum, d) => sum + d.timeToDisbursement, 0) / data.length) : 0;
            const score = data.length > 0 ? Math.round((Math.log10(totalDisbursed + 1) * 5) + (Math.log10(totalBeneficiaries + 1) * 5) + (100 / (avgTime + 5))) : 0;

            document.getElementById('kpi-impact-score').textContent = score;
            document.getElementById('kpi-total-disbursed').textContent = `â‚¹${formatCurrency(totalDisbursed)}`;
            document.getElementById('kpi-total-beneficiaries').textContent = totalBeneficiaries.toLocaleString('en-IN');
            document.getElementById('kpi-avg-time').innerHTML = `${avgTime.toFixed(1)} <span class="text-xl">days</span>`;
        }

        // Render Bar Graph (Scheme-wise Disbursement)
        function renderBarGraph(containerId, data) {
            const container = document.getElementById(containerId);
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500">No data to display.</p>';
                return;
            }
            
            const schemeTotals = data.reduce((acc, item) => {
                acc[item.scheme] = (acc[item.scheme] || 0) + item.amount;
                return acc;
            }, {});

            const maxAmount = Math.max(...Object.values(schemeTotals));
            const sortedSchemes = Object.entries(schemeTotals).sort(([,a],[,b]) => b-a);
            
            const barsHtml = sortedSchemes.map(([scheme, amount]) => {
                const percentage = maxAmount > 0 ? (amount / maxAmount) * 100 : 0;
                return `
                    <div class="flex items-center gap-3 text-sm mb-3">
                        <div class="w-1/4 text-slate-500 dark:text-gray-400 truncate">${scheme}</div>
                        <div class="w-3/4 flex items-center gap-2">
                            <div class="flex-grow bg-indigo-100 dark:bg-indigo-900 rounded-full h-5">
                                <div class="bg-indigo-500 h-5 rounded-full" style="width: ${percentage}%;"></div>
                            </div>
                            <div class="font-bold text-slate-700 dark:text-gray-200">â‚¹${amount.toLocaleString('en-IN')}</div>
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = `<div class="w-full">${barsHtml}</div>`;
        }
        
        // Render Bar Graph (Beneficiary Trend)
        function renderBeneficiaryTrendGraph(containerId, data) {
            const container = document.getElementById(containerId);
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500">No data to display.</p>';
                return;
            }
            const monthlyBeneficiaries = Array(12).fill(0);
            const now = new Date();
            data.forEach(item => {
                const itemDate = new Date(item.date);
                const monthDiff = (now.getFullYear() - itemDate.getFullYear()) * 12 + (now.getMonth() - itemDate.getMonth());
                if (monthDiff >= 0 && monthDiff < 12) {
                    monthlyBeneficiaries[11 - monthDiff] += item.beneficiaries;
                }
            });

            const maxVal = Math.max(...monthlyBeneficiaries, 1); // Use 1 to avoid division by zero
            
            const monthLabels = Array.from({length: 12}, (_, i) => {
                const d = new Date(now.getFullYear(), now.getMonth() - (11 - i), 1);
                return d.toLocaleString('default', { month: 'short' });
            });

            const barsHtml = monthlyBeneficiaries.map((value, index) => {
                const percentageHeight = (value / maxVal) * 100;
                return `
                    <div class="flex flex-col items-center flex-1 group h-full justify-end">
                         <div class="text-xs mb-1 text-slate-500 dark:text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity">${value}</div>
                         <div class="w-3/4 bg-indigo-500 rounded-t-md hover:bg-indigo-600 transition-colors" style="height: ${percentageHeight}%;"></div>
                         <div class="text-xs text-slate-400 mt-2">${monthLabels[index]}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="flex items-end justify-around w-full h-[270px] pt-4 border-b border-slate-200 dark:border-gray-700">
                    ${barsHtml}
                </div>
            `;
        }

        // Render Editable Data Table
        function renderDataTable(tbodyId, data) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No data available.</td></tr>';
                return;
            }
            data.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td contenteditable="true">${item.id}</td>
                    <td contenteditable="true">${item.scheme}</td>
                    <td contenteditable="true">${item.amount.toLocaleString('en-IN')}</td>
                    <td contenteditable="true">${item.beneficiaries}</td>
                    <td contenteditable="true">${item.date}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // --- 3. HELPER & EVENT FUNCTIONS ---
        
        // Main function to update all components
        function updateDashboard(state) {
            const data = stateData[state];
            document.getElementById('dashboard-subtitle').textContent = `Showing details for ${state}.`;
            updateKPIs(data);
            renderBarGraph('bar-graph-container', data);
            renderBeneficiaryTrendGraph('line-graph-container', data);
            renderDataTable('data-table-body', data);
        }

        // Download data as CSV
        function downloadCSV(state) {
            const tableRows = document.querySelectorAll('#data-table-body tr');
             if (tableRows.length === 0 || (tableRows.length === 1 && tableRows[0].cells.length === 1)) {
                alert("No data to download.");
                return;
            }
            
            const headers = ["ID", "Scheme", "Amount (â‚¹)", "Beneficiaries", "Date"];
            const csvRows = [headers.join(',')];

            tableRows.forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach(cell => {
                     const escaped = (''+cell.innerText).replace(/"/g, '\\"');
                    rowData.push(`"${escaped}"`);
                });
                csvRows.push(rowData.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `${state.replace(/\s+/g, '_')}_data.csv`);
            a.click();
        }

        // Download data as PDF
        function downloadPDF(state) {
            const tableRowsHtml = document.querySelectorAll('#data-table-body tr');
            if (tableRowsHtml.length === 0 || (tableRowsHtml.length === 1 && tableRowsHtml[0].cells.length === 1)) {
                alert("No data to generate PDF.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(18);
            doc.text(`Beneficiary Data for ${state}`, 14, 22);

            const tableColumn = ["ID", "Scheme", "Amount (â‚¹)", "Beneficiaries", "Date"];
            const tableRows = [];

            tableRowsHtml.forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach(cell => {
                    rowData.push(cell.innerText);
                });
                tableRows.push(rowData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 30,
            });

            doc.save(`${state.replace(/\s+/g, '_')}_data.pdf`);
        }


        // --- 4. INITIALIZATION ---
        
        // Populate dropdown
        const stateSelect = document.getElementById('state-select');
        states.forEach(state => {
            const option = document.createElement('option');
            option.value = state;
            option.textContent = state;
            stateSelect.appendChild(option);
        });

        // Event Listeners
        stateSelect.addEventListener('change', (e) => updateDashboard(e.target.value));
        document.getElementById('download-csv-btn').addEventListener('click', () => downloadCSV(stateSelect.value));
        document.getElementById('download-pdf-btn').addEventListener('click', () => downloadPDF(stateSelect.value));

        const setTheme = (isDark) => { 
            document.documentElement.classList.toggle('dark', isDark); 
            localStorage.setItem('theme', isDark ? 'dark' : 'light'); 
            document.getElementById('theme-toggle-light-icon').classList.toggle('hidden', isDark); 
            document.getElementById('theme-toggle-dark-icon').classList.toggle('hidden', !isDark); 
        };
        document.getElementById('theme-toggle').addEventListener('click', () => setTheme(!document.documentElement.classList.contains('dark')));
        
        // Initial Load
        generateStateData();
        setTheme(localStorage.getItem('theme') === 'dark');
        updateDashboard(states[0]); // Load the first state by default
        lucide.createIcons();
    });
    </script>
</body>
</html>

