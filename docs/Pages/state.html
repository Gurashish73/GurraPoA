<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Dashboard | State Authority</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configure Tailwind to use the 'dark' class for dark mode
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar {
            background-color: #ffffff;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
        }
        /* Dark mode specific card styles */
        .dark .card {
            background-color: #1c1b1a;
            border: 1px solid #374151; /* gray-700 */
            box-shadow: none;
        }
        .dark .card:hover {
            background-color: #2c2b2a;
        }
        /* Sankey-like visualization styles */
        .fund-flow-stage {
            text-align: center;
            flex: 1;
        }
        .fund-flow-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            color: #9ca3af; /* gray-400 */
        }
        .dark .fund-flow-arrow {
            color: #6b7280; /* gray-500 */
        }
        /* Modal styles */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        /* Flatpickr dark theme */
        .flatpickr-calendar.dark {
            background: #1f2937;
            border-color: #374151;
        }
        .flatpickr-calendar.dark .flatpickr-month {
            color: #d1d5db;
        }
        .flatpickr-calendar.dark .flatpickr-weekday {
            color: #9ca3af;
        }
        .flatpickr-calendar.dark .flatpickr-day {
            color: #d1d5db;
        }
        .flatpickr-calendar.dark .flatpickr-day:hover, .flatpickr-calendar.dark .flatpickr-day:focus {
            background: #374151;
        }
        .flatpickr-calendar.dark .flatpickr-day.selected {
            background: #4f46e5;
            border-color: #4f46e5;
        }
        .flatpickr-calendar.dark .numInput {
            background: #111827;
            color: #d1d5db;
        }
        .sort-icon {
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        th.sorted .sort-icon {
            opacity: 1;
        }
    </style>
</head>
<body class="flex min-h-screen bg-[#fdfaf6] dark:bg-black">
    <aside class="sidebar w-64 flex-shrink-0 border-r border-slate-200 dark:border-gray-700 flex flex-col dark:bg-[#1c1b1a]">
        <div class="p-6">
            <h1 class="text-2xl font-bold text-slate-800 dark:text-gray-100 flex items-center">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-7 w-7 mr-2 text-indigo-600"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path><path d="M12 3v2"></path><path d="M12 19v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M3 12h2"></path><path d="M19 12h2"></path><path d="m4.93 19.07 1.41-1.41"></path><path d="m17.66 6.34 1.41-1.41"></path></svg>
                 CSS Governance
            </h1>
        </div>
        <nav class="flex-1 px-4 py-2">
            <a href="state.html" class="flex items-center px-4 py-2.5 text-slate-700 bg-indigo-50 dark:bg-white dark:text-slate-900 rounded-lg font-semibold">
                <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3 text-indigo-600 dark:text-indigo-600"></i>
                Dashboard
            </a>
            <a href="financials.html" class="flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium">
                <i data-lucide="landmark" class="w-5 h-5 mr-3"></i>
                Financials
            </a>
            <a href="performance.html" class="flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium">
                <i data-lucide="bar-chart-3" class="w-5 h-5 mr-3"></i>
                Performance
            </a>
            <a href="compliance.html" class="flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium">
                <i data-lucide="shield-check" class="w-5 h-5 mr-3"></i>
                Compliance
            </a>
             <a href="reports.html" class="flex items-center px-4 py-2.5 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-1 font-medium">
                <i data-lucide="file-spreadsheet" class="w-5 h-5 mr-3"></i>
                Reports
            </a>
        </nav>
        <div class="p-4 mt-auto">
            <a href="#" class="flex items-center px-4 py-4 text-slate-600 dark:text-gray-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-lg mt-4 font-medium">
                <i data-lucide="log-out" class="w-5 h-5 mr-3"></i>
                Sign Out
            </a>
        </div>
    </aside>

    <main class="flex-1 p-6 lg:p-8">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
            <div>
                <h2 class="text-3xl font-bold text-slate-800 dark:text-gray-100">Strategic Dashboard (State Level)</h2>
                <p class="text-slate-500 dark:text-gray-400 mt-1">Oversight for Social Welfare Secretary, DBT Cell & Finance Dept.</p>
            </div>
            <div class="flex items-center mt-4 sm:mt-0">
                <div class="flex items-center space-x-4">
                    <button class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700">
                        <i data-lucide="bell" class="w-5 h-5 text-slate-600 dark:text-gray-400"></i>
                    </button>
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700">
                        <i data-lucide="sun" id="theme-toggle-light-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400"></i>
                        <i data-lucide="moon" id="theme-toggle-dark-icon" class="w-5 h-5 text-slate-600 dark:text-gray-400 hidden"></i>
                    </button>
                </div>
                <div class="flex items-center ml-6">
                    <img src="https://placehold.co/40x40/E2E8F0/475569?text=PS" alt="User" class="w-10 h-10 rounded-full">
                    <div class="ml-3">
                        <p class="font-semibold text-slate-800 dark:text-gray-100">Ms. Priya Singh</p>
                        <p class="text-sm text-slate-500 dark:text-gray-400">Secretary, Social Welfare</p>
                    </div>
                </div>
            </div>
        </div>

        <h3 class="text-xl font-semibold text-slate-800 dark:text-gray-100 mb-4">A. Financial Oversight & Budget Management</h3>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="card lg:col-span-3 p-5">
                <h4 class="font-semibold text-slate-800 dark:text-gray-100 mb-4">1. Budget Utilization Drill-Down (SNA View)</h4>
                <div class="flex items-stretch justify-between">
                    <div class="fund-flow-stage">
                        <div class="p-2 bg-blue-100 dark:bg-blue-500/10 rounded-full w-12 h-12 mx-auto flex items-center justify-center">
                           <i data-lucide="arrow-down-to-line" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <p class="font-semibold text-slate-700 dark:text-gray-200 mt-2">Central Release</p>
                        <p class="text-xl font-bold text-slate-900 dark:text-white">₹100 Cr</p>
                    </div>
                    <div class="fund-flow-arrow"><i data-lucide="chevron-right" class="w-8 h-8"></i></div>
                    <div class="fund-flow-stage">
                         <div class="p-2 bg-indigo-100 dark:bg-indigo-500/10 rounded-full w-12 h-12 mx-auto flex items-center justify-center">
                             <i data-lucide="landmark" class="w-6 h-6 text-indigo-600 dark:text-indigo-400"></i>
                         </div>
                        <p class="font-semibold text-slate-700 dark:text-gray-200 mt-2">State Scheme A/C</p>
                        <p class="text-xl font-bold text-slate-900 dark:text-white">₹100 Cr</p>
                    </div>
                    <div class="fund-flow-arrow"><i data-lucide="chevron-right" class="w-8 h-8"></i></div>
                    <div class="fund-flow-stage">
                         <div class="p-2 bg-yellow-100 dark:bg-yellow-500/10 rounded-full w-12 h-12 mx-auto flex items-center justify-center">
                             <i data-lucide="archive" class="w-6 h-6 text-yellow-600 dark:text-yellow-400"></i>
                         </div>
                        <p class="font-semibold text-slate-700 dark:text-gray-200 mt-2">Funds Parked</p>
                        <p class="text-xl font-bold text-red-600 dark:text-red-500">₹2 Cr</p>
                    </div>
                    <div class="fund-flow-arrow"><i data-lucide="chevron-right" class="w-8 h-8"></i></div>
                    <div class="fund-flow-stage">
                         <div class="p-2 bg-green-100 dark:bg-green-500/10 rounded-full w-12 h-12 mx-auto flex items-center justify-center">
                             <i data-lucide="send" class="w-6 h-6 text-green-600 dark:text-green-400"></i>
                         </div>
                        <p class="font-semibold text-slate-700 dark:text-gray-200 mt-2">PFMS Payout</p>
                        <p class="text-xl font-bold text-green-600 dark:text-green-500">₹98 Cr</p>
                    </div>
                </div>
            </div>

            <div class="card lg:col-span-2 p-5">
                 <h4 class="font-semibold text-slate-800 dark:text-gray-100 mb-4">2. Scheme Component Allocation</h4>
                 <div style="height: 220px;">
                     <canvas id="componentAllocationChart"></canvas>
                 </div>
            </div>

            <div class="card p-5">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-semibold text-slate-800 dark:text-gray-100">3. PFMS Reconciliation</h4>
                    <button id="export-btn" class="flex items-center text-xs font-medium text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300">
                        Export <i data-lucide="file-spreadsheet" class="w-4 h-4 ml-1"></i>
                    </button>
                </div>
                <div id="pfms-progress-bars" class="space-y-4"></div>
                <button id="view-details-btn" class="mt-4 w-full text-center text-sm font-semibold text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300 py-2 bg-indigo-50 dark:bg-indigo-500/10 rounded-lg">
                    View Details
                </button>
            </div>
        </div>
        
        <h3 class="text-xl font-semibold text-slate-800 dark:text-gray-100 mb-4">B. Comparative Performance & Accountability</h3>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="card lg:col-span-2 p-5 flex flex-col">
                 <div class="flex justify-between items-center mb-4">
                    <h4 class="font-semibold text-slate-800 dark:text-gray-100">4. District Performance Scorecard</h4>
                    <button id="district-export-btn" class="flex items-center text-xs font-medium text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300">
                        Export <i data-lucide="file-spreadsheet" class="w-4 h-4 ml-1"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <input type="search" id="district-search" placeholder="Search districts..." class="block w-full text-sm border-slate-300 rounded-md dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="overflow-x-auto flex-grow">
                    <table class="w-full text-left text-sm">
                        <thead class="text-xs text-slate-500 dark:text-gray-400 uppercase bg-slate-50 dark:bg-gray-800">
                            <tr>
                                <th class="px-4 py-2 cursor-pointer" data-sort-district="rank">Rank <i data-lucide="chevrons-up-down" class="inline w-3 h-3 ml-1 sort-icon"></i></th>
                                <th class="px-4 py-2 cursor-pointer" data-sort-district="name">District <i data-lucide="chevrons-up-down" class="inline w-3 h-3 ml-1 sort-icon"></i></th>
                                <th class="px-4 py-2 cursor-pointer" data-sort-district="dsi">DSI (%) <i data-lucide="chevrons-up-down" class="inline w-3 h-3 ml-1 sort-icon"></i></th>
                                <th class="px-4 py-2 cursor-pointer" data-sort-district="grievanceRate">Grievance Rate (%) <i data-lucide="chevrons-up-down" class="inline w-3 h-3 ml-1 sort-icon"></i></th>
                            </tr>
                        </thead>
                        <tbody id="district-table-body">
                           </tbody>
                    </table>
                </div>
                <div id="district-pagination" class="flex justify-between items-center mt-4 text-sm text-slate-600 dark:text-gray-400">
                    </div>
            </div>

            <div class="flex flex-col gap-6">
                <div class="card p-5">
                    <h4 class="font-semibold text-slate-800 dark:text-gray-100 mb-2">5. Time-to-Disbursement</h4>
                     <p class="text-3xl font-bold text-red-600 dark:text-red-500">8.2 Days <span class="text-sm">(Avg)</span></p>
                     <p class="text-sm text-slate-500 dark:text-gray-400 mt-1">Statutory Deadline: <span class="font-semibold">7 Days</span></p>
                     <div class="mt-2 text-xs font-medium text-red-600 flex items-center"><i data-lucide="alert-triangle" class="w-4 h-4 mr-1"></i>Violation Flagged</div>
                </div>
                <div class="card p-5">
                     <h4 class="font-semibold text-slate-800 dark:text-gray-100 mb-2">6. Grievance Trend</h4>
                     <div style="height: 120px;">
                         <canvas id="grievanceChart"></canvas>
                     </div>
                </div>
            </div>

        </div>

        <h3 class="text-xl font-semibold text-slate-800 dark:text-gray-100 mb-4">C. Policy Review & Compliance</h3>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="card p-5">
                <h4 class="font-semibold text-slate-800 dark:text-gray-100">7. Policy Analysis Tool</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 my-4">
                    <select id="policy-filter-atrocity" class="w-full text-sm border-slate-300 rounded-md dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="all">All Atrocity Types</option>
                        <option>Section 3(1)(a)</option>
                        <option>Section 3(1)(b)</option>
                        <option>Section 3(1)(r)</option>
                    </select>
                    <select id="policy-filter-demographics" class="w-full text-sm border-slate-300 rounded-md dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="all">All Demographics</option>
                        <option value="F_18_30">Female, 18-30</option>
                        <option value="M_60_plus">Male, 60+</option>
                        <option value="F_under_18">Female, Minor</option>
                    </select>
                    <select id="policy-filter-case-status" class="w-full text-sm border-slate-300 rounded-md dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="all">All Case Statuses</option>
                        <option>Conviction</option>
                        <option>Acquittal</option>
                        <option>Pending</option>
                    </select>
                </div>
                <div id="policy-results-container" class="mt-4 pt-4 border-t border-slate-200 dark:border-gray-700">
                    </div>
            </div>
             <div class="flex flex-col gap-6">
                <div class="card p-5">
                    <h4 class="font-semibold text-slate-800 dark:text-gray-100 mb-4">8. V&MC (Vigilance & Monitoring Committee) Tracking</h4>
                    <input type="file" id="vmc-file-input" class="hidden" accept=".pdf,.doc,.docx">
                    <table class="w-full text-left text-sm">
                        <thead class="text-xs text-slate-500 dark:text-gray-400 uppercase bg-slate-50 dark:bg-gray-800">
                            <tr>
                                <th class="px-4 py-2">Committee</th>
                                <th class="px-4 py-2">Next Due</th>
                                <th class="px-4 py-2">Status</th>
                                <th class="px-4 py-2">Minutes</th>
                            </tr>
                        </thead>
                        <tbody id="vmc-table-body">
                            </tbody>
                    </table>
                </div>

                <div class="card p-5">
                    <h4 class="font-semibold text-slate-800 dark:text-gray-100 mb-4">9. Inter-Agency API Health Check</h4>
                    <div class="space-y-5">
                        <div class="flex items-center">
                            <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-300 font-bold text-sm">CCTNS</span>
                            <div class="flex-1 ml-4">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="font-medium text-slate-800 dark:text-gray-100">Success Rate: 99.8%</span>
                                    <span class="text-slate-500 dark:text-gray-400">21ms Avg.</span>
                                </div>
                                <div class="w-full bg-slate-200 dark:bg-gray-700 rounded-full h-1.5 mt-1"><div class="bg-green-500 h-1.5 rounded-full" style="width: 99.8%;"></div></div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-orange-100 dark:bg-orange-900/50 text-orange-600 dark:text-orange-300 font-bold text-sm">e-Courts</span>
                            <div class="flex-1 ml-4">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="font-medium text-slate-800 dark:text-gray-100">Success Rate: 92.1%</span>
                                    <span class="text-slate-500 dark:text-gray-400">152ms Avg.</span>
                                </div>
                                <div class="w-full bg-slate-200 dark:bg-gray-700 rounded-full h-1.5 mt-1"><div class="bg-yellow-500 h-1.5 rounded-full" style="width: 92.1%;"></div></div>
                            </div>
                        </div>
                         <div class="flex items-center">
                            <span class="flex items-center justify-center w-10 h-10 rounded-lg bg-indigo-100 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-300 font-bold text-sm">PFMS</span>
                            <div class="flex-1 ml-4">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="font-medium text-slate-800 dark:text-gray-100">Success Rate: 99.9%</span>
                                    <span class="text-slate-500 dark:text-gray-400">35ms Avg.</span>
                                </div>
                                <div class="w-full bg-slate-200 dark:bg-gray-700 rounded-full h-1.5 mt-1"><div class="bg-green-500 h-1.5 rounded-full" style="width: 99.9%;"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </main>
    
    <div id="modal-container">
        <div id="export-modal" class="fixed inset-0 z-50 hidden items-center justify-center">
            <div class="modal-backdrop absolute inset-0 bg-black/50" data-close-modal="export-modal"></div>
            <div class="modal-content relative w-full max-w-md p-6 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
                <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200" data-close-modal="export-modal">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <h3 class="text-lg font-semibold text-slate-800 dark:text-gray-100">Export Reconciliation Data</h3>
                <div class="mt-4 space-y-4">
                    <div>
                        <label for="date-range" class="block text-sm font-medium text-slate-700 dark:text-gray-300">Date Range</label>
                        <input type="text" id="date-range" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                    </div>
                    <div>
                        <label for="file-type" class="block text-sm font-medium text-slate-700 dark:text-gray-300">File Type</label>
                        <select id="file-type" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                            <option value="csv">CSV (.csv)</option>
                            <option value="pdf">PDF (.pdf)</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-gray-300 bg-slate-100 dark:bg-gray-700 hover:bg-slate-200 dark:hover:bg-gray-600 rounded-md" data-close-modal="export-modal">Cancel</button>
                    <button id="download-report-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-md">Download</button>
                </div>
            </div>
        </div>

        <div id="details-modal" class="fixed inset-0 z-50 hidden items-center justify-center">
            <div class="modal-backdrop absolute inset-0 bg-black/50" data-close-modal="details-modal"></div>
            <div class="modal-content relative w-full max-w-4xl p-6 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
                 <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200" data-close-modal="details-modal">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <h3 class="text-lg font-semibold text-slate-800 dark:text-gray-100">PFMS Failure Details</h3>
                <div class="my-4 flex items-center gap-4">
                    <select id="filter-reason" class="block w-full max-w-xs rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                        <option value="all">All Failure Reasons</option>
                        <option value="Invalid Aadhaar">Invalid Aadhaar</option>
                        <option value="Dormant Account">Dormant Account</option>
                        <option value="Name Mismatch">Name Mismatch</option>
                    </select>
                </div>
                <div class="overflow-y-auto max-h-[60vh]">
                     <table class="w-full text-left text-sm">
                        <thead class="sticky top-0 bg-slate-50 dark:bg-gray-900">
                            <tr>
                                <th class="px-4 py-2 text-xs text-slate-500 dark:text-gray-400 uppercase cursor-pointer" data-sort="date">Date <i data-lucide="chevrons-up-down" class="inline w-3 h-3 ml-1"></i></th>
                                <th class="px-4 py-2 text-xs text-slate-500 dark:text-gray-400 uppercase">Transaction ID</th>
                                <th class="px-4 py-2 text-xs text-slate-500 dark:text-gray-400 uppercase">Beneficiary Name</th>
                                <th class="px-4 py-2 text-xs text-slate-500 dark:text-gray-400 uppercase cursor-pointer" data-sort="amount">Amount <i data-lucide="chevrons-up-down" class="inline w-3 h-3 ml-1"></i></th>
                                <th class="px-4 py-2 text-xs text-slate-500 dark:text-gray-400 uppercase">Failure Reason</th>
                            </tr>
                        </thead>
                        <tbody id="failures-table-body" class="divide-y divide-slate-200 dark:divide-gray-700"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="district-export-modal" class="fixed inset-0 z-50 hidden items-center justify-center">
            <div class="modal-backdrop absolute inset-0 bg-black/50" data-close-modal="district-export-modal"></div>
            <div class="modal-content relative w-full max-w-md p-6 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
                <button class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200" data-close-modal="district-export-modal">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <h3 class="text-lg font-semibold text-slate-800 dark:text-gray-100">Export District Scorecard</h3>
                <p class="text-sm text-slate-500 dark:text-gray-400 mt-1">This will export the currently filtered and sorted data.</p>
                <div class="mt-4">
                    <label for="district-file-type" class="block text-sm font-medium text-slate-700 dark:text-gray-300">File Type</label>
                    <select id="district-file-type" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                        <option value="csv">CSV (.csv)</option>
                        <option value="pdf">PDF (.pdf)</option>
                    </select>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button class="px-4 py-2 text-sm font-medium text-slate-600 dark:text-gray-300 bg-slate-100 dark:bg-gray-700 hover:bg-slate-200 dark:hover:bg-gray-600 rounded-md" data-close-modal="district-export-modal">Cancel</button>
                    <button id="download-district-report-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-md">Download</button>
                </div>
            </div>
        </div>

    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- ELEMENTS & STATE ---
            const themeToggleBtn = document.getElementById('theme-toggle');
            const lightIcon = document.getElementById('theme-toggle-light-icon');
            const darkIcon = document.getElementById('theme-toggle-dark-icon');
            let charts = {};
            let flatpickrInstance;
            const today = new Date('2025-10-13'); // Fixed date for consistent simulation

            // --- MOCK DATA ---
            const mockFailures = [
                { date: '2025-10-01', tid: 'T834JDI34', name: 'Ramesh Kumar', amount: 5000, reason: 'Invalid Aadhaar' },
                { date: '2025-10-02', tid: 'T987WERG2', name: 'Sita Devi', amount: 2500, reason: 'Dormant Account' },
                { date: '2025-09-15', tid: 'T234SDFG5', name: 'Arjun Singh', amount: 5000, reason: 'Invalid Aadhaar' },
                { date: '2025-09-28', tid: 'T567GHJK1', name: 'Priya Sharma', amount: 7500, reason: 'Name Mismatch' },
                { date: '2025-10-05', tid: 'T123ASDF4', name: 'Mohan Lal', amount: 5000, reason: 'Invalid Aadhaar' },
                { date: '2025-08-22', tid: 'T456ZXCV7', name: 'Geeta Kumari', amount: 2500, reason: 'Dormant Account' },
            ];
            
            const mockDistricts = [
                { name: 'North District', dsi: 98.5, grievanceRate: 99.2 }, { name: 'West District', dsi: 97.1, grievanceRate: 98.0 },
                { name: 'Capital District', dsi: 96.8, grievanceRate: 97.5 }, { name: 'River District', dsi: 95.2, grievanceRate: 96.1 },
                { name: 'Coastal District', dsi: 94.9, grievanceRate: 95.3 }, { name: 'Central District', dsi: 93.1, grievanceRate: 94.0 },
                { name: 'Mountain District', dsi: 92.5, grievanceRate: 93.8 }, { name: 'Valley District', dsi: 91.0, grievanceRate: 92.2 },
                { name: 'South District', dsi: 85.4, grievanceRate: 88.1 }, { name: 'Border District', dsi: 82.0, grievanceRate: 85.5 },
                { name: 'East District', dsi: 72.3, grievanceRate: 75.5 }, { name: 'Plains District', dsi: 70.1, grievanceRate: 73.0 },
            ].map((d, i) => ({ ...d, rank: i + 1, id: i }));

            const mockPolicyData = [
                // Existing 10 cases
                { id: 1, date: '2025-09-20', district: 'Capital District', atrocityType: 'Section 3(1)(a)', caseStatus: 'Conviction', demographics: { gender: 'Female', age: 25 }, relief: 100000 },
                { id: 2, date: '2025-09-18', district: 'South District', atrocityType: 'Section 3(1)(r)', caseStatus: 'Acquittal', demographics: { gender: 'Male', age: 62 }, relief: 50000 },
                { id: 3, date: '2025-09-15', district: 'North District', atrocityType: 'Section 3(1)(b)', caseStatus: 'Pending', demographics: { gender: 'Female', age: 17 }, relief: 75000 },
                { id: 4, date: '2025-08-30', district: 'Capital District', atrocityType: 'Section 3(1)(r)', caseStatus: 'Conviction', demographics: { gender: 'Male', age: 45 }, relief: 50000 },
                { id: 5, date: '2025-08-25', district: 'West District', atrocityType: 'Section 3(1)(a)', caseStatus: 'Pending', demographics: { gender: 'Female', age: 29 }, relief: 100000 },
                { id: 6, date: '2025-08-10', district: 'South District', atrocityType: 'Section 3(1)(b)', caseStatus: 'Conviction', demographics: { gender: 'Male', age: 68 }, relief: 75000 },
                { id: 7, date: '2025-07-22', district: 'East District', atrocityType: 'Section 3(1)(r)', caseStatus: 'Acquittal', demographics: { gender: 'Female', age: 19 }, relief: 50000 },
                { id: 8, date: '2025-07-19', district: 'Capital District', atrocityType: 'Section 3(1)(a)', caseStatus: 'Pending', demographics: { gender: 'Female', age: 16 }, relief: 100000 },
                { id: 9, date: '2025-06-05', district: 'North District', atrocityType: 'Section 3(1)(b)', caseStatus: 'Conviction', demographics: { gender: 'Male', age: 71 }, relief: 75000 },
                { id: 10, date: '2025-05-12', district: 'West District', atrocityType: 'Section 3(1)(r)', caseStatus: 'Pending', demographics: { gender: 'Female', age: 22 }, relief: 50000 },
                // Newly added 30 cases
                { id: 11, date: '2025-04-11', district: 'Coastal District', atrocityType: 'Section 3(1)(a)', caseStatus: 'Conviction', demographics: { gender: 'Male', age: 33 }, relief: 100000 },
                { id: 12, date: '2025-03-25', district: 'Mountain District', atrocityType: 'Section 3(1)(b)', caseStatus: 'Pending', demographics: { gender: 'Female', age: 41 }, relief: 75000 },
                { id: 13, date: '2025-02-01', district: 'Valley District', atrocityType: 'Section 3(1)(r)', caseStatus: 'Acquittal', demographics: { gender: 'Male', age: 55 }, relief: 50000 },
                { id: 14, date: '2025-01-15', district: 'Border District', atrocityType: 'Section 3(1)(a)', caseStatus: 'Conviction', demographics: { gender: 'Female', age: 28 }, relief: 100000 },
                { id: 15, date: '2024-12-10', district: 'Plains District', atrocityType: 'Section 3(1)(b)', caseStatus: 'Acquittal', demographics: { gender: 'Male', age: 65 }, relief: 75000 },
                { id: 16, date: '2024-11-20', district: 'Central District', atrocityType: 'Section 3(1)(r)', caseStatus: 'Pending', demographics: { gender: 'Female', age: 17 }, relief: 50000 },
                { id: 17, date: '2024-10-05', district: 'Capital District', atrocityType: 'Section 3(1)(a)', caseStatus: 'Pending', demographics: { gender: 'Male', age: 22 }, relief: 100000 },
                { id: 18, date: '2024-09-18', district: 'North District', atrocityType: 'Section 3(1)(b)', caseStatus: 'Conviction', demographics: { gender: 'Female', age: 61 }, relief: 75000 },
                { id: 19, date: '2024-08-22', district: 'South District', atrocityType: 'Section 3(1)(r)', caseStatus: 'Acquittal', demographics: { gender: 'Male', age: 19 }, relief: 50000 },
                { id: 20, date: '2024-07-30', district: 'West District', atrocityType: 'Section 3(1)(a)', caseStatus: 'Conviction', demographics: { gender: 'Female', age: 35 }, relief: 100000 },
                { id: 21, date: '2025-04-18', district: 'East District', atrocityType: 'Section 3(1)(b)', caseStatus: 'Pending', demographics: { gender: 'Male', age: 72 }, relief: 75000 },
                { id: 22, date: '2025-03-12', district: 'River District', atrocityType: 'Section 3(1)(r)', caseStatus: 'Conviction', demographics: { gender: 'Female', age: 24 }, relief: 50000 },
                { id: 23, date: '2025-02-20', district: 'Coastal District', atrocityType: 'Section 3(1)(a)', caseStatus: 'Acquittal', demographics: { gender: 'Male', age: 48 }, relief: 100000 },
                { id: 24, date: '2025-01-08', district: 'Mountain District', atrocityType: 'Section 3(1)(b)', caseStatus: 'Pending', demographics: { gender: 'Female', age: 16 }, relief: 75000 },
                { id: 25, date: '2024-12-25', district: 'Valley District', atrocityType: 'Section 3(1)(r)', caseStatus: 'Conviction', demographics: { gender: 'Male', age: 29 }, relief: 50000 },
                { id: 26, date: '2024-11-14', district: 'Border District', atrocityType: 'Section 3(1)(a)', caseStatus: 'Acquittal', demographics: { gender: 'Female', age: 50 }, relief: 100000 },
                { id: 27, date: '2024-10-19', district: 'Plains District', atrocityType: 'Section 3(1)(b)', caseStatus: 'Pending', demographics: { gender: 'Male', age: 69 }, relief: 75000 },
                { id: 28, date: '2024-09-01', district: 'Central District', atrocityType: 'Section 3(1)(r)', caseStatus: 'Conviction', demographics: { gender: 'Female', age: 21 }, relief: 50000 },
                { id: 29, date: '2024-08-11', district: 'Capital District', atrocityType: 'Section 3(1)(a)', caseStatus: 'Pending', demographics: { gender: 'Male', age: 38 }, relief: 100000 },
                { id: 30, date: '2024-07-07', district: 'North District', atrocityType: 'Section 3(1)(b)', caseStatus: 'Acquittal', demographics: { gender: 'Female', age: 19 }, relief: 75000 },
                { id: 31, date: '2025-05-02', district: 'South District', atrocityType: 'Section 3(1)(r)', caseStatus: 'Conviction', demographics: { gender: 'Male', age: 75 }, relief: 50000 },
                { id: 32, date: '2025-04-21', district: 'West District', atrocityType: 'Section 3(1)(a)', caseStatus: 'Pending', demographics: { gender: 'Female', age: 26 }, relief: 100000 },
                { id: 33, date: '2025-03-14', district: 'East District', atrocityType: 'Section 3(1)(b)', caseStatus: 'Conviction', demographics: { gender: 'Male', age: 53 }, relief: 75000 },
                { id: 34, date: '2025-02-18', district: 'River District', atrocityType: 'Section 3(1)(r)', caseStatus: 'Acquittal', demographics: { gender: 'Female', age: 31 }, relief: 50000 },
                { id: 35, date: '2025-01-29', district: 'Coastal District', atrocityType: 'Section 3(1)(a)', caseStatus: 'Pending', demographics: { gender: 'Male', age: 20 }, relief: 100000 },
                { id: 36, date: '2024-12-01', district: 'Mountain District', atrocityType: 'Section 3(1)(b)', caseStatus: 'Conviction', demographics: { gender: 'Female', age: 45 }, relief: 75000 },
                { id: 37, date: '2024-11-08', district: 'Valley District', atrocityType: 'Section 3(1)(r)', caseStatus: 'Pending', demographics: { gender: 'Male', age: 60 }, relief: 50000 },
                { id: 38, date: '2024-10-15', district: 'Border District', atrocityType: 'Section 3(1)(a)', caseStatus: 'Acquittal', demographics: { gender: 'Female', age: 23 }, relief: 100000 },
                { id: 39, date: '2024-09-25', district: 'Plains District', atrocityType: 'Section 3(1)(b)', caseStatus: 'Conviction', demographics: { gender: 'Male', age: 34 }, relief: 75000 },
                { id: 40, date: '2024-08-05', district: 'Central District', atrocityType: 'Section 3(1)(r)', caseStatus: 'Pending', demographics: { gender: 'Female', age: 29 }, relief: 50000 },
            ];
            
            const mockVmcData = [
                { id: 1, name: 'State VMC (Bi-Annual)', nextDue: '2025-12-31', minutesUrl: '/files/state_vmc_minutes.pdf' },
                { id: 2, name: 'Capital District VMC (Quarterly)', nextDue: '2025-11-10', minutesUrl: null },
                { id: 3, name: 'South District VMC (Quarterly)', nextDue: '2025-09-30', minutesUrl: '/files/south_vmc_minutes.pdf' },
                { id: 4, name: 'North District VMC (Quarterly)', nextDue: '2025-12-15', minutesUrl: '/files/north_vmc_minutes.pdf' }
            ];

            // --- GENERIC HELPER FUNCTIONS ---
            function toggleModal(modalId, show) {
                const modal = document.getElementById(modalId);
                if (!modal) return;
                modal.classList.toggle('hidden', !show);
                modal.classList.toggle('flex', show);
            }

            function exportToCSV(headers, rows, filename) {
                let csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].map(e => e.join(",")).join("\n");
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function exportToPDF(title, head, body, filename) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text(title, 14, 16);
                doc.autoTable({ head, body, startY: 20 });
                doc.save(filename);
            }

            function formatDate(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
            }
            
            // --- THEME & CHART LOGIC ---
            const getChartOptions = (isDark) => {
                const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : '#e2e8f0';
                const textColor = isDark ? '#9ca3af' : '#64748b';
                return {
                    bar: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } },
                            x: { grid: { display: false }, ticks: { color: textColor } }
                        },
                        plugins: { legend: { labels: { color: textColor } } }
                    },
                    line: {
                         responsive: true, maintainAspectRatio: false,
                         scales: {
                            y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } },
                            x: { grid: { display: false }, ticks: { color: textColor } }
                         },
                         plugins: { legend: { display: false }, tooltip: { enabled: true } },
                         elements: { point: { radius: 0 }, line: { tension: 0.4 } }
                    }
                };
            };
            
            function createCharts(isDark) {
                const options = getChartOptions(isDark);
                if (charts.component) charts.component.destroy();
                const componentCtx = document.getElementById('componentAllocationChart').getContext('2d');
                charts.component = new Chart(componentCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Monetary Relief', 'Inter-Caste Marriages'],
                        datasets: [
                            { label: 'Released', data: [80, 20], backgroundColor: isDark ? '#4338ca' : '#6366f1', borderRadius: 4 },
                            { label: 'Disbursed', data: [78, 19.5], backgroundColor: isDark ? '#15803d' : '#22c55e', borderRadius: 4 }
                        ]
                    },
                    options: options.bar
                });
                
                if (charts.grievance) charts.grievance.destroy();
                const grievanceCtx = document.getElementById('grievanceChart').getContext('2d');
                charts.grievance = new Chart(grievanceCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul'],
                        datasets: [
                            { label: 'Incoming', data: [65, 59, 80, 81, 56, 55, 40], borderColor: '#ef4444', borderWidth: 2, fill: false },
                            { label: 'Resolved', data: [60, 55, 75, 78, 52, 53, 38], borderColor: '#22c55e', borderWidth: 2, fill: false }
                        ]
                    },
                    options: options.line
                });
            }

            const setTheme = (isDark) => {
                document.documentElement.classList.toggle('dark', isDark);
                lightIcon.classList.toggle('hidden', isDark);
                darkIcon.classList.toggle('hidden', !isDark);
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                createCharts(isDark);
                if (flatpickrInstance && flatpickrInstance.calendarContainer) {
                    flatpickrInstance.calendarContainer.classList.toggle('dark', isDark);
                }
            };

            // --- PFMS RECONCILIATION LOGIC ---
            const pfmsLogic = () => {
                const pfmsProgressContainer = document.getElementById('pfms-progress-bars');
                const colors = {
                    'Invalid Aadhaar': 'bg-red-500',
                    'Dormant Account': 'bg-yellow-500',
                    'Name Mismatch': 'bg-orange-500'
                };
                const failuresTableBody = document.getElementById('failures-table-body');
                let currentSort = { key: 'date', order: 'desc' };

                const getFailureCounts = () => {
                    const counts = { 'Invalid Aadhaar': 0, 'Dormant Account': 0, 'Name Mismatch': 0 };
                    mockFailures.forEach(f => {
                        if (counts[f.reason] !== undefined) counts[f.reason]++;
                    });
                    return counts;
                };

                const renderProgressBars = () => {
                    const counts = getFailureCounts();
                    const total = Object.values(counts).reduce((a, b) => a + b, 0);
                    pfmsProgressContainer.innerHTML = Object.entries(counts).map(([reason, count]) => {
                        const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
                        return `
                            <div>
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="text-slate-600 dark:text-gray-300">${reason}</span>
                                    <span class="font-medium text-slate-800 dark:text-gray-100">${count} failures</span>
                                </div>
                                <div class="w-full bg-slate-200 dark:bg-gray-700 rounded-full h-2">
                                    <div class="${colors[reason]} h-2 rounded-full" style="width: ${percentage}%;"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                };

                const renderFailuresTable = () => {
                    const filterValue = document.getElementById('filter-reason').value;
                    let data = [...mockFailures];
                    if (filterValue !== 'all') {
                        data = data.filter(f => f.reason === filterValue);
                    }
                    data.sort((a, b) => {
                        const valA = a[currentSort.key];
                        const valB = b[currentSort.key];
                        if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
                        if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
                        return 0;
                    });
                    failuresTableBody.innerHTML = data.map(f => `
                        <tr class="hover:bg-slate-50 dark:hover:bg-gray-700/50">
                            <td class="px-4 py-2 text-slate-700 dark:text-gray-300">${f.date}</td>
                            <td class="px-4 py-2 font-mono text-xs text-slate-500 dark:text-gray-400">${f.tid}</td>
                            <td class="px-4 py-2 font-medium text-slate-800 dark:text-gray-100">${f.name}</td>
                            <td class="px-4 py-2 text-slate-700 dark:text-gray-300">₹${f.amount.toLocaleString('en-IN')}</td>
                            <td class="px-4 py-2"><span class="text-xs font-medium px-2 py-0.5 rounded-full ${
                                f.reason === 'Invalid Aadhaar' ? 'bg-red-100 text-red-800 dark:bg-red-500/10 dark:text-red-400' :
                                f.reason === 'Dormant Account' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-500/10 dark:text-yellow-400' :
                                'bg-orange-100 text-orange-800 dark:bg-orange-500/10 dark:text-orange-400'
                            }">${f.reason}</span></td>
                        </tr>
                    `).join('');
                    lucide.createIcons();
                };
                
                renderProgressBars();

                document.getElementById('export-btn').addEventListener('click', () => {
                    toggleModal('export-modal', true);
                    if (!flatpickrInstance) {
                        flatpickrInstance = flatpickr("#date-range", {
                            mode: "range", dateFormat: "Y-m-d",
                            defaultDate: [new Date(new Date().setMonth(new Date().getMonth() - 1)), new Date()],
                            static: true, monthSelectorType: 'static',
                            onReady: (_, __, instance) => {
                                instance.calendarContainer.classList.toggle('dark', document.documentElement.classList.contains('dark'));
                            }
                        });
                    }
                });

                document.getElementById('download-report-btn').addEventListener('click', () => {
                    const fileType = document.getElementById('file-type').value;
                    const dates = flatpickrInstance.selectedDates;
                    if (dates.length < 2) {
                        alert("Please select a date range."); return;
                    }
                    const [start, end] = dates;
                    const filteredData = mockFailures.filter(f => {
                        const fDate = new Date(f.date);
                        return fDate >= start && fDate <= end;
                    });
                    if (fileType === 'csv') {
                        exportToCSV(['Date', 'Transaction ID', 'Beneficiary Name', 'Amount', 'Failure Reason'], filteredData.map(f => [f.date, f.tid, f.name, f.amount, f.reason]), "pfms_failures.csv");
                    } else {
                        exportToPDF("PFMS Reconciliation Failure Report", [['Date', 'Transaction ID', 'Beneficiary Name', 'Amount', 'Failure Reason']], filteredData.map(f => [f.date, f.tid, f.name, `Rs. ${f.amount}`, f.reason]), 'pfms_failures.pdf');
                    }
                    toggleModal('export-modal', false);
                });
                
                document.getElementById('view-details-btn').addEventListener('click', () => {
                    renderFailuresTable();
                    toggleModal('details-modal', true);
                });

                document.getElementById('filter-reason').addEventListener('change', renderFailuresTable);
                
                document.querySelectorAll('[data-sort]').forEach(header => {
                    header.addEventListener('click', () => {
                        const key = header.dataset.sort;
                        if (currentSort.key === key) {
                            currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
                        } else {
                            currentSort.key = key;
                            currentSort.order = 'desc';
                        }
                        renderFailuresTable();
                    });
                });
            };

            // --- DISTRICT SCORECARD LOGIC ---
            const districtScorecardLogic = () => {
                const tableBody = document.getElementById('district-table-body');
                const searchInput = document.getElementById('district-search');
                const paginationContainer = document.getElementById('district-pagination');

                let state = {
                    data: mockDistricts,
                    filteredData: [],
                    currentPage: 1,
                    rowsPerPage: 5,
                    sort: { key: 'rank', order: 'asc' },
                    filter: ''
                };

                const renderTable = () => {
                    state.filteredData = state.data.filter(d => 
                        d.name.toLowerCase().includes(state.filter.toLowerCase())
                    );
                    state.filteredData.sort((a, b) => {
                        const valA = a[state.sort.key];
                        const valB = b[state.sort.key];
                        const order = state.sort.order === 'asc' ? 1 : -1;
                        if (typeof valA === 'string') {
                            return valA.localeCompare(valB) * order;
                        }
                        if (valA < valB) return -1 * order;
                        if (valA > valB) return 1 * order;
                        return 0;
                    });
                    state.filteredData.forEach((d, i) => d.rank = i + 1);

                    const start = (state.currentPage - 1) * state.rowsPerPage;
                    const end = start + state.rowsPerPage;
                    const paginatedData = state.filteredData.slice(start, end);

                    tableBody.innerHTML = paginatedData.map(d => {
                        const getPerfColor = (val) => val > 95 ? 'text-green-600' : val > 85 ? 'text-yellow-600' : 'text-red-600';
                        return `
                            <tr class="border-b dark:border-gray-700 hover:bg-slate-50 dark:hover:bg-gray-700/50">
                                <td class="px-4 py-2 font-bold ${getPerfColor(d.dsi)}">${d.rank}</td>
                                <td class="px-4 py-2 font-medium text-slate-800 dark:text-gray-100">${d.name}</td>
                                <td class="px-4 py-2 ${getPerfColor(d.dsi)}">${d.dsi.toFixed(1)}%</td>
                                <td class="px-4 py-2 ${getPerfColor(d.grievanceRate)}">${d.grievanceRate.toFixed(1)}%</td>
                            </tr>
                        `;
                    }).join('');
                    
                    renderPagination(start, end);
                    lucide.createIcons();
                };

                const renderPagination = (start, end) => {
                    const totalPages = Math.ceil(state.filteredData.length / state.rowsPerPage);
                    if(totalPages <= 1) {
                       paginationContainer.innerHTML = '';
                       return;
                    }
                    let buttons = '';
                    for (let i = 1; i <= totalPages; i++) {
                        buttons += `<button data-page="${i}" class="px-3 py-1 rounded-md ${state.currentPage === i ? 'bg-indigo-600 text-white' : 'hover:bg-slate-200 dark:hover:bg-gray-700'}">${i}</button>`;
                    }
                    paginationContainer.innerHTML = `
                        <span class="text-xs">Showing ${start + 1} to ${Math.min(end, state.filteredData.length)} of ${state.filteredData.length} districts</span>
                        <div class="flex items-center gap-2">${buttons}</div>
                    `;
                };

                searchInput.addEventListener('input', (e) => {
                    state.filter = e.target.value;
                    state.currentPage = 1;
                    renderTable();
                });

                document.querySelectorAll('[data-sort-district]').forEach(header => {
                    header.addEventListener('click', () => {
                        const key = header.dataset.sortDistrict;
                        const order = state.sort.key === key && state.sort.order === 'asc' ? 'desc' : 'asc';
                        state.sort = { key, order };
                        
                        document.querySelectorAll('[data-sort-district]').forEach(h => h.classList.remove('sorted'));
                        header.classList.add('sorted');
                        renderTable();
                    });
                });
                
                paginationContainer.addEventListener('click', (e) => {
                    if (e.target.matches('[data-page]')) {
                        state.currentPage = parseInt(e.target.dataset.page);
                        renderTable();
                    }
                });
                
                document.getElementById('district-export-btn').addEventListener('click', () => toggleModal('district-export-modal', true));
                
                document.getElementById('download-district-report-btn').addEventListener('click', () => {
                    const fileType = document.getElementById('district-file-type').value;
                    const dataToExport = state.filteredData;
                    
                    if (fileType === 'csv') {
                        const headers = ['Rank', 'District', 'DSI (%)', 'Grievance Resolution Rate (%)'];
                        const rows = dataToExport.map(d => [d.rank, d.name, d.dsi, d.grievanceRate]);
                        exportToCSV(headers, rows, "district_performance.csv");
                    } else {
                        const headers = [['Rank', 'District', 'DSI (%)', 'Grievance Rate (%)']];
                        const body = dataToExport.map(d => [d.rank, d.name, `${d.dsi.toFixed(1)}%`, `${d.grievanceRate.toFixed(1)}%`]);
                        exportToPDF("District Performance Scorecard", headers, body, "district_performance.pdf");
                    }
                    toggleModal('district-export-modal', false);
                });

                renderTable();
            };

            // --- POLICY ANALYSIS LOGIC ---
            const policyAnalysisLogic = () => {
                const atrocityFilter = document.getElementById('policy-filter-atrocity');
                const demographicsFilter = document.getElementById('policy-filter-demographics');
                const caseStatusFilter = document.getElementById('policy-filter-case-status');
                const resultsContainer = document.getElementById('policy-results-container');

                const updatePolicyAnalysis = () => {
                    const atrocity = atrocityFilter.value;
                    const demographics = demographicsFilter.value;
                    const caseStatus = caseStatusFilter.value;

                    let filteredData = mockPolicyData.filter(item => {
                        let isMatch = true;
                        if (atrocity !== 'all' && item.atrocityType !== atrocity) isMatch = false;
                        if (caseStatus !== 'all' && item.caseStatus !== caseStatus) isMatch = false;
                        if (demographics !== 'all') {
                            const d = item.demographics;
                            if (demographics === 'F_18_30' && (d.gender !== 'Female' || d.age < 18 || d.age > 30)) isMatch = false;
                            if (demographics === 'M_60_plus' && (d.gender !== 'Male' || d.age < 60)) isMatch = false;
                            if (demographics === 'F_under_18' && (d.gender !== 'Female' || d.age >= 18)) isMatch = false;
                        }
                        return isMatch;
                    });
                    
                    renderPolicyResults(filteredData);
                };
                
                const renderPolicyResults = (data) => {
                    if (data.length === 0) {
                        resultsContainer.innerHTML = `<p class="text-center text-slate-500 dark:text-gray-400 py-4">No matching cases found for the selected filters.</p>`;
                        return;
                    }

                    const totalCases = data.length;
                    const totalRelief = data.reduce((sum, item) => sum + item.relief, 0);
                    const avgRelief = totalCases > 0 ? (totalRelief / totalCases) : 0;
                    
                    const statusColors = {
                        'Conviction': 'bg-green-100 text-green-800 dark:bg-green-500/10 dark:text-green-400',
                        'Acquittal': 'bg-red-100 text-red-800 dark:bg-red-500/10 dark:text-red-400',
                        'Pending': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-500/10 dark:text-yellow-400',
                    };
                    
                    resultsContainer.innerHTML = `
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4 text-center">
                            <div>
                                <p class="text-sm text-slate-500 dark:text-gray-400">Matching Cases</p>
                                <p class="text-2xl font-bold text-slate-800 dark:text-white">${totalCases}</p>
                            </div>
                            <div>
                                <p class="text-sm text-slate-500 dark:text-gray-400">Total Relief</p>
                                <p class="text-2xl font-bold text-slate-800 dark:text-white">₹${(totalRelief/100000).toFixed(2)} L</p>
                            </div>
                            <div class="col-span-2 md:col-span-1">
                                <p class="text-sm text-slate-500 dark:text-gray-400">Avg. Relief / Case</p>
                                <p class="text-2xl font-bold text-slate-800 dark:text-white">₹${avgRelief.toLocaleString('en-IN')}</p>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm mt-2">
                                <thead class="text-xs text-slate-500 dark:text-gray-400 uppercase bg-slate-50 dark:bg-gray-800">
                                    <tr>
                                        <th class="px-4 py-2">Date</th>
                                        <th class="px-4 py-2">District</th>
                                        <th class="px-4 py-2">Atrocity Type</th>
                                        <th class="px-4 py-2">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-200 dark:divide-gray-700">
                                    ${data.slice(0, 5).map(item => `
                                        <tr class="hover:bg-slate-50 dark:hover:bg-gray-700/50">
                                            <td class="px-4 py-2 text-slate-700 dark:text-gray-300">${item.date}</td>
                                            <td class="px-4 py-2 font-medium text-slate-800 dark:text-gray-100">${item.district}</td>
                                            <td class="px-4 py-2 text-slate-700 dark:text-gray-300">${item.atrocityType}</td>
                                            <td class="px-4 py-2"><span class="text-xs font-medium px-2 py-0.5 rounded-full ${statusColors[item.caseStatus]}">${item.caseStatus}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                             ${data.length > 5 ? `<p class="text-center text-xs text-slate-500 mt-2">Showing first 5 of ${data.length} results.</p>` : ''}
                        </div>
                    `;
                };

                [atrocityFilter, demographicsFilter, caseStatusFilter].forEach(el => {
                    el.addEventListener('change', updatePolicyAnalysis);
                });
                
                updatePolicyAnalysis();
            };

            // --- VMC TRACKING LOGIC ---
            const vmcLogic = () => {
                const tableBody = document.getElementById('vmc-table-body');
                const fileInput = document.getElementById('vmc-file-input');

                const renderVmcTable = () => {
                    tableBody.innerHTML = mockVmcData.map(item => {
                        const dueDate = new Date(item.nextDue);
                        const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                        
                        let status, statusColor;
                        if (diffDays < 0) {
                            status = 'Delayed';
                            statusColor = 'bg-red-100 text-red-800 dark:bg-red-500/10 dark:text-red-400';
                        } else if (diffDays <= 30) {
                            status = 'Due Soon';
                            statusColor = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-500/10 dark:text-yellow-400';
                        } else {
                            status = 'Compliant';
                            statusColor = 'bg-green-100 text-green-800 dark:bg-green-500/10 dark:text-green-400';
                        }
                        
                        const minutesAction = item.minutesUrl
                            ? `<a href="${item.minutesUrl}" target="_blank" class="text-indigo-600 dark:text-indigo-400 hover:underline">View</a>`
                            : `<button data-upload-id="${item.id}" class="text-indigo-600 dark:text-indigo-400 hover:underline">Upload</button>`;
                        
                        return `
                            <tr class="border-b dark:border-gray-700">
                                <td class="px-4 py-2 font-medium text-slate-800 dark:text-gray-100">${item.name}</td>
                                <td class="px-4 py-2 text-slate-700 dark:text-gray-300">${formatDate(item.nextDue)}</td>
                                <td class="px-4 py-2"><span class="text-xs font-medium px-2 py-0.5 rounded-full ${statusColor}">${status}</span></td>
                                <td class="px-4 py-2">${minutesAction}</td>
                            </tr>
                        `;
                    }).join('');
                };

                tableBody.addEventListener('click', (e) => {
                    if (e.target.matches('[data-upload-id]')) {
                        const vmcId = parseInt(e.target.dataset.uploadId);
                        fileInput.dataset.vmcId = vmcId;
                        fileInput.click();
                    }
                });

                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        const vmcId = parseInt(e.target.dataset.vmcId);
                        const file = e.target.files[0];

                        const itemToUpdate = mockVmcData.find(item => item.id === vmcId);
                        if (itemToUpdate) {
                            itemToUpdate.minutesUrl = URL.createObjectURL(file);
                            alert(`Simulated upload of "${file.name}" for "${itemToUpdate.name}".`);
                            renderVmcTable();
                        }
                        
                        e.target.value = ''; 
                        delete fileInput.dataset.vmcId;
                    }
                });
                
                renderVmcTable();
            };

            // --- PAGE INITIALIZATION ---
            const initializePage = () => {
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const isDarkMode = savedTheme === 'dark' || (savedTheme === null && prefersDark);
                
                setTheme(isDarkMode);
                
                pfmsLogic();
                districtScorecardLogic();
                policyAnalysisLogic();
                vmcLogic();

                document.querySelectorAll('[data-close-modal], .modal-backdrop').forEach(el => {
                    const modalId = el.dataset.closeModal;
                    el.addEventListener('click', (e) => {
                        if (e.target === e.currentTarget) {
                            toggleModal(modalId, false);
                        }
                    });
                });

                themeToggleBtn.addEventListener('click', () => setTheme(!document.documentElement.classList.contains('dark')));
            };
            
            initializePage();
        });
    </script>
</body>
</html>